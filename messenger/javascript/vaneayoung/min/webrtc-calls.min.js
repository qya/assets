function vy_webrtc_calls(){if(void 0===e)var e=function(e){return $(e)};$.fn.extend({center:function(){return this.each(function(){var e=($(window).height()-$(this).outerHeight())/2,t=($(window).width()-$(this).outerWidth())/2;$(this).css({position:"absolute",margin:0,top:(e>0?e:0)+"px",left:(t>0?t:0)+"px"})})}});var t=this;t.peer_uniq_id=Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15),t.ajax_url=V_HOST+"/messenger.php",t.curr_peer_id,t.last_peer_id=0,t.reconnectPeerTimeout,t.reconnectPeerTimesCount=20,t.peerJS_reconnect_times=0,t.peer,t.call,t.localStream,t.socket=sio,t.recipientid,t.media_type,t.body=e("body"),t.close_button,t.hangup_button,t.answer_button,t.call_window,t.recipient_media_element,t.user_media_element,t.peer_conn,t.status,t.timer,t.total_time=!1,t.call_initiated=!1,t.ms__contacting_sound,t.ms__ringing_sound,t.ms__incomming_call,t.ms___test_sound,t.timer_interval,t.header_status,t.socket_notif_created,t.callerid=0,t.mob_last_window_focus=(new Date).getTime(),t.smartphone_focus_timeout,t.ios_simulated="no",t.call_1_ended,t.ringing_timeout,t.close_call_click_timeout,t.last_message_send,t.busy_status_timeout,t._call_start_timeout,t.playing_music_plugin,t.media_elements,t.call_start_now,t.microphone_camera_err_msg="<br/>Please make sure your microphone and camera are enabled.",t.setTime=function(){},this.stop_music_plugin=function(){$.socplusMusic&&$.socplusMusic("is_playing")&&($.socplusMusic("pause_playing"),t.playing_music_plugin=1)},this.play_music_plugin=function(){$.socplusMusic&&t.playing_music_plugin&&($.socplusMusic("continue_playing"),t.playing_music_plugin=!1)},this.makeCall=function(e,n,s){e&&evstop(e,1),clearTimeout(t._call_start_timeout),t.call_start_now||(t.start_call(n,s),t.call_start_now=1),t._call_start_timeout=setTimeout(function(){t.call_start_now=!1},2e3)},this.call_popup=function(e,n){t.media_type=e,t.recipientid=n,t.callerid=_U.i,t.total_time,t.call_1_ended=!1,t.ringing_timeout=!1,t.call_initiated=1,t.create_sounds(function(){t._call_popup()}),t.stop_music_plugin()},this.answer_popup=function(e){t.media_type=e.metadata.call_type,t.recipientid=e.metadata.user_id,t.callerid=e.metadata.user_id,t.total_time,t.call_1_ended=!1,t.ringing_timeout=!1,t.call_initiated=1,t.call=e,t.create_sounds(function(){t._answer_popup(e)}),t.stop_music_plugin()},this._answer_popup=function(n){if(t.body.find("#vy_call_popup").length)t.focusCallWindow();else{jAjax(t.ajax_url,"post",{cmd:"answer-popup",metadata:JSON.stringify(n.metadata)}).done(function(s){t.call_window=e(s);var i=t.call_window;t.body.prepend(i),t.status=i.find("#vy_calling_status"),t.header_status=i.find("#vy_ms__header_status"),t.close_button=i.find("#vy_ms__close_buttonevent"),t.hangup_button=i.find("#vy_ms__decline_buttonevent"),t.answer_button=i.find("#vy_ms__answer_buttonevent"),t.media_elements=i.find("#vy_ms_wbrtc_mediaelement"),t.play_sound("incoming"),t.socket.emit("call_user_connected",socketId(n.metadata.user_id)),t.get_notifications(n.metadata),t.addEventsToPopup(i)})}},this._call_popup=function(){if(t.body.find("#vy_call_popup").length)t.focusCallWindow();else{jAjax(t.ajax_url,"post",{cmd:"call-popup",recipient:escape(t.recipientid),media_type:t.media_type}).done(function(n){t.call_window=e(n);var s=t.call_window;t.body.prepend(s),t.status=s.find("#vy_calling_status"),t.header_status=s.find("#vy_ms__header_status"),t.close_button=s.find("#vy_ms__close_buttonevent"),t.hangup_button=s.find("#vy_ms__decline_buttonevent"),t.answer_button=s.find("#vy_ms__answer_buttonevent"),t.media_elements=s.find("#vy_ms_wbrtc_mediaelement"),t.addEventsToPopup(s),t.initiateCall(t.media_type,t.recipientid,t.localStream)})}},this.addEventsToPopup=function(e){e.find("#vy_call_halfmin_btn").off("click.halfminimizeMessCallWindow").on("click.halfminimizeMessCallWindow",function(n){evstop(n),e.addClass("likeclose"),t.enableDrag(e),t.enableResize(e)}),e.find("#vy_call_halfmaximize_btn").off("click.halfmaximizeMessCallWindow").on("click.halfmaximizeMessCallWindow",function(n){evstop(n),e.removeClass("likeclose").find("div:first").removeAttr("style"),t.disableDrag(e),t.disableResize(e)}),e.find("#vy_call_min_btn").off("click.minimizeMessengerCallWindow").on("click.minimizeMessengerCallWindow",function(n){evstop(n),e.addClass("likeclose minimized"),is_smartphone()?e.find("#vy_call_js_draggable").removeAttr("style").center():e.find("#vy_call_js_draggable").removeAttr("style").css({right:"15px",bottom:"15px"}),t.enableDrag(e),t.disableResize(e)}),e.find("#vy_call_maximize_btn").off("click.maximizeMessengerCallWindow").on("click.maximizeMessengerCallWindow",function(n){evstop(n),is_smartphone()?(e.removeClass("likeclose minimized"),e.find("#vy_call_js_draggable").center()):(e.removeClass("minimized"),e.find("#vy_call_js_draggable").center(),t.enableResize(e))}),e.find("#vy_ms__answer_buttonevent").off("click.vy_ms__ANSWER_EVENT").on("click.vy_ms__ANSWER_EVENT",function(n){evstop(n,1),t.answerThisCall(e),this.remove()}),e.find("#vy_ms__decline_buttonevent").off("click.vy_ms__ENDCALL_EVENT").on("click.vy_ms__ENDCALL_EVENT",function(n){evstop(n,1),t.destroyThisCall(this,e)}),e.find("#vy_ms__close_buttonevent").off("click.vy_ms__CLOSE_EVENT").on("click.vy_ms__CLOSE_EVENT",function(n){evstop(n,1),t.destroyThisCall(this,e)}),is_smartphone()&&e.find("#vy_call_halfmin_btn").remove()},this.answerThisCall=async function(e){if(!navigator.mediaDevices)return t.browser_dosent_support_mediadevice();t.stop_sound("incoming"),t.call_status("answered");let n="audio"==t.media_type?{audio:!0,video:!1}:{audio:!0,video:!0};await navigator.mediaDevices.getUserMedia(n).then(e=>{t.localStream=e,t.socket.emit("call_answered",socketId(t.call.metadata.user_id)),t.createAnswer()}).catch(function(e){t.show_error_popup(e+"."+t.microphone_camera_err_msg),t.call_ended("error",!1,e),t.socket.emit("call_unavailable_stream",socketId(t.recipientid))})},this.createAnswer=function(n){e("#vy_ms__decline_buttonevent").removeClass("__reject").addClass("__endcall"),t.media_elements.removeClass("__none"),is_smartphone()&&t.media_elements.addClass("_mobileview"),t.media_elements.find("#vy-ms__user-video-element").draggable(),t.set_media_elements(t.media_type),t.user_media_element[0].srcObject=t.localStream,t.call.answer(t.localStream),t.call.on("stream",function(e){"video"==t.media_type&&t.call_window.addClass("vy_ms__videocall"),setTimeout(function(){t.recipient_media_element[0].srcObject=e,t.recipient_media_element[0].onloadedmetadata=function(e){t.socket.emit("call_started",socketId(t.call.metadata.user_id)),t.call_established(),t.start_timer()}},100)}),t.call.on("close",function(){t.call_ended("finished")})},this.start_timer=function(){let e,n,s;clearTimeout(t.timer_interval);let i=0;t.setTime=function(){++i,e=Math.floor(i/3600),n=Math.floor((i-3600*e)/60),s=i-(3600*e+60*n),e<10&&(e="0"+e),n<10&&(n="0"+n),s<10&&(s="0"+s),t.total_time=e+":"+n+":"+s,t.status.text(t.total_time),t.set_header_status(t.total_time),t.timer_interval=setTimeout(t.setTime,1e3),navigator.onLine||t.show_err_msg("network")},t.setTime()},this.set_header_status=function(e){t.header_status.html("&nbsp;&#9866;&nbsp;"+e)},this.destroy_timer=function(){clearTimeout(t.timer_interval),t.setTime=function(){}},this.destroyThisCall=function(n,s){const i=!!(n=e(n)||!1)&&n.hasClass("__callinitiator");n&&n.hasClass("__reject")?t.call_ended("rejected",i):n&&n.hasClass("__endcall")&&!n.hasClass("__reject")&&t.call_ended("finished",i),t.localStream&&("video"==t.media_type?(t.localStream.getVideoTracks()[0].stop(),t.localStream.getAudioTracks()[0].stop()):t.localStream.getAudioTracks()[0].stop(),t.localStream=!1),t.stop_sound("all"),t.destroy_timer(),t.call&&t.call.close(),t.disableResize(s),t.disableDrag(s),t.destroy_sounds(),setTimeout(function(){s.remove(),t.set_peer_status("available")},10),t.callerid=0,t.total_time=!1,t.call_initiated=!1,clearTimeout(t.close_call_click_timeout),clearTimeout(t.busy_status_timeout),t.play_music_plugin()},this.set_peer_status=function(e){jAjax(t.ajax_url,"post",{cmd:"set-peer-status",action:e})},this.focusCallWindow=function(){t.call_window.removeClass("minimized").addClass("likeclose"),t.call_window.find("#vy_call_js_draggable").center(),t.enableResize(t.call_window),t.enableDrag(t.call_window)},this.enableDrag=function(e){const t=e.find("#vy_call_js_draggable");t.is(":data(ui-draggable)")||t.draggable({handle:"#vy_js_calls_header",scroll:!1})},this.disableDrag=function(e){const t=e.find("#vy_call_js_draggable");t.is(":data(ui-draggable)")&&t.draggable("destroy")},this.enableResize=function(e){const t=e.find("#vy_call_js_draggable");t.is(":data(ui-resizable)")||t.resizable({handles:"n, e, s, w, se, nw",minHeight:450,minWidth:190})},this.disableResize=function(e){const t=e.find("#vy_call_js_draggable");t.is(":data(ui-resizable)")&&t.resizable("destroy")},this.peer_open=function(e){t.last_peer_id=e},this.peer_disconnected=function(){clearTimeout(t.reconnectPeerTimeout),t.peer.id=t.last_peer_id,t.peer._lastServerId=t.last_peer_id,t.peerJS_reconnect_times<=t.reconnectPeerTimesCount?t.reconnectPeerTimeout=setTimeout(function(){t.peer.reconnect(),t.peerJS_reconnect_times++},5e3):(clearTimeout(t.reconnectPeerTimeout),console.log("Sorry, the system can not connect to peerJS, this mean your video/audio calling will not work."),t.set_peer_status("cant_receive_signal"))},this.connect=function(){t.peer=new Peer(t.peer_uniq_id,{license:{code:messenger_code,domain:window.location.hostname,v:vy_ms_v},host:PEER_HOST_NAME,port:PEER_PORT,key:"peerjs",reconnectTimer:1e3,serialization:"json",iceTransportPolicy:"relay",debug:0,path:PEER_PATH,metadata:{user_name:_U.fn,user_avatar:_U.p,user_id:_U.i,peer_id:t.peer_uniq_id},config:{iceServers:[{url:iceservers_stun,credential:iceservers_cr,username:iceservers_un},{url:iceservers_turn,credential:iceservers_cr,username:iceservers_un}]}}),t.peer.on("open",t.peer_open),t.peer.on("disconnected",t.peer_disconnected),t.socket.emit("update_peer_id",JSON.stringify({Userid:socketId(_U.i),Peer_id:t.peer_uniq_id})),t.peer.on("open",function(e){console.log(e),t.update_peer_id(e),t.set_peer_status("available")}),t.peer.on("close",function(e){console.log("Close: declined")}),t.peer.on("connection",function(e){}),t.peer.on("call",function(e){t.answer_popup(e),t.set_peer_status("another_call")}),t.peer.on("error",function(e){t.show_err_msg(e.type)}),t.mob_last_window_focus=(new Date).getTime(),e(window).off("unload.vy-ms__offline_peer beforeunload.vy-ms__offline_peer").on("unload.vy-ms__offline_peer beforeunload.vy-ms__offline_peer",function(){return vy_calls.peerIsOffline()}),t.enable_sounds_for_ios()},this.peerIsOffline=function(){t.set_peer_status("offline"),t.total_time?t.call_ended("finished"):t.call_ended("rejected")},this.show_err_msg=function(e){switch(e){case"browser-incompatible":t.call_ended("error",!1,"The client's browser does not support some or all WebRTC features that you are trying to use.");break;case"disconnected":t.call_ended("error",!1,"Disconnected from the server."),t.reconnectPeer();break;case"invalid-id":t.call_ended("error",!1,"An tehnical error ocurred.[INVALID ID]");break;case"network":t.call_ended("error",!1,"Network down. Lost or cannot establish a connection to the signalling server.");break;case"peer-unavailable":t.call_ended("notif",!1,"The user can not receive calls at the moment, try again later.");break;case"server-error":t.call_ended("error",!1,"Unable to reach the server.");break;case"socket-error":t.call_ended("error",!1,"An error from the underlying socket.");break;case"socket-closed":t.call_ended("error",!1,"The underlying socket closed unexpectedly.");break;case"unavailable-id":t.peer.disconnect(),t.reconnectPeer(),t.call_ended("notif",!1,"The user can not be reached at the moment, please try to reload your page.. and try again.");break;case"webrtc":t.call_ended("error",!1,"Tehnical error. Native WebRTC errors.")}},this.update_peer_id=function(e){jAjax(t.ajax_url,"post",{cmd:"update-peer-id",id:e}).done(function(e){})},this.enable_sounds_for_ios=function(){t.ms___test_sound=soundManager.createSound({id:"ms__test_sound",url:THEME_URL+"/javascript/vaneayoung/sounds/tap.aac",volume:0,autoPlay:!1,type:"audio/aac",onload:function(){t.ios_simulated="yes",this.destruct()}}),soundManager.onready(function(){soundManager.load("ms__test_sound")}),is_smartphone()&&e(document).off("touchstart.simulateIosAudio click.simulateIosAudio").on("touchstart.simulateIosAudio click.simulateIosAudio",function(){if("yes"==t.ios_simulated)return e(document).off("touchstart.simulateIosAudio click.simulateIosAudio"),!1;"function"==typeof t.ms___test_sound&&t.ms___test_sound.play()})},this.reconnectPeer=function(){t.peer.connect(t.peer_uniq_id,{license:{code:messenger_code,domain:window.location.hostname},host:PEER_HOST_NAME,port:PEER_PORT,debug:!1,metadata:{user_name:_U.fn,user_avatar:_U.p,user_id:_U.i,peer_id:t.peer_uniq_id}})},this.disconnectPeer=function(){t.peer&&t.peer.disconnect()},this.browser_dosent_support_mediadevice=async function(){ajaxLoading();jAjax(t.ajax_url,"post",{cmd:"call-error",msg:"Your browser dose not support Video/Audio calls."}).done(function(e){removeAjaxLoad(),t.body.find("#vy-ms__call_error_popup_info").remove(),t.body.prepend(e)}),t.close_button.trigger("click"),t.socket.emit("call_unavailable_stream",socketId(t.recipientid))},this.show_error_popup=function(e){$.confirm({title:"Disabled or not supported.",content:e,type:"red",typeAnimated:!0,buttons:{close:function(){}}}),t.close_button&&t.close_button.trigger("click")},this.start_call=async function(e,n){if(!navigator.mediaDevices)return t.browser_dosent_support_mediadevice();let s="audio"==e?{audio:!0,video:!1}:{audio:!0,video:!0};await navigator.mediaDevices.getUserMedia(s).then(s=>{t.localStream=s,t.call_popup(e,n)}).catch(function(e){t.show_error_popup(e+"."+t.microphone_camera_err_msg),t.call_ended("error",!1,e)})},this.set_media_elements=function(n){t.recipient_media_element=e("video"==n?"#vy-ms__recipient-video-element":"#vy-ms__recipient-audio-element"),t.user_media_element=e("video"==n?"#vy-ms__user-video-element":"#vy-ms__user-audio-element")},this.initiateCall=function(e,n,s){t.set_media_elements(e),jAjax(t.ajax_url,"post",{cmd:"initiate-call",type:e,recipient:escape(n)}).done(function(n){const i=validateJson(n);if(i.peer_id<=0)return t.userNotConnected();if("another_call"==i.status)return t.call_ended("another_call");if("offline"==i.status)return t.call_ended("offline");if("cant_receive_signal"==i.status)return t.call_ended("cant_receive_signal");const a={metadata:{user_name:_U.fn,user_avatar:_U.p,user_id:_U.i,call_type:e},constraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}};t.play_sound("contacting"),setTimeout(function(){t.user_media_element[0].srcObject=s},100),t.media_elements.removeClass("__none"),is_smartphone()&&t.media_elements.addClass("_mobileview"),t.media_elements.find("#vy-ms__user-video-element").draggable(),t.set_peer_status("another_call"),t.call=t.peer.call(i.peer_id,s,a),t.call.on("stream",function(e){t.getRecipientStream(e)}),t.call.on("error",function(e){t.set_peer_status("available")}),t.get_notifications(t.call.metadata)})},this.getRecipientStream=function(e){t.set_media_elements(t.media_type),t.recipient_media_element[0].srcObject=e,"video"==t.media_type&&t.call_window.addClass("vy_ms__videocall")},this.stop_sound=function(e,n){switch(e){case"contacting":setTimeout(function(){t.ms__contacting_sound.stop()},10);break;case"ringing":setTimeout(function(){t.ms__ringing_sound.stop()},10);break;case"incoming":setTimeout(function(){t.ms__incomming_call.stop()},10);break;case"busy":setTimeout(function(){t.ms__busy_sound.stop()},10);break;case"noanswer":setTimeout(function(){t.ms__noanswer_sound.stop()},10);break;case"all":setTimeout(function(){t.ms__contacting_sound.stop(),t.ms__ringing_sound.stop(),t.ms__incomming_call.stop(),t.ms__busy_sound.stop(),t.ms__noanswer_sound.stop()},10)}n||setTimeout(function(){t.stop_sound_propagate(e)},1500)},this.stop_sound_propagate=function(e){return t.stop_sound(e,1)},this.play_sound=function(e){switch(e){case"contacting":t.ms__contacting_sound.play();break;case"ringing":t.ms__ringing_sound.play();break;case"incoming":t.ms__incomming_call.play();break;case"busy":t.ms__busy_sound.play();break;case"noanswer":t.ms__noanswer_sound.play()}},this.create_sounds=function(e){t.ms__incomming_call=soundManager.createSound({id:"ms_call_incoming",url:THEME_URL+"/javascript/vaneayoung/sounds/incoming_call.mp3",volume:100,autoPlay:!1,onfinish:function(){this.play()}}),t.ms__ringing_sound=soundManager.createSound({id:"ms_call_ringing",url:THEME_URL+"/javascript/vaneayoung/sounds/call-ringing-2s.mp3",volume:100,autoPlay:!1,type:"audio/mp3",onfinish:function(){let e=this;setTimeout(function(){e.play()},900)}}),t.ms__contacting_sound=soundManager.createSound({id:"ms_call_contacting",url:THEME_URL+"/javascript/vaneayoung/sounds/call-connecting.mp3",volume:100,autoPlay:!1,type:"audio/mp3",onfinish:function(){this.play()}}),t.ms__busy_sound=soundManager.createSound({id:"ms_call_busy",url:THEME_URL+"/javascript/vaneayoung/sounds/call-busy.mp3",volume:100,autoPlay:!1,type:"audio/mp3"}),t.ms__noanswer_sound=soundManager.createSound({id:"ms_call_noansnwer",url:THEME_URL+"/javascript/vaneayoung/sounds/call-noanswer.mp3",volume:100,autoPlay:!1,type:"audio/mp3"}),soundManager.onready(function(){soundManager.load("ms_call_incoming"),soundManager.load("ms_call_ringing"),soundManager.load("ms_call_contacting"),soundManager.load("ms_call_busy"),soundManager.load("ms_call_noansnwer"),"function"==typeof e&&e()})},this.destroy_sound=function(e,n){n&&(t.destroy_sounds(),t.create_sounds())},this.destroy_sounds=function(){soundManager.stopAll(),t.ms__contacting_sound.destruct(),t.ms__ringing_sound.destruct(),t.ms__incomming_call.destruct(),t.ms__busy_sound.destruct(),t.ms__noanswer_sound.destruct()},this.call_status=function(e,n,s){let i=function(e,n){n=n||e,t.set_header_status(n),t.status.text(e)};switch(e){case"connecting":i(lang["Call_Contacting..."]);break;case"rejected":i(lang.Call_rejected),t.call_ended("rejected");break;case"reject_status":i("I'm Busy! I call you back later.","Busy");break;case"started":i(n);break;case"callended":i(lang.call_ended,n);break;case"no_answer":i(lang.call_no_answer,lang.call_no_answer);break;case"another_call":i("Is on another call.","Line Busy");break;case"ringing":i(lang["Call_Ringing..."]);break;case"disconected":i("Recipient is disconnected.","Disconnected");break;case"answered":i(lang["Call_Connecting..."]);break;case"offline":i("I'm offline, i will call back soon.","Offline");break;case"unavailable_stream":i(lang.call_recipient_err_stream.replace("%uname",s.user_name).replace("%calltype",s.call_type),"Call ended."),t.call_ended("no_stream")}},this.call_established=function(){is_smartphone()||e("#vy_call_halfmin_btn").trigger("click.halfminimizeMessCallWindow")},this.get_notifications=function(e){t.socket_notif_created||(t.socket_notif_created=1,t.socket.on("call_user_connected",function(e){t.call_1_ended||(t.stop_sound("contacting"),t.play_sound("ringing"),t.call_status("ringing"),t.ringing_timeout=setTimeout(function(){t.call_ended("no-answer",1)},6e4))}),t.socket.on("call_rejected",function(e){t.call_status("rejected")}),t.socket.on("call_answered",function(e){t.stop_sound("all"),t.call_status("answered")}),t.socket.on("call_unavailable_stream",function(n){t.call_status("unavailable_stream",!1,e)}),t.socket.on("call_started",function(e){setTimeout(function(){t.stop_sound("ringing"),t.stop_sound("all")},100),t.start_timer(),t.call_established(),t.ringing_timeout&&clearTimeout(t.ringing_timeout)}),t.socket.on("call_finished",function(e){t.call_ended("finished")}),t.socket.on("call_stopped",function(e){t.call_ended("finished")}))},this.call_ended=function(e,n,s){!t.call_1_ended&&t.call_initiated&&(t.timer_interval&&clearTimeout(t.timer_interval),"rejected"==e&&(setTimeout(function(){t.stop_sound("ringing"),t.play_sound("busy")},100),t.socket.emit("call_rejected",socketId(t.recipientid)),t.busy_status_timeout=setTimeout(function(){t.call_status("reject_status")},1500),t.close_call_click_timeout=setTimeout(function(){t.stop_sound("all"),t.close_button.trigger("click")},9e3)),"another_call"==e&&(setTimeout(function(){t.stop_sound("all",1),t.play_sound("busy")},50),t.busy_status_timeout=setTimeout(function(){t.call_status("another_call")},100),t.sendMessage("missed"),t.close_call_click_timeout=setTimeout(function(){t.stop_sound("all"),t.close_button.trigger("click")},9e3)),"cant_receive_signal"==e&&(setTimeout(function(){t.stop_sound("all",1),t.play_sound("busy")},50),t.busy_status_timeout=setTimeout(function(){t.call_status("disconected")},100),t.sendMessage("missed"),t.close_call_click_timeout=setTimeout(function(){t.stop_sound("all"),t.close_button.trigger("click")},9e3)),"offline"==e&&(setTimeout(function(){t.play_sound("busy")},50),t.busy_status_timeout=setTimeout(function(){t.call_status("offline")},100),t.sendMessage("missed"),t.close_call_click_timeout=setTimeout(function(){t.stop_sound("all"),t.close_button.trigger("click")},9e3)),"no-answer"==e&&(setTimeout(function(){t.stop_sound("ringing"),t.play_sound("noanswer")},100),t.socket.emit("call_stopped",socketId(t.recipientid)),setTimeout(function(){t.call_status("no_answer")},150),t.close_call_click_timeout=setTimeout(function(){t.stop_sound("all"),t.close_button.trigger("click")},18e3)),"error"!=e&&"notif"!=e||(setTimeout(function(){t.stop_sound("all",1),t.play_sound("busy")},50),t.busy_status_timeout=setTimeout(function(){t.set_header_status("error"==e?"Error":"Call finished"),t.status.text(s)},100),t.close_call_click_timeout=setTimeout(function(){t.stop_sound("all"),t.close_button.trigger("click")},9e3)),"no_stream"==e&&(setTimeout(function(){t.stop_sound("all",1),t.play_sound("busy")},50),t.close_call_click_timeout=setTimeout(function(){t.stop_sound("all"),t.close_button.trigger("click")},9e3)),"finished"==e&&(setTimeout(function(){t.stop_sound("ringing"),t.stop_sound("all")},100),t.call_status("callended",t.total_time),t.socket.emit("call_finished",socketId(t.recipientid)),t.close_call_click_timeout=setTimeout(function(){t.close_button.trigger("click")},3e3)),t.hangup_button.hasClass("__callinitiator")&&("finished"==e&&t.total_time?t.sendMessage("ended",t.total_time):t.sendMessage("missed")),t.call_window.removeClass("vy_ms__videocall"),t.answer_button.hide(),t.hangup_button.hide(),t.close_button.show(),t.call&&t.call.close(),t.call_1_ended=1)},this.sendMessage=function(e,n){if(t.last_message_send)return;let s,i=window.event||$.Event();switch(e){case"missed":s="[missedcall]"+_U.i+"-"+t.recipientid+"-"+t.media_type+"[/missedcall]";break;case"ended":s="[callended]"+_U.i+"-"+t.recipientid+"-"+t.media_type+"-"+n+"[/callended]"}s&&messenger.send(0,i,s,t.recipientid),t.last_message_send=1,setTimeout(function(){t.last_message_send=0},3e3)},this.userNotConnected=function(){t.call_ended("cant_receive_signal")}}