var messenger=new Messenger,mess_shortcut=function(e,t,s){return new Messenger(e,t,s)};function Messenger(e,t,s){if(s=s||{},void 0===n)var n=function(e){return $(e)};"function"!=typeof createUrl&&"object"==typeof window&&(window.createUrl=function(e,t,s){i.noNewUrl||history.pushState(e,t,s)});var i=this;i.hasTouchStartEvent=is_smartphone(),i.is_mobile=window.innerWidth<=800&&window.innerHeight<=600||navigator.maxTouchPoints||"ontouchstart"in document.documentElement,i.mob_agent=i.getMobileOperatingSystem,i.ajax_url=V_HOST+"/messenger.php",i.body=n("body"),i.html=n("html"),i.hostname="",i.messengerInitiated=!1,i.noNewUrl=!1,i.socket=sio,i.socket_messages="null",i.room_id,i.socket_rooms=[],i.recipient_picture=_BLANK,i.recipient_fullname,i.force_bg=!1,i.emojiarea_created=!1,i.sending_Message=!1,i.show_sent_status=t||!1,i.window_curr_title=__SITENAME,i.recipient_last_message_timestamp,i.isOldTitle=!0,i.count_minus=!1,i.group_admin=0,i.minus_count_message=!1,i.blinkTitleInterval,i.scrollNow=!1,i.last_msg_date=!1,i.mdialog_hide_loader=!1,i.uploadingMedia=0,i.conversation_in_viewport=!0,i.msg_with_preview=!!s.hasOwnProperty("preview")&&s.preview,i.typing_now=0,i.Typing_timeoutFunction=function(){},i.timeout_typing=function(){},i.scrollChatDelayTime=2e3,i.last_message_object={msgs_count:0,global:0},i.recipient_nickname="",i.mess_opened_contacts=[],i.mess_opened_contacts__shortcut=[],i._search_conv_messages=[],i.search_in_conv_curr_id=0,i.text_val=i.text_val||"",i.msg_page={},i.attach_page=1,i.randId=Math.floor(2*Math.random()),i.default_color=chat_default_color,i.curr_color=chat_default_color,i.contenteditable,i.curr_recipient,i.mobile_btn_timeout,i.voice_clip_chunks,i.voice_clip_media_recorder,i.recording_timeout,i.mediatp,i.shortcut=!!e&&n("#"+e),i.pmessenger=n(".pmessenger"),i.shortcut_id_num,i.shortcut_id,i.voice_clip_extension="wav",i.photoTypes=["JPG","JPEG","PNG","GIF","WEBP","TIFF","BMP","ICO","PJP","SVG","TIF"],i.videoTypes=["MP4","WEBM","MPG","MPEG","WMV","MOV","MPE","MPV","OGG","MP4","M4P"],i.BBCODES=validateJson(VY_MS_BBCODES),i.global_popup=".js__vy_ms__globalpopup",i.event,i.timeout_opencontact,i.timeout_attach,i.unmute_wo_timeout,i.more_contacts_page=1,i.loaded_all_contacts=!1,i.mediaRecorderConstructed=!1,i.messenger_local_stream=!1,i.sended_location,i.existingCall,i.media_files,i.page_id=0,i.recipient_user_id=0,i.send_important=0,i.holding_touch_timer,i.audiorecorder_shortcut,i.audiorecorder_btn,i.messenger_call_start_timeout,i.user_not_found=!1,i.user_privacy=0,i.mob_focus_timeout,i.forward_msg_timeout={},i.msg_cannot_send=!1,i.beforeOpenContact_valid=!1,i.privacy_msg="",i.enable_copytoclipboard_mob_btn,i.conv_status=200,i.newgchat_sel_users=new Array,i.reply_enabled=0,i.replies={},i.mob_hidden_btns={},i.drafts={},i.attach_draft={},i.attach_draft_offset={},i.attach_draft_polnii={},i.svgi=vy_ms_svgi,i.gl_scrollChatDelay=100,i.group_id,i.last_msg_timestamp=0,i.message_space_time=6e4,i.timeouts={},i.flying_new_message_markup='<div id="flying-notif-new-messages">+%count&nbsp;'+lang.new_messages+"</div>",i.notif__markup='<Div class="vy_ms__groupusermsgs vymsnotif vy_ms__group_msg_margin"><div id="msg_00" class="pmessenger-message-txt messenger_notif_nickname"><div class="mess_notif_nick_text">%text</div></div></div>',i.prev_messages_btn='<div class="messenger_older_msg_div"><a rel="li-gliph-color-border" class="messenger_older_msg_a ellip" href="javascript:void(0);" onclick="messenger.mdialog_load_prev_messages(event,this);" uid="mdialog_prev_btn_ld" id="id-prev-comm-link-w-msg"><span class="txt-msg-old-load-g ellip" rel="gliph-mess-color">'+lang.pm_load_old+'</span><span class="txt-msg-old-load">'+lang.please_wait+"...</span></a></div>",i.mess_colors=vy_ms_colors,i.reactions={like:{title:lang.Messenger_reaction_like,css_class:"_like",color:"rgb(244, 67, 54)"},haha:{title:lang.Messenger_reaction_haha,css_class:"_haha",color:"rgb(255, 202, 40)"},wow:{title:lang.Messenger_reaction_wow,css_class:"_wow",color:"rgb(255, 193, 7)"},sad:{title:lang.Messenger_reaction_sad,css_class:"_sad",color:"rgb(255, 202, 40)"},angry:{title:lang.Messenger_reaction_angry,css_class:"_angry",color:"rgb(244, 67, 54)"}},e&&(recipientId=tonum(e),i.curr_recipient=recipientId,i.shortcut_id=e,i.shortcut_id_num=void 0!==e&&e.includes("GG")?e.split("-")[1]:recipientId),this.open=function(e,t){e.preventDefault(),t=n(t),addTopGlobalHelper(),jAjax(i.ajax_url,"post",{cmd:"open"}).done(function(e){n("#messenger_window_body").length||(n("#messenger-box-app").html(e),n(".messenger-shortcut-container").addClass("zindex1"),t.parent().addClass("__active"),t.parent().addClass("__on")),n(document).off("click.closeMessBox").on("click.closeMessBox","body",function(e){i.closeBox()}),n(document).off("keyup.closeMessBox").on("keyup.closeMessBox","body",function(e){27==e.keyCode&&i.closeBox()}),n("#close-messenger-box").on("click",function(e){i.closeBox()})})},this.closeBox=function(){n("#messenger-box-app").empty(),n(document).off("click.closeMessBox keyup.closeMessBox"),n(".messenger-shortcut-container").removeClass("zindex1"),n(".bas_ntf_top.msgs").removeClass("__active __on")},this.separateMediaFromText=function(e){var t="",s="";n("body").find("#messenger_message_cookie").length||n("body").prepend('<div id="messenger_message_cookie" style="position:absolute;display:none;"></div>');var a=n("#messenger_message_cookie");if(a.html(e),a.find(".messenger-start-media").length)s=(o=a.find(".messenger-start-media")).html(),o.remove(),t=void 0!==a.text()?$.trim(a.text()):"",i.gl_scrollChatDelay=i.scrollChatDelayTime;else if(a.find(".js_urlpreview").length){s=(o=a.find(".js_urlpreview")).html(),o.remove(),t=void 0!==a.text()?$.trim(a.text()):"",i.gl_scrollChatDelay=500}else if(a.find(".js_mess_map_loc").length){s=(o=a.find(".js_mess_map_loc")).html(),o.remove(),t=void 0!==a.text()?$.trim(a.text()):"",i.gl_scrollChatDelay=i.scrollChatDelayTime}else if(a.find(".sp-voice-clip-comment").length){s=(o=a.find(".sp-voice-clip-comment")).html(),o.remove(),t="",i.gl_scrollChatDelay=10}else if(a.find(".commentsWidgetTracks").length){s='<div class="messenger_msgs_tracks">'+(o=a.find(".commentsWidgetTracks")).html()+"</div>",o.remove(),t=void 0!==a.text()?$.trim(a.text()):"",i.gl_scrollChatDelay=i.scrollChatDelayTime}else if(a.find(".msg_gif").length){s=(o=a.find(".msg_gif")).parent().html(),o.remove(),t="",i.gl_scrollChatDelay=2e3}else if(a.find(".msg_shared_cnt").length){s=(o=a.find(".msg_shared_cnt")).parent().html(),o.remove(),t="",i.gl_scrollChatDelay=1500}else if(a.find(".messenger_call_msg").length){s=(o=a.find(".messenger_call_msg")).parent().html(),o.remove(),t="",i.gl_scrollChatDelay=i.scrollChatDelayTime}else if(a.find(".embera_embd").length){var o;s='<div class="mess-embera">'+(o=a.find(".embera_embd")).html()+"</div>",o.remove(),t=void 0!==a.text()?$.trim(a.text()):"",i.gl_scrollChatDelay=i.scrollChatDelayTime}else a.find(".emotics").length?(t=$.trim(a.text()))?t=$.trim(a.html()):(t=t,s=a.html()):a.find("img").length?(i.gl_scrollChatDelay=i.scrollChatDelayTime,(t=$.trim(a.text()))?t=$.trim(a.html()):(t=t,s=a.html())):a.find(".sticker").length?(t="",s=a.html()):t=a.html();return a.empty(),[t,s]},this.getReactedPeople=function(e,t){evstop(t,1);var s=(e=n(e)).data("reactedpeople"),a="",o=function(){};modernPopup(function(e,t,r){messenger__sort_reaction=function(e,t){n(".js__people-reacted-top-header").removeClass("active"),n(e).addClass("active"),n("#js__reactions_popup_users_content").html('<div class="div-loader"></div>'),jAjax(i.ajax_url,"post",{cmd:"getReactedPeople",reaction:t,item_id:escape(s.itemid),item_type:s.item_type}).done(function(e){o(e,1)})},o=function(e,s){var n=validateJson(e),o=n.data;if(!s){let e=new Array;for(var r=0;r<n.each_reaction_count.length;r++)-1===$.inArray(n.each_reaction_count[r].type,e)&&(a+='<li><a class="js__people-reacted-top-header people-reacted-top-header" href="javascript:;" onclick="messenger__sort_reaction(this,\''+i.reactions[n.each_reaction_count[r].type].title+'\');"><span class="peoplewhoreacted-categs notif-type-icon _'+i.reactions[n.each_reaction_count[r].type].css_class+'"></span><span style="color:'+i.reactions[n.each_reaction_count[r].type].color+';">'+i.reactions[n.each_reaction_count[r].type].title+" ("+n.each_reaction_count[r].count+")</span></a></li>"),e.push(n.each_reaction_count[r].type);var c='<div class="users-reactions-popup-allcnt"><ul class="top-header-users-reacted-categ">\t\t\t\t\t\t\t\t<li><a class="js__people-reacted-top-header people-reacted-top-header active" href="javascript:;" onclick="messenger__sort_reaction(this,\'all\');">'+lang.Messenger_All+" ("+n.all_count+")</a></li>\t\t\t\t\t\t\t\t"+a+'\t\t\t\t\t\t\t\t</ul><div class="nano reaction-users-content"><div id="js__reactions_popup_users_content" class="overthrow nano-content"></div></div></div>';t.html(c)}for(var _="",l=0;l<n.data.length;l++)_+='<div class="people-reacted-user"><div class="people-reacted-user-avatar peoplewhoreacted-reaction-near-avatar notif-type-icon __'+o[l].reaction+'"><img src="'+o[l].user.profile_photo+'" /></div><div class="people-reacted-user-str"><div class="people-reacted-user-str-fullname"><a href="/vyuser/'+o[l].user.id+'" hrefattr="true">'+o[l].user.fullname+'</a></div><div class="people-reacted-user-str-username"><i>@'+o[l].user.username+"</i></div></div></div>";"yes"==n.success?t.find("#js__reactions_popup_users_content").html(_):t.html(lang.Messenger_poeple_reacted_empty),nanoScrollStart()},jAjax(i.ajax_url,"post",{cmd:"getReactedPeople",reaction:"all",item_id:escape(s.itemid),item_type:s.item_type}).done(function(e){o(e)})},!0)},this.getReactionMarkup=function(e){let t=i.getReactionsMarkup(e.id,e.reactions,e);return{"reaction-type":t["reaction-type"],reacted:t.reacted?"reacted":"",markup:'<div class="message-reactions-std"><a href="javascrip:void(0);" data-reactedpeople=\'{"itemid":"'+e.id+'","item_type":"message"}\' onclick="messenger.getReactedPeople(this,event);"><div class="js__message-reactions-std-ics">'+t.html+'</div><div data-msgid="'+e.id+'" class="message_reactions __c'+t.count+'">'+(t.count>0?t.count:"")+"</div></a></div>",count:t.count}},this.getMessagesMarkup=function(e,t,s,a,o,r,c){let _=!!s,l=(n("#vy_ms__lastmsg_timestamp").val(),o-i.last_msg_timestamp>=i.message_space_time&&i.last_msg_timestamp>0?"messenger_msg_mrg":""),d=i.getReactionMarkup(e),m=messenger.emoji_convert(e.msg),u=i.separateMediaFromText(m),g=u[0],p=u[1],v=d.count>0?"vy_ms__msg_reacted":"",h=i.replied_msg(e.reply);return a=!!a,i.last_msg_timestamp=o,"me"==t?(s=s||a?'<img src="'+_U.p+'" />':'<img src="'+_BLANK+'" />','<div data-unsettled-msg-id="'+e.unsettled_msg_id+'" '+(e.group_id>0?'title="'+lang.mess_msg_seen+" ("+e.count_group_seen+" "+lang.people+')"':"")+' id="msg_'+e.id+'" data-msg-timestamp="'+e.timestamp+'" class="pmessenger-message-txt _me soh-s '+(h?"_contains_reply":"")+" "+("yes"==c?"__vforwarded":"")+" "+v+" "+l+"  vyms__isread__"+e.read+" "+(_?"":"messenger-message-margin-m")+" "+("no"==e.bg?"_nobg":"")+'">\t\t\t\t<div class="txt_pmessenger-user-avatar">'+s+"</div>\t\t\t\t"+i.forwarded_markup(c,1)+'<div class="vycntreply243">'+h+'<div class="messenger_text_col">'+($.trim(g)?'<div rel="li-gliph-color-background" class="txt_pmessenger-text mess-msgs-cnt-rows">'+g+d.markup+"</div>":"")+($.trim(p)?'<div class="mess-msgs-cnt-rows messenger_media_in_msg">'+p+d.markup+"</div>":"")+"</div></div>"+i.message_actions(e.id,e.time,e.group_id,e.page_id,e.recipient,d,e.from_id)+"\t\t\t\t</div>"):(s=s||a?'<img src="'+i.recipient_picture+'" />':'<img src="'+_BLANK+'" />',r='<a href="/vyuser/'+e.from_id+'" class="vy_ms__groupuser_fullname">'+r+"</a>",'<div data-unsettled-msg-id="'+e.unsettled_msg_id+'" '+(e.group_id>0?'title="'+lang.mess_msg_seen+" ("+e.count_group_seen+" "+lang.people+')"':"")+' id="msg_'+e.id+'" data-msg-timestamp="'+e.timestamp+'"  class="pmessenger-message-txt soh-s '+(h?"_contains_reply":"")+" "+("yes"==c?"__vforwarded":"")+" "+v+" "+l+" "+(_?"":"messenger-message-margin-m")+" "+("no"==e.bg?"_nobg":"")+'">\t\t\t\t<div class="txt_pmessenger-user-avatar">'+s+"</div>\t\t\t\t"+i.forwarded_markup(c)+'<div class="vycntreply243">'+h+'<div class="messenger_text_col '+("no"==e.read?"is_new":"")+'">'+($.trim(g)?'<div class="txt_pmessenger-text mess-msgs-cnt-rows">'+r+g+d.markup+"</div>":"")+($.trim(p)?'<div class="mess-msgs-cnt-rows messenger_media_in_msg">'+p+d.markup+"</div>":"")+"</div></div>"+i.message_actions(e.id,e.time,e.group_id,e.page_id,e.recipient,d,e.from_id)+"\t\t\t\t</div>")},this.ReplyscrollToOriginalMessage=async function(e,t){evstop(t,1),i.timeouts.load_old_messages_for_replies&&clearTimeout(i.timeouts.load_old_messages_for_replies),i.timeouts.load_old_messages_for_replies_anim&&clearTimeout(i.timeouts.load_old_messages_for_replies_anim);let s=n(e).data("msgd"),a=s.id>0?s.id:s.unsettled_msg_id,o=n("#messages-tick .nano"),r=i.pmessenger.find("#pmessenger-messages-cnt"),c=n("#msg_"+a).length?n("#msg_"+a):n('[data-unsettled-msg-id="'+a+'"]');return null==a?$.alert(lang.Messenger_message_removed):c.length?(o.addClass("__animated").nanoScroller({scrollTop:c.get(0).offsetTop-r.height()+c.outerHeight()}),void(i.timeouts.load_old_messages_for_replies_anim=setTimeout(function(){c.addClass("message_flipInX_animation"),setTimeout(function(){c.removeClass("message_flipInX_animation")},1e3)},500))):(ajaxLoading(),await i.pmessenger.find('[uid="mdialog_prev_btn_ld"]').trigger("click"),void(i.timeouts.load_old_messages_for_replies=setTimeout(function(){removeAjaxLoad(),i.ReplyscrollToOriginalMessage(e,t)},1e3)))},this.replied_msg=function(e){if(null!=e){var t=e.str;delete e.str}return null==e?"":"<div data-msgd='"+JSON.stringify(e)+'\' class="vy_ms__replied_message" sfasfontouchend="messenger.ReplyscrollToOriginalMessage(this,event);" onclick="messenger.ReplyscrollToOriginalMessage(this,event);"><div class="vy_ms_4ffazv1"><div class="vy_ms_svgi31qr">'+i.svgi.js.reply+'</div></div><div class="vy_ms_f45vwq1">'+t+"</div></div>"},this.switchToNextConv=function(){var e=n(".pmessenger-contact-a.active");e.slideUp(400,function(){e.remove(),setTimeout(function(){i.firstConvClick()},100)})},this.firstConvClick=function(){const e=n(".pmessenger-contact-a:first");i.pmessenger=n(".pmessenger"),e.length?e.trigger("click"):e.length||n(".pmessenger-messages-list").hasClass("empty")?i.hasTouchStartEvent&&i.show_contacts():window.location.reload(),n('script[rel="vy_ms__remove_on_dom_ready"]').each(function(){n(this).remove()})},this.contactToBlacklist=function(e,t){evstop(e,1),i.confirm_act(lang.Messenger_block_user_info.replace(/%username/g,i.recipient_fullname),function(e){jAjax(i.ajax_url,"post","cmd=uToBlackList&userid="+escape(i.curr_recipient)).done(function(e){"1"===e?i.switchToNextConv():"0"===e?displayErr(lang.pm_us_exist_blacklist):"1"!==e&&"0"!==e&&displayErr(lang.processing_error)})},!1,lang.Messenger_btn_confirm_blacklist)},this.hideConversation=function(e,t){e.preventDefault(),e.stopImmediatePropagation(),jAjax(i.ajax_url,"post","cmd=hideConversation&userid="+escape(i.curr_recipient)).done(function(e){"1"==e?i.switchToNextConv():displayErr(lang.somethingWrong)})},this.deleteConversation=function(e,t,s){e.preventDefault(),e.stopImmediatePropagation(),i.confirm_act(jprintf(lang.pm_confirm_delete_conversation,i.recipient_fullname),function(e){var t={cmd:"delConversation",userid:escape(i.curr_recipient)};s>0&&(t.page=s),jAjax(i.ajax_url,"post",t).done(function(e){"1"==e?i.switchToNextConv():displayErr(lang.somethingWrong)})},!1,lang.delete_conversation)},this.swipeDeleteConv=function(e,t,s){evstop(e,1);let a=0,o=n(t).parent(),r=o.attr("id"),c=r.split("-")[1],_=o.attr("userfullname"),l=n(t).parent().find(".js__mob_del_conv_ids");r.includes("_")&&(a=r.split("_")[1]),l.hasClass("js__isgroup")?messenger.exitGroup(e,escape(l.attr("id")),!1,function(e){s(e)}):i.confirm_act(jprintf(lang.pm_confirm_delete_conversation,_),function(e){var t={cmd:"delConversation",userid:escape(c)};a>0&&(t.page=a),jAjax(i.ajax_url,"post",t).done(function(e){"1"==e?s("success"):(s("cancel"),displayErr(lang.somethingWrong))})},!1,lang.delete_conversation,function(){s("cancel")})},this.toggleConvDetails=function(e,t){t.preventDefault(),(e=n(e)).hasClass("aria-hidden")?(e.removeClass("aria-hidden"),n("#mess-user-details").show().removeClass("__hidden").on(i.crossEvent(),function(){n(this).show()})):(e.addClass("aria-hidden"),n("#mess-user-details").addClass("__hidden").on(i.crossEvent(),function(){n(this).hide()}))},this.crossEvent=function(){var e,t=document.createElement("fakeelement"),s={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(e in s)if(void 0!==t.style[e])return s[e]},this.closeOpenContact=function(){jAjax(i.ajax_url,"post",{cmd:"clear-messages-tick"}).done(function(e){n(".js_messenger_sdata").replaceWith(e)}),i.room_id,i.recipient_fullname,i.recipient_nickname="",i._search_conv_messages=[],i.search_in_conv_curr_id=0,i.attach_page=1,i.page_id=0,i.group_id=0,i.default_color=chat_default_color,i.curr_color=chat_default_color,i.curr_recipient,i.shortcut_id_num,i.shortcut_id,i.more_contacts_page=1,i.loaded_all_contacts=!1,i.messenger_local_stream=!1,i.beforeOpenContact_valid=!1,i.user_not_found=!1,i.user_privacy=0,i.privacy_msg="",i.recipient_user_id=0,i.send_important=0,i.conv_status=200,i.msg_cannot_send=!1,i.replies={},i.pmessenger.removeAttr("id"),n(".pmessenger-messages-list").addClass("empty"),n(".xweeWrt").text(""),n(".pmessenger-messages-list").removeAttr("rel").removeAttr("id"),n("#mess-right-col-userdetails").empty(),n("#pmessenger-contact-header").empty(),n("#mess-right-col-userdetails").empty(),n("#messenger_aria_options").empty(),n(".pmessenger-contact-a").removeClass("active"),createUrl({state:"new"},i.recipient_fullname,"/messenger")},this.show_contacts=function(){i.pmessenger.addClass("show_contacts").removeClass("vy_ms__mob_fscreen"),messenger.disable_touchHolding(),i.closeOpenContact()},this.hide_contacts=function(e){const t=window.event||$.Event();evstop(t);var s=i.pmessenger;n(".pmessenger-contacts-list");i.pmessenger.addClass("vy_ms__mob_fscreen"),i.pmessenger.find("#messenger_mob_new_count").html(0).hide(),s.hasClass("show_contacts")&&s.removeClass("show_contacts")},this.checkUserPrivacy=function(e,t,s,n){localStorage.setItem("ms-last-checked-contact",t>0?"GG"+t:e),jAjax(i.ajax_url,"post",n,!1,"ms-last-open-check-"+e).done(function(e){var t=validateJson(e);s(t)})},this.beforeOpenContact=function(e,t,s,n,a,o,r,c,_,l){let d={cmd:"check_privacy",id:escape(s)};c>0&&(d.group=escape(c));let m=i.ajax_url+"?"+$.param(d);if(_ms_Cache.exist(m))return i.beforeOpenContact_valid=1,i.openContact(e,t,s,n,a,o,r,c,_,l);const u=localStorage.getItem("ms-last-checked-contact"),g=localStorage.getItem("ms-last-contact");i.stop_xhr("ms-last-open-check-"+u),i.stop_xhr("ms-color-"+g),i.stop_xhr("ms-conv-"+g),i.stop_xhr("ms-attach-"+g),i.timeout_attach&&clearTimeout(i.timeout_attach),i.timeout_opencontact&&clearTimeout(i.timeout_opencontact),i.timeout_opencontact=setTimeout(function(){r<=0?i.checkUserPrivacy(s,c,function(d){switch(d.status){case 404:i.user_not_found=1;break;case 403:i.user_privacy=d.privacy}i.privacy_msg=d.msg,i.beforeOpenContact_valid=1,i.conv_status=d.status,i.group_admin=d.group_admin,i.openContact(e,t,s,n,a,o,r,c,_,l),_ms_Cache.set(m,d)},d):i.openContact(e,t,s,n,a,o,r,c,_,l)},300)},this.stop_xhr=function(e){vy_xhr.hasOwnProperty(e)&&vy_xhr[e].abort()},this.removeMessengerLoading=function(){i.pmessenger.find(".js_messenger_load_data").remove()},this.getUserActiveStatus=function(e){$.ajax({url:"https://"+CHAT_NODE_HOST+"/getrespectiveuserstatus",contentType:"application/json",data:JSON.stringify({domain:V_WS_ADDR,user_clean_id:e,userid:socketId(e)}),type:"POST",success:function(t){if(t.length)n(".js_vytimeago_uon_"+e).attr("datetime",iso8601(new Date)),n(".js_vytimeago_2uon_"+e).attr("datetime",iso8601(new Date)),gwtlog._online_user(e);else{gwtlog._offline_user(e),jAjax(i.ajax_url,"post",{cmd:"getuserLastActivity",id:escape(e)}).done(function(t){n(".js_vytimeago_uon_"+e).attr("datetime",t),n(".js_vytimeago_2uon_"+e).attr("datetime",t),n("#contact-"+e).removeData("lastseen").attr("data-lastseen",t),timeago.render(n(".js_vytimeago_uon_"+e)[0],navigator.language.replace("-","_")),timeago.render(n(".js_vytimeago_2uon_"+e)[0],navigator.language.replace("-","_"))})}},error:function(e,t,s){console.log("Error Getting active status: "+s.message)}})},this.openContact=async function(e,t,s,a,o,r,c,_,l,d){if(evstop(t,1),e=n(e),r=e.data("lastseen"),window.location.pathname===n(e).attr("href")&&i.messengerInitiated&&!i.noNewUrl)return;if(!i.beforeOpenContact_valid&&c<=0)return i.beforeOpenContact(e,t,s,a,o,r,c,_,l,d);i.messengerInitiated=!0,i.curr_color=chat_default_color,i.msg_cannot_send=!1,i.beforeOpenContact_valid=!1,i.attach_page=1,i.event=t,i.last_msg_date=!1,i.recipient_picture=a,i.recipient_fullname=o,i.group_id=_,i.recipient_nickname="",i.replies={},c=c>0?c:0,i.page_id=c,i.room_id=generateRoomId(s,_U.i,c,_);var m=n("#pmessenger-messages-cnt > #messages-tick");_>0?n("#pmessenger-messages-cnt").addClass("vy_ms__talkwithgroup"):n("#pmessenger-messages-cnt").removeClass("vy_ms__talkwithgroup");var u=n("#pmessenger-contact-header"),g=(n("#mess-user-details"),n("#mess-right-col-userdetails")),p=n("#messenger_aria_options"),v=n("#messenger_aria_privacy"),h=n("#mess-right-col-group-members"),f=n("#messenger_aria_group_members"),y=n("#mess-right-col-attachments");g.empty(),recipientId=s,i.recipient_user_id=s;var b=n(c?"#contact-"+s+"_"+c:_>0?"#contact-GG"+_:"#contact-"+s);if(i.updateGlobalCount(s,c,_),setTimeout(function(){gwtlog.updateTotalMessages()},50),n("#mess-roomid,#upload_room_id").val(i.room_id),_>0&&n("#vy_ms__is_group_chat").val("GG"+_),_>0&&i.join_group(JSON.stringify({Room_id:socketId(i.room_id),Userid:socketId(_U.i),Userid_clean:_U.i,Group_id_clean:tonum(i.room_id)})),n("#messenger-link-preview").empty(),i.hasTouchStartEvent&&n(".js__smarphones_search").css("display","block"),i.socket=sio,i.setUpVoiceVideoCallButtons(),createUrl({state:"new"},i.recipient_fullname,n(e).attr("href")),i.noNewUrl=!1,localStorage.setItem("ms-last-contact",s),"0"==d&&updateSessionContacts(s),_>0&&updateSessionGroups(_),messenger.close_search(),i.mdialog_hide_loader||m.html('<div class="pmessenger-loading-conv"></div>'),i.mdialog_hide_loader=!1,_>0?i.pmessenger.attr("id","messenger_GG"+_):i.pmessenger.attr("id","messenger_"+s+(c?"_"+c:"")),i.pmessenger.find(".pmessenger-messages-list").removeClass("empty"),i.pmessenger.find(".pmessenger-no-contacts").remove(),i.pmessenger.find(".xweeWrt").text(o),_>0?i.pmessenger.find(".pmessenger-messages-list").attr({rel:"contactid-GG"+_,id:"room_"+i.room_id}):i.pmessenger.find(".pmessenger-messages-list").attr({rel:"contactid-"+s+(c?"_"+c:""),id:"room_"+i.room_id}),c?i.pmessenger.find(".pmessenger-messages-list").removeAttr("class").addClass("pmessenger-messages-list js_chatwithpage js_chat_with_page_"+c):_>0?i.pmessenger.find(".pmessenger-messages-list").removeAttr("class").addClass("pmessenger-messages-list js_chatwithgroup js_chat_with_group_"+_+" js_groupchat_id_"+_):i.pmessenger.find(".pmessenger-messages-list").removeAttr("class").addClass("pmessenger-messages-list"),i.pmessenger.find("#messenger_with_user").val(_>0?"0":s),i.pmessenger.find("#messenger_recipient_name").val(encodeURIComponent(i.recipient_fullname)),i.pmessenger.find("#messenger_recipient_avatar").val(i.recipient_picture),i.pmessenger.find("#messenger_with_page").val(c||"none"),i.pmessenger.find("#messenger_with_group").val(_>0?_:"none"),_>0&&i.pmessenger.find(".js__group_avatar").attr("src",a).attr("id","vy_messenger_group_id_"+_),i.pmessenger.find("#WD_tracks_PM>ul").empty(),i.pmessenger.find("#WD_attach_files_PM").empty(),_>0){y.removeClass("expanded"),v.parent().removeClass("expanded"),f.addClass("js__mess_aria_group_members_"+_),jAjax(i.ajax_url,"post",{cmd:"get-group-members",group:escape(_),action:"all"}).done(function(e){h.removeClass("__none");let t=validateJson(e),s="";if("done"==t.msg){for(var n=0;n<t.users.length;n++){let e=t.users[n];s+='<a id="vy_ms__groupchat_member_online_'+e.id+'" data-timestamp="'+e.timestamp+'" onclick="evstop(event,1);'+(e.id==_U.i?"return;":"return messenger.prependContact(this,event,'"+e.avatar+"','"+e.fullname+"','"+e.id+"');")+'" href="/messenger/'+e.id+'" class="'+("yes"==e.online?"":"_offline")+' vy_ms__groupchat_member__rightside js__groupchat_online_member"><div class="vy_ms__gcm01"><img src="'+e.avatar+'" /><i class="ic-online"></i></div><div class="ms_f55ce4"><username class="vy_ms__gcm02"><span class="js__vy_ms__gchatmembernickname">'+decodeURIComponent($.trim(e.nickname)?e.nickname:e.fullname)+"</span>"+("yes"==e.admin?'<span><i title="Administrator" class="glyphicon glyphicon-ok-sign"></i></span>':"")+'</username><div class="ms_groupmemeber_lastseen js__group_user_online_'+e.id+'">'+e.online_text+"</div></div></a>"}f.html(s)}else f.html('<div class="vy_ms__nogroupmembers">'+t.msg+"</div>")}),jAjax(i.ajax_url,"post",{cmd:"get-group-members-count",group:escape(_)}).done(function(e){n(".js__groupchat_total_members").removeClass("__none").text("("+e+")")}),g.html('<div class="xgrWfs">\t\t\t\t<input type="hidden" class="ufullname'+i.room_id+'" value="'+o+'"/>\t\t\t\t<div class="xgr54a"><img src="'+a+'" /></div>\t\t\t<div class="gsgXAfwe2 __groupchat"><div class="xvgg2a">'+o+"</div>\t\t\t</div>\t\t</div>")}else v.parent().addClass("expanded"),h.addClass("__none"),f.empty(),g.html('<div class="xgrWfs">\t\t\t\t<input type="hidden" class="ufullname'+i.room_id+'" value="'+o+'"/>\t\t\t\t<div class="xgr54a"><a href="'+(c?"/vypage/"+c:"/vyuser/"+s)+'" ><img src="'+a+'" /></a></div>\t\t\t<div class="gsgXAfwe2"><a href="'+(c?"/vypage/"+c:"/vyuser/"+s)+'" ><div class="xvgg2a">'+o+"</div>\t\t\t"+("0"==d?'<div class="xvgg3a js_vytimeago_2uon_'+s+" global_user_online global_user_2online_"+s+'">'+r+"</div>":"")+'</a>\t\t\t</div><div class="_3-ne"><div class="_3d85"><div class="_5blh _4-0h soh-s" role="button" tabindex="0">\t\t\t<ul class="user_more_act foh-s">'+(c||_>0?"":'<li><A href="javascript:void(0);" onclick="messenger.contactToBlacklist(event,this);">'+lang.messenger_block_user+"</a></li>")+'<li style="display:none;"><A href="javascript:void(0);" onclick="messenger.hideConversation(event,this);">'+lang.pm_hide_convers+'</a></li>\t\t\t<li><A href="javascript:void(0);" onclick="messenger.deleteConversation(event,this,'+c+');">'+lang.pm_delete_convers+"</a></li>\t\t\t</ul>\t\t\t</div></div></div>\t\t\t\t\t\t\t\t</div>");p.html('<div class="_3szo" onclick="return messenger.search('+s+","+c+","+_+');" tabindex="0"><div class="_3szp"><div class="_6b45">'+i.svgi.js.search+'</div></div><div class="_3szq">'+lang.Messenger_Search_in_conversation+"</div></div>"+(c||_>0&&i.group_admin<=0?"":'<div onclick="messenger.changeColor('+s+","+_+');" class="_3szo" tabindex="0"><div class="_3szp"><div class="_17vc">'+i.svgi.js.change_color+'</div></div><div class="_3szq">'+lang.Messenger_Change_color+"</div></div>")+(c?"":'<div onclick="messenger.setNicknames('+s+",'"+encodeURIComponent(o)+"',"+_+');" class="_3szo"><div class="_3szp"><div class="_5odt">'+i.svgi.js.change_nickname+'</div></div>\t<div class="_3szq">'+lang.Messenger_Edit_nickname+"</div></div>")),v.html((c?"":'<div onclick="messenger.muteContact('+s+","+_+');" class="_3szo _6y4w" role="button" tabindex="0">    <div class="_3szp">        <div class="_6ybz">'+i.default_md_ic(s,_)+'</div>    </div>    <div class="_3szq _6b46">'+lang.Messenger_Notifications+"</div></div>")+(c||_>0?"":'<div class="_3szo _6y4w" role="button" tabindex="0" onclick="messenger.contactToBlacklist(event,this);">    <div class="_3szp">        <div class="_7hu1">'+i.svgi.js.blacklist+'</div>    </div>    <div class="_3szq">'+lang.messenger_block_user+"</div></div>")+'<div class="_3szo _6y4w" role="button" tabindex="0" '+(_>0?'onclick="messenger.exitGroup(event,'+_+');"':'onclick="messenger.deleteConversation(event,this,'+c+');"')+'>    <div class="_3szp">        <div class="_7hu0">'+i.svgi.js.clear_group+'</div>    </div>    <div class="_3szq">'+(_>0?lang.Messenger_Leave_Group:lang.pm_delete_convers)+"</div></div>");var w='<ul class="_fl2">'+(c||_>0?"":'<li><a id="start-audio-chat" onclick="javascript:void(0);" class="_30yy" role="button" aria-expanded="true" data-testid="info_panel_button" href="javascript:void(0);"><div aria-label="'+lang.messenger_start_voice_call+'" title="'+lang.messenger_start_voice_call+'" data-testid="startVoiceCall" style="height: 35px; width: 35px;">'+i.svgi.js.audio_call.replace("%title",lang.messenger_start_voice_call)+'</div></a></li><li><a id="start-video-chat" class="_30yy" role="button" aria-expanded="true" data-testid="info_panel_button" href="javascript:void(0);"><div aria-label="'+lang.messenger_start_video_call+'" title="'+lang.messenger_start_video_call+'" data-testid="startVideoCall" style="height: 35px; width: 35px;">'+i.svgi.js.video_call.replace("%title",lang.messenger_start_video_call)+'</div></a><div class=""></div></li>')+'<li id="mobile_mess_settings"><a onclick="messenger.open_mobile_settings(event,this,'+_+","+c+');" class="_30yy" href="javascript:void(0);"><div style="height: 32px; width: 32px;">'+i.svgi.js.mobile_settings+"</div></a></li>"+(i.hasTouchStartEvent&&c>0?'<li class="vy_ms__mob_fullscreen"><a onclick="messenger.toFullScreen(event);" class="_30yy" role="button" aria-expanded="true" data-testid="info_panel_button" href="javascript:void(0);">\t\t\t\t\t\t\t\t\t\t\t\t\t  <div style="height: 35px; width: 35px;">'+i.svgi.js.mobile.fullscreen+'</div></a>\t\t\t\t\t\t\t\t\t\t\t\t\t\t  <div aria-owns="js_8"></div></li>':"")+'<li><a onclick="messenger.toggleConvDetails(this,event);" class="_30yy" role="button" aria-expanded="true" data-testid="info_panel_button" href="javascript:void(0);">\t\t\t\t\t\t\t\t\t\t\t\t\t  <div style="height: 35px; width: 35px;">'+i.svgi.js.toggle_conversation+'</div></a>\t\t\t\t\t\t\t\t\t\t\t\t\t\t  <div aria-owns="js_8"></div></li>\t\t\t\t\t\t\t\t\t\t  </ul>',k=function(e,t){if(e)return i.colorateStrokes(chat_default_color);let a={cmd:"getChatCurColor",userid:escape(s)};t>0&&(a.group=escape(t)),jAjax(i.ajax_url,"post",a,!1,"ms-color-"+s).done(function(e){i.curr_color=e,n("#mess-curr-color").val(e),i.colorateStrokes(e)})};const j={cmd:"getConversation",userid:escape(s)};c>0&&(j.page=escape(c)),_>0&&(j.group=escape(_));var x=await jAjax(i.ajax_url,"post",j,!1,"ms-conv-"+s,"conversation:"+window.location.pathname);if(x.hasOwnProperty("localcache"))var C=x.data;else C=x;n(".pmessenger-contact-a").removeClass("active"),n(e).addClass("active"),i.curr_recipient=s,setTimeout(function(){i.hide_contacts()},50);_ms_Cache.set("conversation:"+window.location.pathname,C,function(e){e=validateJson(e);var t="";if(i.pmessenger.find("#messenger_page_admin").val(e.page_admin),$.trim(e.nickname)&&(i.recipient_nickname=e.nickname),e.count>0){var l,g,p=!0;c>0&&(i.pmessenger.find("#is_chat_with_page").val(c),i.pmessenger.find("#inphd_page_avatar").attr("src",e.page_avatar)),_>0&&i.pmessenger.find("#messenger_group_nickname").val(e.nickname);for(var v=0;v<e.messages.length;v++){var h=e.messages[v],f='<div title="'+lang.mess_msg_seen+(_>0?" ("+h.count_group_seen+" "+lang.people+")":"")+'" rel="tipsy" id="mess_sent_status" class="messenger_sent_Status mess-message-seen"><img src="'+e.recipient_avatar+'" border="0" /></div>',y='<div title="'+lang.mess_sent_status+'" rel="tipsy" id="mess_sent_status" class="messenger_sent_Status"><i class="glyphicon messenger-sent-ic glyphicon-ok-sign"></i></div>';p=l!=h.from_id;var j=n(".messenger_date_delim:first").text()==h.dateMonth,x=l!==h.lastby||h.date!=g,C=(x=!(h.date===g||j||!x))?'<div id="messenger_date_delim_'+h.dateMonth+'" class="messenger_date_delim">'+h.dateMonth+"</div>":"";let s=h.from_id!=l&&_>0?h.user_fullname:"",a=void 0!==e.messages[v+1]?e.messages[v+1].from_id:0,o=h.from_id!=l&&a!=_U.i&&l!=_U.i?"vy_ms__group_msg_margin":"",r=h.from_id==_U.i?"":'<div class="sticky__txt_pmessenger-user-avatar"><img src="'+h.user_avatar+'" /></div>';t+=C+(h.from_id!=l?'<div data-group-id="'+h.from_id+'" class="vy_ms__groupusermsgs '+o+" "+(h.from_id==_U.i?"me":"")+'">'+r:"")+i.getMessagesMarkup(h,h.from_id==_U.i?"me":"",p,x,h.timestamp,s,h.forwarded)+(a!=h.from_id||0==a?"</div>":""),l=h.from_id,h.from_id,_U.i,g=h.date,n("#vy_ms__lastmsg_timestamp").val(h.timestamp),("no"==h.read||h.seen<=0)&&i.updateMessagesAsRead(h.recipient,h.id,{userid:h.recipient,page_id:c},_)}i.pmessenger.find("#last-message-datetime").val(g);var M=e.count_messages>=messenger_limit?i.prev_messages_btn:"";m.html('<div class="nano"><div class="overthrow nano-content"><div id="messenger-nano-content-fullheight">'+M+t+"</div></div></div>"),m.find(".vyms__isread__yes:last").append(f.replace(/%color/g,n("#mess-curr-color").val())),m.find(".vyms__isread__no").append(y.replace(/%color/g,n("#mess-curr-color").val())),i.startvenobox();var G=i.pmessenger.find(".pmessenger-message-txt:not(._me):last");G.length&&G.attr("id").match(/\d/g).join(""),i.scrollChat(),setTimeout(function(){i.scrollChat()},100)}else m.html('<div class="messenger-no-messages"><div class="messenger-exp">'+e.exp+'</div><div class="messenger-sub">'+e.sub+"</div></div>");var S='<a class="mm_button_back" href="javascript:void(0);"><div class="messenger_mob_new_count" id="messenger_mob_new_count">0</div><div class="messenger-search-arr" onclick="messenger.show_contacts();"><i class="mess-header-ic close"></i></div></a>';if(_>0)if(e.group_admin>0&&!i.hasTouchStartEvent){let e=i.svgi.js.group_admin_dropdown;u.html(S+'<div class="fj4232xY"><div class="fj424xY"><a href="javascript:void(0);" onclick="messenger.openGroupAdmin(event,this,'+_+');" class="vy_ms__group_admin_clickable">\t\t\t\t\t\t\t\t<div class="xveRafa"><img src="'+a+'" /></div>\t\t\t\t\t\t\t\t<div class="tr4565Saew">\t\t\t\t\t\t\t\t<div class="xweeWrt ellip">'+o.split(" ")[0]+'<div class="vy_ms__group_admin_dropdown">'+e+'</div></div>\t\t\t\t\t\t\t\t<div class="mshortcut-u-last-active js__group_chat_stats" id="groupchat_header_stats_GG'+_+'"><div class="__none js__group_chat_typing"><div class="vy__js__typingingroup"><span class="js__groupstyping_markup"></span> <span class="vy__js__typing_group_usernames"></span></div></div><div class="js__group_chat_stats-inner"><span id="groupchat_total_members_'+_+'" class="groupchat_total_members js__groupchat_total_members"><div class="div-loader"></div></span>&nbsp;<span id="groupchat_online_members_'+_+'" class="groupchat_online_memebers js__groupchat_online_memebers"></span></div></div>\t\t\t\t\t\t\t\t</div></a></div>'+w+"</div>")}else u.html(S+'<div class="fj4232xY"><div class="fj424xY"><a href="javascript:void(0);" class="vy_ms__group_admin_clickable _notadmin">\t\t\t\t\t\t\t\t<div class="xveRafa"><img src="'+a+'" /></div>\t\t\t\t\t\t\t\t<div class="tr4565Saew">\t\t\t\t\t\t\t\t<div class="xweeWrt ellip">'+o.split(" ")[0]+'</div>\t\t\t\t\t\t\t\t<div class="mshortcut-u-last-active js__group_chat_stats" id="groupchat_header_stats_GG'+_+'"><div class="__none js__group_chat_typing"><div class="vy__js__typingingroup"><span class="js__groupstyping_markup"></span> <span class="vy__js__typing_group_usernames"></span></div></div><div class="js__group_chat_stats-inner"><span id="groupchat_total_members_'+_+'" class="groupchat_total_members js__groupchat_total_members"><div class="div-loader"></div></span>&nbsp;<span id="groupchat_online_members_'+_+'" class="groupchat_online_memebers js__groupchat_online_memebers"></span></div></div>\t\t\t\t\t\t\t\t</div></a></div>'+w+"</div>");else u.html(S+'<div class="fj4232xY"><div class="flex3224">\t\t\t\t\t\t\t\t<a href="'+(c?"/vypage/"+c:"/vyuser/"+s)+'" ><div class="xveRafa"><img src="'+a+'" /></div>\t\t\t\t\t\t\t\t<div class="tr4565Saew">\t\t\t\t\t\t\t\t<div class="xweeWrt ellip">'+(i.recipient_nickname?i.recipient_nickname:o.split(" ")[0])+"</div>\t\t\t\t\t\t\t\t"+("0"==d?'<div datetime="'+r+'" timeago-id="'+s+'" class="gre45af js_vytimeago_uon_'+s+" global_user_online global_user_online_"+s+'">'+r+"</div>":"")+"\t\t\t\t\t\t\t\t</a></div></div>"+w+"</div>");var T=i.pmessenger.find(".pmessenger-msg-list-contenteditable");if(!i.emojiarea_created){let e=40,t='<button title="'+lang.send+'" class="_mob_send_messages">'+i.svgi.js.mob_btn_send.replace(/%size/g,e)+"</button>";i.pmessenger.find(".pmessenger-msg-list-contenteditable").html(t+'<textarea id="messenger-send-contenteditable" style="display:none;" class="js_messenger-send-contenteditable"></textarea>'),i.text_val=i.pmessenger.find(".js_messenger-send-contenteditable").emojioneArea({autoHideFilters:!0,searchPosition:"bottom",searchPlaceholder:lang.search,autocomplete:!1,search:!0,hidePickerOnBlur:!0,textcomplete:{maxCount:15,placement:"absleft"},attributes:{dir:"ltr",spellcheck:!1,autocomplete:"on",autocorrect:"on",autocapitalize:i.hasTouchStartEvent?"on":"off"}}),i.text_val[0].emojioneArea.on("ready",function(e,t){k(c,i.group_id),i.contenteditable=T.find("[contenteditable]"),i.removeMessengerLoading(),i.Typing_timeoutFunction=function(){let e=i.pmessenger.find("#messenger_group_nickname").val();$.trim(e)||VY_USER_FN,i.typing_now=0,i.group_id>0?i.socket.emit("vy_ms__groups_typing",JSON.stringify({Typing:"no",Room:i.room_id,Recipient_fn:$.trim(e)?e:VY_USER_FN,Recipient:_U.i,Group:socketId(i.room_id)})):i.socket.emit("typing",JSON.stringify({Typing:"no",Room:i.room_id,Page_id:i.page_id,Recipient:i.page_id>0?_U.i+"_"+i.page_id:_U.i,Userid:socketId(i.curr_recipient)}))},i.hasTouchStartEvent&&i.initTouchEvents(),n(document).off("touchend.sendmessage click.sendmessage").on("touchend.sendmessage  click.sendmessage","._mob_send_messages",function(e){evstop(e,1),messenger.send(i.contenteditable,e),setTimeout(function(){i.drafts[i.group_id>0?"GG"+i.group_id:i.page_id>0?i.page_id+"_"+i.curr_recipient:i.curr_recipient]=i.contenteditable.data("emojioneArea").getText()},500)}),i.contenteditable.off("keydown.mess_send").on("keydown.mess_send",function(e){evstop(e);let t=this;if(is_smartphone()){if(13==e.keyCode){if(window.getSelection){var s=window.getSelection(),a=s.getRangeAt(0),o=document.createElement("br");return a.deleteContents(),a.insertNode(o),a.collapse(!1),s.removeAllRanges(),s.addRange(a),!1}return!1}}else if(setTimeout(function(){i.drafts[i.group_id>0?"GG"+i.group_id:i.page_id>0?i.page_id+"_"+i.curr_recipient:i.curr_recipient]=void 0!==n(t).data("emojioneArea")?n(t).data("emojioneArea").getText():""},500),13==e.keyCode&&0==e.shiftKey&&!is_smartphone())return messenger.send(this,e)}).off("paste").on("paste",function(e){setTimeout(function(){i.drafts[i.group_id>0?"GG"+i.group_id:i.page_id>0?i.page_id+"_"+i.curr_recipient:i.curr_recipient]=i.text_val.data("emojioneArea").getText()},200),i.pasteMessages(this,e,c,i.group_id)}),i.contenteditable.off("keypress.mess_typing").on("keypress.mess_typing",function(e){evstop(e);let t=i.pmessenger.find("#messenger_group_nickname").val();i.typing_now||(clearTimeout(i.timeout_typing),i.group_id>0?i.socket.emit("vy_ms__groups_typing",JSON.stringify({Typing:"yes",Room:i.room_id,Recipient_fn:$.trim(t)?t:VY_USER_FN,Recipient:_U.i,Group:socketId(i.room_id)})):i.socket.emit("typing",JSON.stringify({Typing:"yes",Room:i.room_id,Recipient:i.page_id>0?_U.i+"_"+i.page_id:_U.i,Page_id:i.page_id,Userid:socketId(i.curr_recipient)})),i.typing_now=1)}),i.contenteditable.off("keyup.mess_typing").on("keyup.mess_typing",function(e){clearTimeout(i.timeout_typing),i.timeout_typing=setTimeout(i.Typing_timeoutFunction,1200)}),i.contenteditable.attr("placeholder",lang.pm_emoji_placeholder+"..."),n(".ms_items_more_wrap").addClass("__none"),n(".comments_attach_trigger_ic").click(),T.append(i.get_bottom_mess_buttons(!1,!1,c,_)),setTimeout(function(){T.find("#messenger-recording-button").trigger("click")},1e3),i.contenteditable.off("focus").on("focus",function(e){clearTimeout(i.mobile_btn_timeout),i.hasTouchStartEvent&&(i.pmessenger.find(".js__4rv4").hide(),i.pmessenger.find("._mob_send_messages").show(),i.pmessenger.find("#messages-tick").addClass("__disabled_layer"),setTimeout(function(){var e=i.pmessenger.find("#messages-tick .nano");i.reply_enabled||e.nanoScroller({scroll:"bottom"})},"_ios"==getMobileOperatingSystem()?500:1e3),i.html.hasClass("vy_ms__focused")||(i.mob_focus_timeout=setTimeout(function(){i.contenteditable.focusEnd(),i.html.addClass("vy_ms__focused")},10)))}).off("blur").on("blur",function(){i.hasTouchStartEvent&&(clearTimeout(i.mob_focus_timeout),i.mobile_btn_timeout=setTimeout(function(){i.html.removeClass("vy_ms__focused"),i.pmessenger.find("._mob_send_messages").hide(),i.pmessenger.find(".js__4rv4").show(),i.pmessenger.find("#messages-tick").removeClass("__disabled_layer"),i.contenteditable.removeAttr("style")},10))})}).off("click").on("click",function(e,t){n(t.target).closest(".pmessenger-msg-list-contenteditable").find(".js_messenger-send-contenteditable")[0].emojioneArea.hidePicker()}).off("emojibtn.click").on("emojibtn.click",function(e,t){setTimeout(function(){i.drafts[i.group_id>0?"GG"+i.group_id:i.page_id>0?i.page_id+"_"+i.curr_recipient:i.curr_recipient]="undefined"!=i.text_val.data("emojioneArea")?i.text_val.data("emojioneArea").getText():""},200)}),i.emojiarea_created=!0}if(i.drafts.hasOwnProperty(i.group_id>0?"GG"+i.group_id:i.page_id>0?i.page_id+"_"+i.curr_recipient:i.curr_recipient)?i.text_val.data("emojioneArea").setText(i.drafts[i.group_id>0?"GG"+i.group_id:i.page_id>0?i.page_id+"_"+i.curr_recipient:i.curr_recipient]):i.text_val.data("emojioneArea").setText(""),void 0!==i.contenteditable&&i.contenteditable.focusEnd(),c<=0?T.find(".js__4rv4").replaceWith(i.get_bottom_mess_buttons()):T.find(".js__4rv4").replaceWith(i.get_bottom_mess_buttons(!1,!1,c)),i.hasTouchStartEvent||(i.timeout_attach=setTimeout(function(){i.getAttachments(s)},i.attach_draft.hasOwnProperty(s)?500:3e3)),setTimeout(function(){T.find("#messenger-recording-button").trigger("click")},1e3),k(c,_),nanoScrollStart(),i.pmessenger.find("#messages-tick .nano").off("scrolltop.a"+i.randId).on("scrolltop.a"+i.randId,function(e){evstop(e,1),i.pmessenger.find('[uid="mdialog_prev_btn_ld"]').trigger("click")}),i.pmessenger.find("#mess-user-details.nano").off("scrollend.b"+i.randId).on("scrollend.b"+i.randId,function(e){evstop(e,1),i.load_more_attachments(e,s)}),i.pmessenger.find("#messenger-contacts-last.nano").off("scrollend.c"+i.randId).on("scrollend.c"+i.randId,function(e){evstop(e,1),i.pmessenger.find(".messenger-load-more-contacts-loader>a").trigger("click")}),b.removeClass("_newmessages").find(".convo__unread.in_messenger").remove(),1==e.blacklist?i.isInBlackList():i.removeBlacklist(),i.user_not_found||i.user_privacy>0&&200!=i.conv_status)return i.msg_cannot_send=1,i.privacy_html(i.privacy_msg);i.lazyLoad(),i.join_rooms()}),i.updateSeenInCacheMessages({page_id:c,group_id:_,user_id:s}),i.hasTouchStartEvent||i.enable_reactions(),(c<=0||!c)&&(_<=0||!_)&&i.getUserActiveStatus(s)},this.mob_message_options_markup=function(e){let t={},s="",n=localStorage.getItem("vy_ms__mob_clipboardtxt"),a="ccp_"+i.random_id();for(var o in t.reply='<li data-reply="'+e+'" onclick="messenger.reply(this,event);messenger.closeMessageOptions_MOB();" class="vy_ms_mob_msg_option"><div class="vy_ms_mob_msg_optionic">'+i.svgi.js.reply+'</div><div class="vy_ms_mob_msg_optiontxt">'+lang.Messenger_reply+"</div></li>",t.forward='<li data-forward="'+e+'" onclick="messenger.forward(this,event);" class="vy_ms_mob_msg_option"><div class="vy_ms_mob_msg_optionic">'+i.svgi.js.forward+'</div><div class="vy_ms_mob_msg_optiontxt">'+lang.Messenger_forward+"</div></li>",t.copy='<li data-clipboard-text="'+n+'" onclick="messenger.mob_copy_message(event,\''+a+"');\" touchend=\"messenger.mob_copy_message(event,'"+a+'\');" class="vy_ms_mob_msg_option '+a+'"><div class="vy_ms_mob_msg_optionic">'+i.svgi.js.copy+'</div><div class="vy_ms_mob_msg_optiontxt">'+lang.Messenger_mob_copy_msg+"</div></li>",t.remove='<li uid="mob-delete-message" class="vy_ms_mob_msg_option"><div class="vy_ms_mob_msg_optionic">'+i.svgi.js.remove_message+'</div><div class="vy_ms_mob_msg_optiontxt">'+lang.Messenger_remove_message+"</div></li>",t)s+=t[o];return`<ul id="vy_ms_mob_message_options_menu">${s}</ul>`},this.closeMessageOptions_MOB=function(){n("#vy_ms_mob_message_options_menu").remove()},this.mob_copy_message=function(e,t){let s=new ClipboardJS("."+t);s.on("success",function(e){localStorage.removeItem("vy_ms__mob_clipboardtxt"),e.clearSelection()}),s.on("error",function(e){})},this.touch_open_message_options=function(e,t){evstop(e,1),t=n(t);let s=n(t).closest(".pmessenger-message-txt"),a="#vy_ms_mob_message_options_menu",o=".js__pmessenger_footer",r=tonum(s.attr("id"));n(o).parent().find(a).remove(),n(a).length||(n(o).before(i.mob_message_options_markup(r)),n(o).parent().find('[uid="mob-delete-message"]').off("click.delete_message_mob touchend.delete_message_mob").on("click.delete_message_mob touchend.delete_message_mob",function(e){i.delete_message(s.find('[uid="delMsg"]'),e)}),i.mob_enable_reactions(s.find('[data-react="1"]')),n(t).parent().is(":last-child")&&n("#messages-tick .nano").nanoScroller({scroll:"bottom"})),n(document).off("click.removeMessageOptions").on("click.removeMessageOptions",function(e){evstop(e,1),i.closeMessageOptions_MOB()})},this.delete_messages_by_touch_holding=function(){n(document).off("touchend.showMessageTime").on("touchend.showMessageTime",".messenger_text_col",function(e){n(this).hasClass("touch-hover-time")?(n(this).parent().find(".d_comment_time").slideUp("fast","linear",function(){n(this).parent().removeAttr("style")}),n(this).removeClass("touch-hover-time")):(n(".pmessenger .d_comment_r").each(function(){n(".touch-hover-time").removeClass("touch-hover-time"),n(this).find(".d_comment_time").slideUp("fast","linear",function(){n(this).parent().removeAttr("style")})}),n(this).parent().find(".d_comment_r").css({opacity:"1",visibility:"visible",display:"inline"}),n(this).parent().find(".d_comment_time").slideDown("fast","linear"),n(this).addClass("touch-hover-time"))}),n(document).off("touchstart.deleteMessage").on("touchstart.deleteMessage",".messenger_text_col",function(e){var t=this;i.holding_touch_timer=setTimeout(function(){i.clear_selection(),function(e,t){localStorage.setItem("noLightGallery",1),localStorage.setItem("vy_ms__mob_clipboardtxt",n(e).parent().find(".txt_pmessenger-text").text()),i.enable_copytoclipboard_mob_btn=!0,i.touch_open_message_options(t,e)}(t,e)},600)}),n(document).off("touchend.deleteMessage").on("touchend.deleteMessage",".messenger_text_col",function(e){i.holding_touch_timer&&clearTimeout(i.holding_touch_timer),setTimeout(function(){i.enable_selection()},900),localStorage.removeItem("noLightGallery",1)})},this.initTouchEvents=function(){let e=new EventHandlerClass;n(document).off("touchend.removeDisabled").on("touchend.removeDisabled","#messages-tick",function(e){setTimeout(function(){n(this).removeClass("__disabled_layer")},100)});Swiped.init({query:".js_conv_swipe:not(._touchevent_binded)",right:5e3,tolerance:5e3,onPrompt:function(e,t,s){i.swipeDeleteConv(event,s,function(e){"cancel"==e?t.close():(t.open(),n(s).parent().slideUp(function(){n(s).remove()}))})},onOpen:function(){this.destroy(!0)},onClose:function(){}});e.addEventListener("touchmove.messenger",function(){i.disable_touchHolding(),localStorage.setItem("noLightGallery",1),i.holding_touch_timer&&clearTimeout(i.holding_touch_timer)},{passive:!1}),e.addEventListener("touchend.messenger",function(){setTimeout(function(){i.enable_touchHolding(),localStorage.removeItem("noLightGallery",1)},400)},{passive:!1}),i.delete_messages_by_touch_holding()},this.swipeMsgToReply=function(){Swiped.init({query:".txt_pmessenger-text:not(._touchevent_binded)",right:5e3,tolerance:-2e4,onPrompt:function(e,t,s){!function(e,t,s){s("cancel"),n(t).closest(".pmessenger-message-txt").find('[uid="reply"]').trigger("click")}(event,s,function(e){"cancel"==e&&t.close()})},onOpen:function(){this.destroy(!0)},onClose:function(){}})},this.enable_touchHolding=function(){i.delete_messages_by_touch_holding()},this.disable_touchHolding=function(){const e=new EventHandlerClass;n(document).off("touchend.deleteMessage touchend.deleteMessage touchend.showMessageTime"),e.removeEventListener("touchmove.messenger"),e.removeEventListener("touchend.messenger")},this.enable_selection=function(e){n("html").removeClass("disable_select")},this.disable_selection=function(e){n("html").addClass("disable_select")},this.clear_selection=function(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},this.load_more_attachments=function(e,t){return evstop(e,1),++i.attach_page,i.getAttachments(t,i.attach_page)},this.mdialog_load_prev_messages=function(e,t){e.preventDefault(),i.shortcut?mess_shortcut(i.shortcut_id).mdialog_load_older_msgs(i.shortcut_id):i.mdialog_load_older_msgs()},this.mdialog_load_older_msgs=function(e){var t,s,a,o="",r="";e&&e.includes("_")?(a=tonum(e.split("_")[0]),o="&page="+(t=e.split("_")[1])):!e&&n(".pmessenger .js_chatwithpage").length?(a=n("#messenger_with_user").val(),o="&page="+(t=n("#messenger_with_page").val())):!e&&n(".pmessenger .js_chatwithgroup").length?r="&group="+(s=n("#messenger_with_group").val()):e&&e.includes("GG")&&(r="&group="+(s=tonum(e.split("GG")[1])));var c=i.shortcut_id?i.shortcut.find("#id-prev-comm-link-w-msg-chat"):n("#id-prev-comm-link-w-msg"),_=i.shortcut_id?i.shortcut.find(".pmessenger-message-txt:first").attr("id"):i.pmessenger.find(".pmessenger-message-txt:first").attr("id"),l=i.shortcut_id?i.shortcut.find("#"+_):i.pmessenger.find("#"+_);if(!c.hasClass("in-progress")&&c.length){c.addClass("in-progress");var d,m={cmd:"previous-messages"};m.userid=t?escape(a):s?escape(s):escape(recipientId),m.view_as="json",o&&(m.page=t),r&&(m.group=s),e?(d=i.shortcut.find("#current_page").val(),i.shortcut.find("#current_page").val(parseInt(d)+1),d++):(i.msg_page.hasOwnProperty($.param(m))||(i.msg_page[$.param(m)]=1),++i.msg_page[$.param(m)],d=i.msg_page[$.param(m)]),m.pagecount=escape(d),jAjax(i.ajax_url,"post",m).done(function(e){var a=validateJson(e);if(c.removeClass("in-progress"),"1"==a.exp)c.parent().remove();else{var o,r,_="",d=!0;let e=new Array;for(var m=0;m<a.length;m++){d=o!=a[m].lastby;var u=(i.shortcut_id?i.shortcut.find(".messenger_date_delim:first").text():n(".pmessenger .messenger_date_delim:first").text())==a[m].dateMonth,g=o!==a[m].lastby||a[m].date!=r;let t=(g=!(a[m].date===r||u||!g))?'<div id="messenger_date_delim_'+a[m].dateMonth+'" class="messenger_date_delim">'+a[m].dateMonth+"</div>":"",c=a[m].from_id!=o&&s>0?a[m].user_fullname:"",l=void 0!==a[m+1]?a[m+1].from_id:0,p=a[m].from_id==_U.i?"":'<div class="sticky__txt_pmessenger-user-avatar"><img src="'+a[m].user_avatar+'" /></div>',v=a[m].from_id!=o&&l!=_U.i&&o!=_U.i?"vy_ms__group_msg_margin":"";_+=t+(a[m].from_id!=o?'<div data-group-id="'+a[m].from_id+'" class="vy_ms__groupusermsgs '+v+" "+(a[m].from_id==_U.i?"me":"")+'">'+p:"")+i.getMessagesMarkup(a[m],a[m].from_id==_U.i?"me":"",d,g,a[m].timestamp,c,a[m].forwarded)+(l!=a[m].from_id||0==l?"</div>":""),o=a[m].lastby,r=a[m].date,e.push(a[m])}i.shortcut_id?i.shortcut.find(".messenger_older_msg_div").after(_):n(".pmessenger .messenger_older_msg_div").after(_),i.colorateStrokes(i.current_color(),i.shortcut_id),i.startvenobox(),nanoScrollStart();let c="conversation:/messenger/"+(t>0?recipientId+"/"+t:s>0?"g/"+s:recipientId),p=e.length;for(;p--;)i.updateConversationCache(e[p],c,!0);i.shortcut_id?i.shortcut.find(".messenger-shortcut-messages .nano").nanoScroller({scrollTop:l.position().top-50}):n("#pmessenger-messages-cnt .nano").nanoScroller({scrollTop:l.position().top-50})}})}},this.send=async function(e,t,s,a,o,r,c,_,l,d){t=t||$.Event(),evstop(t,1);let m=!1,u=!1,g=!1;if(d&&d.hasOwnProperty("forward")&&"yes"==d.forward&&("no"==d.group?g=d.userid:u=d.group,m=!0),!i.uploadingMedia&&1!=i.msg_cannot_send||i.send_important){i.pmessenger.length&&i.pmessenger.find(".js_chatwithpage").length&&!c&&(o=n("#messenger_with_page").val(),a=a||escape(i.curr_recipient)),i.pmessenger.length&&i.group_id>0&&!c&&(r=i.pmessenger.find("#messenger_with_group").val(),i.curr_recipient=r);i.shortcut?i.shortcut.find(".jb_attached_files._tchat#tchat_"+i.shortcut_id_num).children():n(".jb_attached_files.__messages").children(),i.shortcut?i.shortcut.find("#WD_tracks_tchat_"+i.shortcut_id_num+" > ul"):n("#WD_tracks_PM>ul"),n(e);var p=s||(i.shortcut?i.shortcut.find(".js-shortcut-contenteditable").data("emojioneArea").getText():n("#messenger-send-contenteditable").data("emojioneArea").getText());if(recipientId=a||recipientId,i.stop_xhr("fetch-url"),s||(i.shortcut?i.shortcut.find("[contenteditable]").empty():i.contenteditable.empty()),c&&(r=0,o=0),$.trim(p)){if(!recipientId)return setTimeout(function(){displayErr(lang.somethingWrong),window.location.reload(1)},3e3),displayErr(lang.pm_no_recipient);{i.sending_Message=!0,i.send_msg_sound(),i.msg_with_preview&&"object"==typeof i.msg_with_preview&&void 0!==i.msg_with_preview.id&&void 0!==i.msg_with_preview.msg&&(p+=i.msg_with_preview.msg,this.remove_attach(!1,!1,i.msg_with_preview.id),i.msg_with_preview=!1,"undefined"!=typeof messenger_shortcut&&(messenger_shortcut.msg_with_preview=!1));var v=o||c?escape(a):escape(i.curr_recipient),h=v+"__"+i.random_id(),f={msg:{},user:{}},y=i.random_id(),b=new Date;let e=b.getMinutes()>=10?b.getMinutes():"0"+b.getMinutes();f.msg.id=y,f.msg.msgid=y,f.msg.text=p,f.msg.min_text=p,f.msg.page_id=o||0,f.msg.group_id=r||0,f.msg.rd="no",f.msg.read="no",f.msg.seen="0",f.msg.bg=l?"yes":s&&!i.force_bg||_?"no":"yes",f.msg.time=b.getHours()+":"+e,f.msg.timestamp=(new Date).getTime(),f.msg.curr_date=(new Date).getDate(),f.msg.count=1,f.msg.recipient=v,f.msg.forwarded=m?"yes":"no",f.msg.reply=null,f.user.group=r||0,f.user.socketid=socketId(),f.user.id=_U.i,f.user.fullname=_U.fn,f.user.avatar=_U.p,f.user.online_ago=1,f.user.online=1,o&&(f.user.page=o,f.user.page_admin="no",i.shortcut&&"yes"==i.shortcut.find("#messenger_page_admin").val()?(f.user.avatar=i.shortcut.find("#inphd_page_avatar").attr("src"),f.user.page_admin="yes"):"yes"==i.pmessenger.find("#messenger_page_admin").val()&&(f.user.avatar=i.pmessenger.find("#inphd_page_avatar").attr("src"),f.user.page_admin="yes"),i.shortcut?f.user.page_name=i.shortcut.find(".ufullname"+v+"_"+o).val():i.pmessenger.length&&!i.shortcut&&(f.user.page_name=i.pmessenger.find("#messenger_recipient_name").val())),r&&(i.shortcut?(f.user.group_avatar=i.shortcut.find(".js__group_avatar").attr("src"),f.user.group_name=i.shortcut.find(".ufullnameGG"+r).val()):i.pmessenger.length&&!i.shortcut&&(m?(f.user.group_avatar=d.group_data.avatar,f.user.group_name=d.group_data.group_name):(f.user.group_avatar=i.pmessenger.find(".js__group_avatar").attr("src"),f.user.group_name=i.pmessenger.find("#messenger_recipient_name").val())));let t=o||c?escape(a):escape(i.curr_recipient),k=0;i.replies.hasOwnProperty(t)&&(k=i.replies[t],delete i.replies[t],i.close_reply(),i.reply_enabled=0,await jAjax(i.ajax_url,"post",{cmd:"get-reply-details",id:escape(k)}).done(function(e){f.msg.reply=e})),clearTimeout(i.timeout_typing),i.Typing_timeoutFunction(),i.pmessenger.length&&!i.shortcut?i.pmessenger.find(".js__vy_ms__group_cleared").remove():i.shortcut.find(".js__vy_ms__group_cleared").remove(),setTimeout(function(){r>0?i.socket.emit("vy_ms__group_message",JSON.stringify({Group_id:socketId("GG"+r),From:socketId(_U.i),Data:f,Hash:h})):i.socket.emit("vy_new_message",JSON.stringify({Userid:socketId(v),From:_U.i,Data:f,Hash:h}))},10),(!m||m&&!u&&i.curr_recipient==g||u>0&&n("#messenger_with_group").val()==u)&&await i.appendSendedMessages(f,s,o,r);let j={};j.id=y,j.cmd="sendMessage",j.bg=l?"yes":s&&!i.force_bg?"no":"yes",j.text=p,j.view_as="json",j.userid=t,j.forwarded=m?"yes":"no",j.reply=k,o&&(j.page=escape(o)),r>0&&(j.group=escape(r));var w=jAjax(i.ajax_url,"post",j);i.force_bg=!1,w.done(function(e){i.uploading_media_disable_func("disable",i.shortcut_id_num,o,r),i.send_important=0,i.sending_Message=!1;var t=validateJson(e);if("blacklist"===t.response)i.isInBlackList();else{if("success"!==t.response)return"success"!==t.response?displayErr(t.response):displayErr(lang.pm_error_deliv);{i.updateSendedMessage(t);let e="conversation:/messenger/"+(o>0?v+"/"+o:r>0?"g/"+r:v);i.updateConversationCache(t.cache_message,e)}}})}}else i.shortcut?i.shortcut.find("[contenteditable]"):i.contenteditable.addClass("_emoji-empty-focus")}},this.updateSendedMessage=function(e){var t=e.msg_random_id,s=n("#msg_"+t);s.removeAttr("id").attr({id:"msg_"+e.id,"data-unsettled-msg-id":t,"data-msg-timestamp":e.timestamp}).addClass("vy_ms__needsorted"),s.find(".d_comment_act_del").removeAttr("id").attr({id:"m-id-msg-"+e.id,"data-unsettled-id":t}),s.find("#mess_sent_status>i").removeClass("glyphicon-ok-circle").addClass("glyphicon-ok-sign"),setTimeout(function(){var e=i.shortcut?i.shortcut.find(".pmessenger-message-txt.vy_ms__needsorted"):n(".pmessenger-message-txt.vy_ms__needsorted");e.length&&tinysort(e,{data:"msg-id",order:"asc",ignoreDashes:!0}),setTimeout(function(){e.removeClass("vy_ms__needsorted")},1e3)},500)},this.appendSendedMessages=async function(e,t,s,a){var o=n(".mdialog_newdialogmsg"),r=i.shortcut?i.shortcut.find(".pmessenger-message-txt:last"):n(".pmessenger-message-txt:last"),c=e.msg.text.replace(/\\/g,""),_=e.msg.time,l=e.msg.min_text.replace(/\\/g,""),d=e.msg.msgid,m=(e.msg.rd,e.msg.bg),u=e.msg.timestamp,g=e.msg.recipient,p=e.msg.curr_date,v=e.msg.forwarded,h=e.msg.reply;if(c=nl2br(c),s&&n(".js_chat_with_page_"+s).find(".jb_attached_files._tchat").empty(),i.shortcut?i.shortcut.find(".jb_attached_files._tchat#tchat_"+i.shortcut_id_num).empty():n(".jb_attached_files.__messages").empty(),-1!=i.mess_opened_contacts.indexOf(recipientId)||i.shortcut?-1==i.mess_opened_contacts__shortcut.indexOf(recipientId)&&i.shortcut&&(i.mdialog_hide_loader=!0,i.shortcut__appendNewDateTime(p),i.mess_opened_contacts__shortcut.push(recipientId)):(i.mdialog_hide_loader=!0,i.appendNewDateTime(p),i.mess_opened_contacts.push(recipientId)),i.scrollNow=!0,r.hasClass("_me")?this.avatar=!1:this.avatar=!0,i.show_sent_status=!0,i.gl_scrollChatDelay=!!t&&200,i.shortcut||n("#mshortcut-"+i.curr_recipient).length){var f=i.shortcut_id?i.shortcut_id:"mshortcut-"+i.curr_recipient;a>0?await mess_shortcut(f,1).apMessage(d,"_me",_U.i,_U.p,_U.fn,_,c,1,m,this.avatar,!1,!1,u,!1,!1,a,v,h).then(function(){mess_shortcut(f,1).colorateStrokes(i.current_color(),f)}):s?await mess_shortcut(f,1).apMessage(d,"_me",_U.i,_U.p,_U.fn,_,c,1,m,this.avatar,!1,!1,u,!1,s,0,v,h).then(function(){mess_shortcut(f,1).colorateStrokes(i.current_color(),f)}):await mess_shortcut(f,1).apMessage(d,"_me",_U.i,_U.p,_U.fn,_,c,1,m,this.avatar,!1,!1,u,!1,0,0,v,h).then(function(){mess_shortcut(f,1).colorateStrokes(i.current_color(),f)})}n("#messenger_"+i.curr_recipient).length&&"none"==n("#messenger_with_page").val()&&"none"==n("#messenger_with_group").val()?(i.appendMessageInContacts(l,g,u,_,"me"),await messenger.apMessage(d,"_me",_U.i,_U.p,_U.fn,_,c,1,m,this.avatar,!1,!1,u,!1,0,0,v,h).then(function(){i.colorateStrokes(i.current_color())})):s&&n("#messenger_"+i.curr_recipient+"_"+s).length?(i.appendMessageInContacts(l,g,u,_,"me",!1,!1,s),await messenger.apMessage(d,"_me",_U.i,_U.p,_U.fn,_,c,1,m,this.avatar,!1,!1,u,!1,s,0,v,h).then(function(){i.colorateStrokes(i.current_color())})):a>0&&n("#messenger_GG"+a).length&&(i.appendMessageInContacts(l,g,u,_,"me",!1,!1,!1,a),await messenger.apMessage(d,"_me",_U.i,_U.p,_U.fn,_,c,1,m,this.avatar,!1,!1,u,!1,!1,a,v,h).then(function(){i.colorateStrokes(i.current_color())})),0!=o.length&&o.remove()},this.appendNewDateTime=function(e){var t=n(".pmessenger .pmessenger-message-txt:last"),s=n(".pmessenger #last-message-datetime"),a=s.val();let o='<div id="messenger_date_delim_'+lang.today+'" class="messenger_date_delim">'+lang.today+"</div>";e!=a&&s.length&&t.length?(t.after(o),s.remove()):t.length||i.pmessenger.find("#messenger-nano-content-fullheight").append(o)},this.shortcut__appendNewDateTime=function(e){var t=i.shortcut.find(".pmessenger-message-txt:last"),s=i.shortcut.find("#last-message-datetime");e!==s.val()&&s.length&&(t.after('<div id="messenger_date_delim_'+lang.today+'" class="messenger_date_delim">'+lang.today+"</div>"),s.remove())},this.appendMessageInContacts=async function(e,t,s,a,o,r,c,_,l){let d=o;var m=!1;e=e.replace(/&amp;/g,"&"),c=c?'<div class="convo__unread oval in_messenger">+'+c+"</div>":"",o="me"==o?'<span class="convo__msgAuthor">'+lang.You+":</span>&nbsp;":"";var u=n(_>0?"#contact-"+t+"_"+_:l>0?"#contact-GG"+l:"#contact-"+t);i.containsBBCODE(e)&&await i.liveMedia(e,1).then(async function(t){e=t,m=!0}),c&&u.addClass("_newmessages"),u.removeData("last-message-timestamp").removeAttr("last-message-timestamp"),u.attr("data-last-message-timestamp",s),u.find(".pmessenger-contact-last-msg").replaceWith('<div class="pmessenger-contact-last-msg ellip _1htf _6zke"><div class="_42dz5 ellip">'+o+(m?e:e.substring(0,22)+(e.length>22?"...":""))+'</div><div class="pmessenger-contact-last-msg-time"><div class="_6zkf">&#8729;</div><span class="_1ht7 _6zkh timestamp">'+a+"</span></div></div>"),u.find(".pmessenger-contact-last-msg-time .timestamp").text(a),u.find(".convo__unread.in_messenger").length?u.find(".convo__unread.in_messenger").replaceWith(c):u.find(".pmessenger-contact-info").append(c),u.find("._3fx44cc").length||"me"!=d?u.find("._3fx44cc").length&&"me"==d?u.find("._3fx44cc").replaceWith('<div class="_3fx44cc"><div class="contact-messenger_sent_Status"><i class="glyphicon contact-messenger-sent-ic glyphicon-ok-sign"></i></div></div>'):u.find("._3fx44cc").remove():u.find(".pmessenger-contact-last-msg").after('<div class="_3fx44cc"><div class="contact-messenger_sent_Status"><i class="glyphicon contact-messenger-sent-ic glyphicon-ok-sign"></i></div></div>'),!r&&u.parent().index()>0&&i.sortContacts(),vy_ms__window_tab_active||u.hasClass("active")||i.messengerFocusWindow(!1,_,l)},this.message_report=function(e,t){e.preventDefault();var s=n(t),a=s.attr("id").split("-"),o=a[a.length-1],r=0!=s.closest("#msg_"+o).find(".mdialog_atch_items_container").length?"":s.closest("#msg_"+o).find(".txt_pmessenger-text").html();confirm_act(lang.pm_report_confirm+'<br/><div class="c_mdialog_sm_mg ellip">'+r+"</div>",function(e){jAjax(i.ajax_url,"post","cmd=spam&id="+escape(o)+"&view_as=json").done(function(e){if("1"!==e)return displayErr(e);s.closest("#msg_"+o).find(".txt_pmessenger-text").html("<i>"+lang.pm_reported_msg+"</i>"),s.closest("#msg_"+o).addClass("deleted_pm")})})},this.sortContacts=function(){let e=n("#messenger-contacts-last").find(".pmessenger-contact-a"),t=e[0].offsetHeight;e[0].style.height=e[0].offsetHeight+"px";for(var s=0,i=e.length;s<i;s++){let n=e[s];n.style.position="absolute",n.style.width="100%",n.style.top=s*t+"px"}tinysort(n("#messenger-contacts-last").find(".pmessenger-contact-a"),{data:"last-message-timestamp",order:"desc",ignoreDashes:!0}).forEach(function(s,i){setTimeout(function(e,s){e.style.top=s*t+"px"}.bind(null,s,i),140),setTimeout(function(){!function(){for(var t=0,s=e.length;t<s;t++){let s=e[t];n(s).removeAttr("style")}}()},1500)})},this.checkGroupAdmin=function(e){let t=0;for(var s=0;s<vy_ms__mygroups.length;s++)e==vy_ms__mygroups[s].id&&vy_ms__mygroups[s].a>0&&(t=1);return t},this.deleteMessageFromCacheConversation=function(e){let t="conversation:"+window.location.pathname;if(_ms_Cache.exist(t)){const n=validateJson(_ms_Cache.get(t));for(var s=0;s<n.messages.length;s++)n.messages[s].id==e.msg_id&&n.messages.splice(s,1);_ms_Cache.set(t,JSON.stringify(n))}},this.updateSeenInCacheMessages=function(e){let t="conversation:/messenger/"+(e.page_id>0?e.user_id+"/"+e.page_id:e.group_id>0?"g/"+e.group_id:e.user_id);if(_ms_Cache.exist(t)){const e=validateJson(_ms_Cache.get(t));for(var s=0;s<e.messages.length;s++)e.messages[s].seen<=0&&"no"==e.messages[s].read&&(e.messages[s].seen=(new Date).getTime(),e.messages[s].read="yes");_ms_Cache.set(t,JSON.stringify(e))}},this.delete_message=function(e,t,s,a,o){evstop(t,1);var r=n(e),c=r.attr("id").split("-"),_=c[c.length-1],l=r.closest("[data-unsettled-msg-id]").data("unsettled-msg-id"),d=(0!=r.closest("#msg_"+_).find(".mdialog_atch_items_container").length||r.closest("#msg_"+_).find(".txt_pmessenger-text").html(),!!r.closest("#msg_"+_).hasClass("_me"));s>0&&i.checkGroupAdmin(s)&&(d=!0),i.confirm_act(lang.Messenger_delete_message_select_option,function(e){let t={cmd:"delete"};t.id=escape(_),t.msg_unsettled_id=escape(l),t.action=e,t.foreign_msg=r.closest(".pmessenger-message-txt").hasClass("_me")?"from_me":"from_they",s>0&&(t.group=escape(s)),jAjax(i.ajax_url,"post",t).done(function(t){if("1"!==t)return displayErr(t);{let t={msg_id:_,group_id:s,page_id:a,user_id:o};r.closest("#msg_"+_).slideUp(350,function(){r.closest("#msg_"+_).remove(),i.deleteMessageFromCacheConversation(t)}),"everyone"==e&&(s<=0?i.socket.emit("delete_message_for_everyone",JSON.stringify({Msg_Unsettled_id:l,Msg_id:escape(_),Userid:socketId(i.recipient_user_id),Cache_delete_data:t})):i.socket.emit("delete_message_for_everyone_in_group",JSON.stringify({Msg_Unsettled_id:l,Msg_id:escape(_),Userid:s,Group_id:socketId("GG"+s),Cache_delete_data:t})))}})},d)},this.toggleDayNightMode=function(e,t){evstop(t,1),e=n(e),"night"==readCookie("mode")?(createCookie("mode","day"),e.html(i.svgi.js.enable_dark)):(createCookie("mode","night"),e.html(i.svgi.js.disable_dark))},this.mob_enable_reactions=function(e){if(_U.i<=0)return;var t=n(e).closest(".pmessenger-message-txt").find(".messenger_text_col"),s=n(e).data("reaction"),a="";const o=i.reactions;for(var r in o)a+='<a data-reaction=\'{"mob":true,"author":"'+s.author+'","page":"'+s.page+'","group":"'+s.group+'","item":"'+s.item+'","id":"'+s.id+'","reaction":"'+r+'","color":"'+o[r].color+'"}\' onclick="messenger.react(this,event);" class="a-reaction-icon reactions '+o[r].css_class+'"><label>'+o[r].title+"</label></a>";var c='<div class="vy_ms__r"><div class="sc-menu sc-menu-vy-mob __light __lktooltip sc-menu-reactions sc-menu__top __reactions_menu"><div class="reaction-type">'+a+'</div><div class="sc-menu_arw_w"><div class="sc-menu_arw"></div></div></div></div>';if(t.find(".sc-menu").length)return clearTimeout(i.timeouts.close_react);i.timeouts.open_react=setTimeout(function(){t.append(c),n(".a-reaction-icon").each(function(e,t){setTimeout(function(){n(t).addClass("show")},80*e),setTimeout(function(){n(t).addClass("anim")},200*e)})},300),n(document).off("click.MobCloseReactions").on("click.MobCloseReactions",function(e){clearTimeout(i.timeouts.open_react),i.timeouts.close_react=setTimeout(function(){t.find(".vy_ms__r").remove()},200)})},this.enable_reactions=function(){n(document).off("mouseover.vy_ms__react").on("mouseover.vy_ms__react","[data-react]",function(e){if(evstop(e,1),_U.i<=0)return;var t=n(this),s=t.data("reaction"),a="";const o=i.reactions;for(var r in o)a+='<a data-reaction=\'{"author":"'+s.author+'","page":"'+s.page+'","group":"'+s.group+'","item":"'+s.item+'","id":"'+s.id+'","reaction":"'+r+'","color":"'+o[r].color+'"}\' onclick="messenger.react(this,event);" class="a-reaction-icon reactions '+o[r].css_class+'"><label>'+o[r].title+"</label></a>";var c='<div class="vy_ms__r"><div class="sc-menu __light __lktooltip sc-menu-reactions sc-menu__top __reactions_menu"><div class="reaction-type">'+a+'</div><div class="sc-menu_arw_w"><div class="sc-menu_arw"></div></div></div></div>';if(t.find(".sc-menu").length)return clearTimeout(i.timeouts.close_react);i.timeouts.open_react=setTimeout(function(){var e;t.prepend(c),e=t.find(".sc-menu-reactions"),i.isElementInViewport(t.find(".sc-menu-reactions"))?e.addClass("sc-menu__top"):e.removeClass("sc-menu__top"),n(".a-reaction-icon").each(function(e,t){setTimeout(function(){n(t).addClass("show")},80*e),setTimeout(function(){n(t).addClass("anim")},200*e)})},300)}).off("mouseout.vy_ms__react").on("mouseout.vy_ms__react","[data-react]",function(e){var t=n(this);clearTimeout(i.timeouts.open_react),i.timeouts.close_react=setTimeout(function(){t.find(".vy_ms__r").remove()},200)})},this.getReactionsMarkup=function(e,t,s){let n="";if(count=0,reacted=!1,reaction_type="like",e>0&&t.length){for(var a=0;a<t.length;a++)a<=2&&(n+=t[a].itemid==e&&"yes"==t[a].animation?i.reaction_html(t[a].type,1):i.reaction_html(t[a].type,0)),t[a].userid==_U.i&&(reacted=!0,reaction_type=t[a].type);count=t.length}return{html:n,count:count,reacted:reacted,"reaction-type":reaction_type}},this.reaction_html=function(e,t){return'<span class="reaction-message-ic '+(t=t?"reaction__animated reaction__bounce":"")+" js__message_reacted_now notif-type-icon __"+e+'"></span>'},this.react=async function(e,t){if(_U.i<=0)return;let s=(e=n(e)).closest(".vy_ms__reaction_btn"),a=s.parent(),o=(a.find(".js-users-reactions"),s.attr("reaction-type")),r=s.find(".js-count"),c=(a.hasClass("_empty"),parseInt(r.text())),_=e.data("reaction"),l=!!_.hasOwnProperty("mob"),d=_.item,m=_.reaction,u=_.group>0?"yes":"no",g=_.group,p=_.page>0?"yes":"no",v=_.page,h=escape(_.id),f={cmd:"reaction",item:d,id:h,reaction:m,author:escape(_.author)},y=0,b=e.closest(".pmessenger-message-txt"),w=b.find(".message_reactions");b.find(".js__message-reactions-std-ics"),parseInt(w.text()),i.reaction_html(m);l||evstop(t,1),s.hasClass("reacted")&&o==m||s.hasClass("reacted")&&e.hasClass("reaction-parent")?f.action="remove":s.hasClass("reacted")&&o!=m?(y=1,f.action="update",s.removeAttr("reaction-type").attr("reaction-type",m)):(y=1,f.action="add",b.addClass("vy_ms__msg_reacted"),s.removeAttr("reaction-type").attr("reaction-type",m)),s.removeClass("reacted"),y&&setTimeout(function(){s.addClass("reacted")},10),r.text(c),s.find(".sc-menu-reactions").remove();let k={};"yes"==u&&await jAjax(i.ajax_url,"post",{cmd:"get-group-details",group:escape(g)}).done(function(e){k=e}),i.socket.emit("react",JSON.stringify({Remove:!y,To:socketId(i.curr_recipient),Data:{user:_U,msg:{text:""},notif:{categ:"react",reaction:m}},Group_data:validateJson(k),Userid:socketId(_.author),User_clean_id:_.author,From:_U.i,Group_id:socketId("GG"+g),Group_clean_id:g,Group:u,Page_clean_id:v,Page_id:socketId(i.curr_recipient+"_"+v),Page:p,Reaction:m,Msg_id:h}));let j=i.updateReactionsInCache("conversation:"+window.location.pathname,h,{itemid:h,userid:_U.i,type:m,added:(new Date).getTime()},_U.i,!y);const x=i.getReactionMarkup({id:h,reactions:j.reaction_data});b.find(".message-reactions-std").replaceWith(x.markup).find(".reaction__animated").on(i.crossEvent(),function(){n(this).removeClass("reaction__animated reaction__bounce")}),j.reaction_data.length||y||(b.removeClass("vy_ms__msg_reacted"),s.removeAttr("reaction-type").attr("reaction-type","like")),jAjax(i.ajax_url,"post",f).done(function(e){}),l&&i.pmessenger.find(".vy_ms__r").remove()},this.SocketAddReaction=function(e){let t="conversation:/messenger/"+e.From;const s=n("#msg_"+e.Msg_id).length?n("#msg_"+e.Msg_id):n('[data-unsettled-msg-id="'+e.Msg_id+'"]'),a=(parseInt(s.find(".message_reactions").text()),s.find(".message-reactions-std"));"yes"==e.Group?t="conversation:/messenger/g/"+e.Group_clean_id:"yes"==e.Page&&(t="conversation:/messenger/"+e.From+"/"+e.Page_clean_id);const o=i.updateReactionsInCache(t,e.Msg_id,{itemid:e.Msg_id,userid:e.From,type:e.Reaction,animation:"yes",added:(new Date).getTime()},e.From,e.Remove),r=i.getReactionMarkup({id:e.Msg_id,reactions:o.reaction_data});a.replaceWith(r.markup).find(".reaction__animated").on(i.crossEvent(),function(){n(this).removeClass("reaction__animated reaction__bounce")}),o.reaction_data.length?s.addClass("vy_ms__msg_reacted"):s.removeClass("vy_ms__msg_reacted")},this.updateReactionsInCache=function(e,t,s,n,i){let a=new Array,o=!1;if(_ms_Cache.exist(e)){let _=validateJson(_ms_Cache.get(e)),l=_.messages;for(var r=0;r<l.length;r++)if(l[r].id==t||l[r].unsettled_msg_id==t)if(l[r].reactions.length){for(var c=0;c<l[r].reactions.length;c++)l[r].reactions[c].animation="no",i&&l[r].reactions[c].userid==n?(l[r].reactions.splice(c,1),o=1):l[r].reactions[c].userid==n&&(l[r].reactions[c].type=s.type,o=1);o||l[r].reactions.push(s),a=l[r].reactions}else l[r].reactions.push(s),a=l[r].reactions;return _.messages=l,_ms_Cache.set(e,JSON.stringify(_)),{conversation_messages:l,reaction_data:a}}},this.isElementInViewport=function(e,t,s){if("function"==typeof jQuery&&e instanceof jQuery&&(e=e[0]),void 0!==e){var n=e.getBoundingClientRect();return s?n.top-s>=0&&n.left-s>=0&&n.bottom-s<=(window.innerHeight||document.documentElement.clientHeight)&&n.right-s<=(window.innerWidth||document.documentElement.clientWidth):t?n.top+t>=0&&n.left+t>=0&&n.bottom+t<=(window.innerHeight||document.documentElement.clientHeight)&&n.right+t<=(window.innerWidth||document.documentElement.clientWidth):n.top>=0&&n.left>=0&&n.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&n.right<=(window.innerWidth||document.documentElement.clientWidth)}},this.message_actions=function(e,t,s,n,a,o,r){let c=o.reacted||"",_=o["reaction-type"];return s=s||0,n=n||0,a=a||0,'<div class="d_comment_r foh-s">\t\t\t\t\t\t\t\t<div class="d_comment_act_w">\t\t\t\t\t\t\t\t\t<a title="'+lang.del_pm+'" onclick="messenger.delete_message(this,event,'+s+","+n+","+a+')" id="m-id-msg-'+e+'" class="d_comment_act d_comment_act_del d_comment_act_spam ic10 ic10_close-g " uid="delMsg"></a>\t\t\t\t\t\t\t\t\t<a title="'+lang.Messenger_reply+'" data-reply="'+e+'" onclick="messenger.reply(this,event);" class="d_comment_act vy_ms__reply_btn" uid="reply">'+i.svgi.js.reply+'</a>\t\t\t\t\t\t\t\t\t<a title="'+lang.Messenger_forward+'" data-forward="'+e+'" onclick="messenger.forward(this,event);" class="d_comment_act vy_ms__forward_btn" uid="forward">'+i.svgi.js.forward+'</a>\t\t\t\t\t\t\t\t\t<a title="'+lang.Messenger_reaction+'" data-react="1" reaction-type="'+_+'" data-reaction=\'{"id":"'+e+'","page":"'+n+'","group":"'+s+'","item":"message","author":"'+r+'","reaction":"like"}\' onclick="messenger.react(this,event);" class="d_comment_act d_comment_act_del d_comment_act_spam ic10 vy_ms__reaction_btn '+c+'" uid="reaction">'+i.svgi.js.reaction+'</a>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div class="d_comment_time">'+t+"</div>\t\t\t\t\t\t\t</div>"},this.close_reply=function(e){e||n(".__vyms_replying").removeClass("__vyms_replying")},this.reply=function(e,t){evstop(t,1);let s=(e=n(e)).data("reply"),a=0,o=n("#messages-tick .nano"),r=i.pmessenger.find("#pmessenger-messages-cnt"),c=n("#msg_"+s).length?n("#msg_"+s):n('[data-unsettled-msg-id="'+s+'"]');c.hasClass("__vyms_replying")&&(a=1),i.close_reply(),a||(c.addClass("__vyms_replying"),o.addClass("__animated").nanoScroller({scrollTop:c.get(0).offsetTop-r.height()+c.outerHeight()}),n(document).off("click.closeReply").on("click.CloseReply",".__vyms_replying",function(){i.close_reply()}),i.replies[i.curr_recipient]=s,i.reply_enabled=1)},this.forwardMessageCancel=function(e,t){evstop(t,1),e=n(e);let s=objHook(e.parent().find(".js__vy_ms__content_hidden").html()),a=(s.id,s.msg,s.to),o=s.group,r=e.parent().find(".js__vy-ms__forward_button_cancel"),c=e.parent().find(".js__vy-ms__forward_button_send"),_=o>0?o:a;clearTimeout(i.forward_msg_timeout[_]),r.hide(),c.show()},this.forwardMessageSend=function(e,t){if(evstop(t,1),(e=n(e)).hasClass("_forward_sent"))return;let s=objHook(e.parent().find(".js__vy_ms__content_hidden").html()),a=s.id,o=s.msg,r=s.to,c=s.group,_=s.msg_full.from_id,l=e.parent().find(".js__vy-ms__forward_button_cancel"),d=e.parent().find(".js__vy-ms__forward_button_send"),m=c>0?c:r;if(a>0&&$.trim(o)){let e=i.containsBBCODE(o),n=!1;e||(n=!0),r>0&&(c<=0||"undefined"==c)?(d.hide(),l.show(),i.forward_msg_timeout[m]=setTimeout(function(){i.send(!1,t,o,r,0,0,1,0,n,{forward:"yes",forward_own_msg:_==_U.i?"yes":"no",group:"no",userid:r}),l.hide(),d.show(),d.addClass("_nopointerevent _forward_sent").attr("disabled","disabled").text(lang.Messenger_Sent)},3500)):c>0&&(d.hide(),l.show(),i.forward_msg_timeout[m]=setTimeout(function(){i.send(!1,t,o,0,0,c,0,0,n,{forward:"yes",forward_own_msg:_==_U.i?"yes":"no",group:c,group_data:s.group_details,userid:0}),l.hide(),d.show(),d.addClass("_nopointerevent _forward_sent").attr({disabled:"disabled","forward-sent":1}).text(lang.Messenger_Sent)},3500))}},this.forward=async function(e,t){await i.globalPopup("forward-message").then(function(t){i.shortcut_id&&tonum(i.shortcut_id);let s,a=n(e).data("forward"),o=1,r="",c=new Array,_="contacts";t.html('<div class="div-loader"></div>'),t.parent().parent().find(".vy_mess-pcontact_info").hide();let l=function(e,t){let s='<div id="vy_ms__forward_button_parent"><div class="vy_ms__content_hidden js__vy_ms__content_hidden">\x3c!--{"is_group":"'+(t||"no")+'","group_details":'+JSON.stringify(e)+',"msg_full":'+JSON.stringify(c)+',"msg":"'+r+'","id":"'+a+'","to":"'+(e.group_id>0?0:e.user_id)+'","group":"'+e.group_id+'"}--\x3e</div><button onclick="messenger.forwardMessageCancel(this,event);" style="display:none;" class="js__vy-ms__forward_button_cancel">'+lang.messenger_cancel_button+'&nbsp;<div class="fwr_progress fwr_progress_blue">\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  <span class="fwr_progress-left">\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span class="fwr_progress-bar"></span>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  </span>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  <span class="fwr_progress-right">\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span class="fwr_progress-bar"></span>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  </span>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div></button> <button onclick="messenger.forwardMessageSend(this,event);" class="js__vy-ms__forward_button_send">'+lang.Messenger_button_send+"</button></div>";return'<div class="vy_ms__forward_umarkup">\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="vy_ms__forward_left"><img src="'+e.avatar+'" /></div>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="vy_ms__forward_center"><div class="vy_ms__forward_u_name">'+e.fullname+'</div></div>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="vy_ms__forward_right"><div class="vy_ms__forward_button">'+s+"</div></div>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>"},d=function(e,s){let a="",r="",c="",m="",u="",g="";if("done"==e.msg){for(var p=0;p<e.contacts.length;p++){let t=e.contacts[p];g+=l(t)}for(p=0;p<e.groups.length;p++){let t=e.groups[p];u+=l(t,"yes")}if(!s){for(p=0;p<e.recent.length;p++){let t=e.recent[p];m+=l(t)}m&&(a=`<div class="vy_ms__forward_delim_c __recent">Recent</div><div id="vy_ms__forward_users_list">${m}</div>`)}if(u&&!s&&(r=`<div class="vy_ms__forward_delim_c __groups">Groups</div><div id="vy_ms__forward_users_list">${u}</div>`),g&&!s&&(c=`<div class="vy_ms__forward_delim_c __contacts">Contacts</div><div id="vy_ms__forward_users_list">${g}</div>`),s){let e="",s="";g&&(e=g,t.find("#vy-ms__forward_appn_morecontacts").append("contacts"==_?g:`<div class="vy_ms__forward_delim_c __contacts">Contacts</div><div id="vy_ms__forward_users_list">${g}</div>`),_="contacts"),u&&(s="groups"==_?u:`<div class="vy_ms__forward_delim_c __groups">Groups</div><div id="vy_ms__forward_users_list">${u}</div>`,t.find("#vy-ms__forward_appn_moregroups").append(s),_="groups")}else t.html('<div id="vy_ms__forward_users_list">'+a+r+c+'<span id="vy-ms__forward_appn_morecontacts"></span><span id="vy-ms__forward_appn_moregroups"></span></div>');n(window).off("scroll.globalpopup_loadmore").on("scroll.globalpopup_loadmore",function(e){n(this).scrollTop()+n(this).height()>=n(document).height()&&(o++,jAjax(i.ajax_post,"post",{cmd:"get-allmy-contacts-grouped",loadmore:1,pagecount:o}).done(function(e){"end"!=(e=validateJson(e)).msg&&d(e,1)}))})}else s||t.html('<div class="vy_ms__nogroupmembers">'+e.msg+"</div>"),s&&"yes"==e.end&&t.append('<div class="vy_ms__loadmore_reachend"></div>'),n(window).off("scroll.globalpopup_loadmore")};t.parent().parent().find("#vy__ms_forward_cnt_searchcontactinput").off("keydown.forward_search").on("keydown.forward_search",function(e){clearTimeout(s)}),t.parent().parent().find("#vy__ms_forward_cnt_searchcontactinput").off("keypress.forward_search").on("keypress.forward_search",function(e){clearTimeout(s)}),t.parent().parent().find("#vy__ms_forward_cnt_searchcontactinput").off("keyup.forward_search").on("keyup.forward_search",function(e){let t=n(this),a=n(".js__vy_ms__globalpopup_close_search");clearTimeout(s),s=setTimeout(function(){let e="#vy_ms__allmycontacts_searchres",s=n("#vy_ms__forward_users_list"),o=$.trim(t.val());if(o&&o.length>=2){a.show(),s.hide();let t=n(e);t.length||(s.before('<div id="vy_ms__allmycontacts_searchres"><div class="div-loader"></div></div>'),t=s.parent().find(e)),jAjax(i.ajax_url,"post",{cmd:"search-in-all-contacts",key:escape(o)}).done(function(e){let s=validateJson(e),n="",i='<div class="vy_ms__forward_delim_c __recent">Contacts</div>';if("done"==s.msg){for(var a=0;a<s.users.length;a++){let e=s.users[a],t=e.group_id>0?"yes":"no";n+=l(e,t),"yes"==t&&(i='<div class="vy_ms__forward_delim_c __groups">Groups</div>')}t.html(i+n)}else t.html('<div class="vy_ms__nogroupmembers">'+s.msg+"</div>")})}else n(e).remove(),s.show(),a.hide()},500)}),jAjax(i.ajax_post,"post",{cmd:"get-allmy-contacts-grouped",pagecount:o}).done(function(e){jAjax(i.ajax_post,"post",{cmd:"get-msg-details",id:escape(a)}).done(function(t){200==(t=validateJson(t)).status?(c=t.data,r=t.data.original_msg,a=t.data.id,d(validateJson(e))):(i.close_global_popup(),$.alert("[Error] "+t.msg))})})})},this.redialUser=function(e,t,s){t.preventDefault(),i.hasTouchStartEvent?i.setUpVoiceVideoCallButtons(e,t,s):(e=n(e),"audio"==s?e.closest(".mmmm_c_m").find("#start-audio-chat").trigger("click.call_audio touchend.call_audio"):e.closest(".mmmm_c_m").find("#start-video-chat").trigger("click.call_video touchend.call_video"))},this.forwarded_markup=function(e,t){return"yes"==e?'<div class="vy_ms_few452x">'+i.svgi.js.forwarded_ic+" "+(t?lang.Messenger_you_forwarded_message:lang.Messenger_Forwarded_message)+"</div>":""},this.appMessageV2=async function(t,s,a,o,r,c,_,l,d,m,u,g,p,v,h,f,y,b){b&&(b=validateJson(b)),_=i.emoji_convert(_);let w=i.pmessenger.find("#vy_ms__lastmsg_timestamp"),k=w.val();var j=i.separateMediaFromText(_),x=j[0],C=j[1],M=i.shortcut?!(i.shortcut.hasClass("_focus")&&vy_ms__window_tab_active||s):!vy_ms__window_tab_active,G=h?n(".js_chat_with_page_"+h):f>0?n(".js_groupchat_id_"+f):i.shortcut?i.shortcut:i.pmessenger;if(v){new Date(1e3*v).getDate();a!=_U.i&&i.shortcut&&v?i.shortcut__appendNewDateTime(v):a!=_U.i&&!i.shortcut&&v&&i.appendNewDateTime(v)}let S=a!=_U.i?'<div class="sticky__txt_pmessenger-user-avatar"><img src="'+o+'" /></div>':"",T=G.find(".vy_ms__groupusermsgs:last").data("group-id"),A=p-k>=i.message_space_time?"messenger_msg_mrg":"",U=a!=T&&a!=_U.i&&T!=_U.i?"vy_ms__group_msg_margin":"",E=a!=T&&f>0&&a!=_U.i?'<a href="/vyuser/'+a+'" class="vy_ms__groupuser_fullname">'+r+"</a>":"",I=i.getReactionMarkup({id:t,reactions:new Array});u=u||!1,m=m?'<img src="'+o+'">':'<img src="'+_BLANK+'">';var R='<div id="mess_sent_status" class="messenger_sent_Status" rel="tipsy" title="'+lang.mess_sent_status+'"><i class="glyphicon glyphicon-ok-circle messenger-sent-ic"></i></div>',N=(a!=T?'<div data-group-id="'+a+'" class="vy_ms__groupusermsgs '+U+'">'+S:"")+'<div id="msg_'+t+'" data-unsettled-msg-id="'+t+'"  class="pmessenger-message-txt '+(b?"_contains_reply":"")+" "+("yes"==y?"__vforwarded":"")+" soh-s "+A+" "+("no"==d?"_nobg":"")+" "+s+'"><div class="txt_pmessenger-user-avatar">'+m+"</div>"+i.forwarded_markup(y,"_me"==s?1:0)+'<div class="vycntreply243">'+i.replied_msg(b)+'<div class="messenger_text_col '+(M&&"_me"!=s?"is_new":"")+'">'+($.trim(x)?"<div "+(a==_U.i?'rel="li-gliph-color-background"':"")+' class="txt_pmessenger-text mess-msgs-cnt-rows">'+E+x+I.markup+"</div>":"")+($.trim(C)?'<div class="mess-msgs-cnt-rows messenger_media_in_msg">'+E+C+I.markup+"</div>":"")+"</div></div>"+i.message_actions(t,c,f,h,a,I,s)+(i.show_sent_status?R:"")+"</div>"+(a!=T?"</div>":"");G.find(".messenger-no-messages").length&&!i.shortcut?G.find("#messages-tick").replaceWith('<div id="messages-tick"><div class="nano"><div class="overthrow nano-content"><div id="messenger-nano-content-fullheight">'+N+"</div></div></div></div>"):G.find(".messenger-no-messages").length&&i.shortcut?G.find(".messenger-no-messages").replaceWith('<div id="messenger-nano-content-fullheight">'+N+"</div>"):a==T?G.find('#messenger-nano-content-fullheight .vy_ms__groupusermsgs[data-group-id="'+a+'"]:last').append(N):G.find("#messenger-nano-content-fullheight").append(N),!i.shortcut||i.pmessenger.length&&n("#messenger_with_user").val()==tonum(e)||h||f||(messenger_shortcut.scrollChat(i.shortcut_id,u,g,t,0,0),i.show_sent_status=!1),h&&i.shortcut_id?(messenger_shortcut.scrollChat(i.shortcut_id,u,g,t,h),i.show_sent_status=!1):f>0&&i.shortcut_id&&(messenger_shortcut.scrollChat(i.shortcut_id,u,g,t,0,f),i.show_sent_status=!1),nanoScrollStart(),i.pmessenger.length&&!i.shortcut&&(i.scrollNow?i.hasTouchStartEvent?setTimeout(function(){i.scrollChat(u,g,t,a,h,f)},10):i.scrollChat(u,g,t,a,h,f):setTimeout(function(){i.scrollChat(u,g,t,a,h,f)},100),i.scrollNow=!1,i.show_sent_status=!1),i.startvenobox(),i.hasTouchStartEvent||i.enable_reactions(),w.val(p)},this.updateConversationCache=function(e,t,s){if(_ms_Cache.exist(t)){let n=validateJson(_ms_Cache.get(t));s?n.messages.unshift(e):n.messages.push(e),_ms_Cache.set(t,JSON.stringify(n))}},this.liveMedia=async function(e,t,s){let n={cmd:"bbcode"};return n.string=e,t&&(n.min="yes"),s&&(n.ot="yes"),jAjax(i.ajax_url,"post",n)},this.getLoader=function(e){return i.shortcut?e?n(".js_chat_with_page_"+e).find(".mdialog_send_message_loader"):i.shortcut.find(".mdialog_send_message_loader"):n(".mdialog_send_message_loader")},this.containsBBCODE=function(e){let t=!1;for(var s=0;s<i.BBCODES.length;s++)e.includes(i.BBCODES[s])&&(t=!0);return t},this.apMessage=async function(e,t,s,n,a,o,r,c,_,l,d,m,u,g,p,v,h,f){let y=i.getLoader(p);if(i.containsBBCODE(r)||(r=i.tourl(r)),"no"!=_&&!i.containsBBCODE(r))return await i.appMessageV2(e,t,s,n,a,o,r,c,_,l,d,m,u,g,p,v,h,f);y.addClass("__visible showimportant"),await i.liveMedia(r).then(async function(r){return y.removeClass("__visible showimportant"),await i.appMessageV2(e,t,s,n,a,o,r,c,_,l,d,m,u,g,p,v,h,f)})},this.tourl=function(e){return e.replace(/(((https?:\/\/)|(www\.))[^\s]+)/g,function(e,t,s){return'<a href="'+("www."==s?"http://"+e:e)+'" target="_blank">'+e+"</a>"})},this.startvenobox=function(){n(".js_lightgallery").lightGallery({thumbnail:!1})},this.prependContactGroup=async function(e,t,s,n,a,o,r,c,_,l,d,m){return await jAjax(i.ajax_url,"post",{cmd:"get-group-details",group:escape(m)}).done(function(e){e=validateJson(e),s=e.group_avatar,n=e.group_name}),i.prependContact(e,t,s,n,a,o,r,c,_,l,d,m,1)},this.prependContact=function(e,t,s,a,o,r,c,_,l,d,m,u,g){e=n(e),t&&t.preventDefault(),m=m||0,u=u||0;var p=n("#messenger-contacts-last .nano-content"),v=m>0?"contact-"+o+"_"+m:"contact-"+o;if(u>0&&!g)return i.prependContactGroup(e,t,s,a,o,r,c,_,l,d,m,u);u>0&&(v="contact-GG"+u);let h=u>0?'<div title="'+lang.Messenger_confirm_btn_leaving_group+'" id="'+u+'" class="mob_del_swipe_txt js__isgroup">'+lang.Messenger_confirm_btn_leaving_group+"</div>":'<div title="'+lang.pm_delete_convers+'" class="mob_del_swipe_txt">'+lang.del_pm+"</div>";var f='<div class="vy_ms_contactbord">\t\t\t\t\t\t\t\t\t<a href="/messenger/'+(m>0?o+"/"+m:u>0?"g/"+u:o)+'" id="'+v+'" class="pmessenger-contact-a '+(u>0?"vy_ms_contactisgroup contact_groupid_"+u:"")+" "+(_?"_newmessages":"")+" "+(l?"":"active")+"\" onclick=\"__j('.pmessenger-contact-a').removeClass('active');__j(this).addClass('active');messenger.openContact(this,event,'"+o+"','"+s+"','"+a+"','"+r+"','"+m+"','"+u+'\')">\t\t\t\t\t\t\t\t\t\t<div class="js_conv_swipe pmessenger-mleft12">\t\t\t\t\t\t\t\t\t\t\t<div class="pmessenger-contact-avatar">\t\t\t\t\t\t\t\t\t\t\t\t<img src="'+s+'" />\t\t\t\t\t\t\t\t\t\t\t\t<div class="only_ic global_user_online global_user_online_'+o+'"><i class="ic-online"></i></div>\t\t\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t\t<div class="pmessenger-contact-info">\t\t\t\t\t\t\t\t\t\t\t\t<div class="pmessenger-contact-name ellip" title="'+a+'">'+a+'</div>\t\t\t\t\t\t\t\t\t\t\t\t<div class="pmessenger-contact-last-msg ellip _1htf _6zke">\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="_42dz5 ellip">'+(c?c.substring(0,20)+(c.length>20?"...":""):"&nbsp;")+'</div>\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="pmessenger-contact-last-msg-time">\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="pmessenger-contact-last-msg-time"><div class="_6zkf">&#8729;</div><span class="_1ht7 _6zkh timestamp">&nbsp;</span></div>\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t\t\t'+(_?'<div class="convo__unread oval in_messenger">+'+_+"</div>":"")+'\t\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t<div class="mob_delete_on_swipe js_mob_delete_conv_btn">'+h+"</div>\t\t\t\t\t\t\t\t\t</a>\t\t\t\t\t\t\t\t</div>";if(d)return f;n("#"+v).length?(n("#"+v).removeAttr("data-last-message-timestamp").attr("data-last-message-timestamp",Math.ceil(1e3*(new Date).getTime())).trigger("click"),setTimeout(function(){tinysort(p.find(".pmessenger-contact-a"),{data:"last-message-timestamp",order:"desc",ignoreDashes:!0})},500)):(p.prepend(f),l||messenger.openContact(n("#"+v),t,o,s,a,r)),i.closeSearch(n(".messenger-cancel-search"),t)},this.closeSearch=function(e,t){t.preventDefault();var s=n("#messenger-contacts-search-res").find(".nano-content"),i=n("#messenger-contacts-last");e=n(e),n("#input-search-messenger").val(""),e.addClass("hidden_elem"),s.empty(),s.parent().addClass("__none"),i.show()},this.searchMessenger=function(){var e,t=n("#messenger-contacts-search-res").find(".nano-content"),s=n("#messenger-contacts-last"),a='<div onclick="messenger.prependContact(this,event,\'%avatar\',\'%name\',\'%id\',\'\');" id="%id" class="mess-search-contact-res">\t\t\t<div class="mess-search-res_contact_avatar"><img src="%avatar" /></div>\t\t\t<div class="mess-search-res_contact_details">\t\t\t<div class="mess-search-res_contact_name">%name&nbsp;<div id="f_onl_gtm" class="only_ic global_user_online global_user_online_%id">%online</div></div>\t\t\t</div>\t\t\t</div>',o=n("#input-search-messenger");o.on("keydown keypress",function(){clearTimeout(e)}),o.on("keyup",function(r){evstop(r,1);var c=n(this),_=c.val(),l=n(".messenger-cancel-search"),d=n("#pm_dlg_lft_users"),m=n("#msg_d_search_res"),u=n("#msrch-act-1");0==m.length&&d.before('<section id="msg_d_search_res"></section'),$.trim(_)?(clearTimeout(e),u.removeClass("__remover").addClass("_55yn _55yo _55ym"),l.removeClass("hidden_elem"),e=setTimeout(function(){jAjax(i.ajax_url,"post","cmd=searchFriends&key="+escape(_)).done(function(e){var n=validateJson(e);if(u.removeClass("_55yn _55yo _55ym").addClass("__remover").on("click",function(){c.val(""),o.trigger("keyup")}),s.hide(),t.parent().removeClass("__none"),n.length<=0)t.html('<div class="mdialog_search_empty">'+lang.pm_no_friends_found+"</div>");else{for(var i="",r=0;r<n.length;r++){var _=n[r];jprintf(a,"1","onUcLeft",_.id,_.id,_.name,_.photo,_.id,_.photo,_.name,"true"==_.online?'<div class="ic-online"></div>':"",_.id,_.id,_.name,_.id,"","notifications__hide","");i+=a.replace(/%id/g,_.id).replace(/%avatar/g,_.photo).replace(/%online/g,"true"==_.online?'<div class="ic-online"></div>':"").replace(/%name/g,_.name)}t.html(i),nanoScrollStart()}})},500)):(s.show(),t.empty(),t.parent().addClass("__none"),u.removeClass("__remover _55yn _55yo _55ym"))})},this.getMyGroups=function(e){e.removeClass("__none"),(e=e.find(".js__groups_tab_cnt")).html('<div class="div-loader"></div>'),i.stop_xhr("ms-groups-contacts"),jAjax(i.ajax_url,"post","cmd=getMyGroups&view_as=json",!1,"ms-groups-contacts").done(function(t){e.html(t),n("#contact-GG"+i.group_id+":first").addClass("active"),n("#contact-GG"+i.group_id+":last").addClass("active"),nanoScrollStart(),i.hasTouchStartEvent&&i.initTouchEvents()})},this.getOnlineContacts=function(e){var t='<div class="messenger_no_online_users">'+lang.mess_no_online_users+"</div>";e.removeClass("__none").html('<div class="div-loader"></div>'),$.ajax({url:"https://"+CHAT_NODE_HOST+"/getonlinecontacts",contentType:"application/json",data:JSON.stringify({domain:V_WS_ADDR,userid:socketId()}),type:"POST",success:function(s){jAjax(i.ajax_post,"post",{cmd:"online-users-details",users:JSON.stringify(s)}).done(function(s){var n="";if("null"!==s){for(var a=validateJson(s),o=0;o<a.length;o++){var r=a[o];n+=i.prependContact("",window.event,r.photo,r.name,r.id,r.last_seen,"",!1,!0,!0)}e.html(n),nanoScrollStart()}else e.html(t)})},error:function(e,t,s){console.log("Error: "+s.message)}})},this.switchTabs=function(e,t,s){t.preventDefault(),e=n(e),n(".mstabactive").removeClass("active"),e.addClass("active");var a=n("#messenger-contacts-online-res"),o=n("#messenger-contacts-last"),r=n("#messenger-contacts-groups-res"),c=n("#messenger-contacts-search-res");switch(s){case"conversations":a.addClass("__none").empty(),r.addClass("__none").find(".js__groups_tab_cnt").empty(),o.show(),n("._1nq2").show();break;case"groups":o.hide(),a.addClass("__none").empty(),n("._1nq2").hide(),c.addClass("__none"),i.getMyGroups(r);break;case"online":o.hide(),r.addClass("__none").find(".js__groups_tab_cnt").empty(),n("._1nq2").hide(),c.addClass("__none"),i.getOnlineContacts(a)}nanoScrollStart()},this.removeNewBubble=function(e,t,s){setTimeout(function(){i.shortcut?e?i.shortcut.find(".is_new").each(function(){tonum(n(this).closest(".pmessenger-message-txt").attr("id"))<=e&&n(this).removeClass("is_new")}):s&&i.shortcut.find(".is_new").removeClass("is_new"):e?i.pmessenger.find(".is_new").each(function(){tonum(n(this).closest(".pmessenger-message-txt").attr("id"))<=e&&n(this).removeClass("is_new")}):s&&i.pmessenger.find(".is_new").removeClass("is_new")},t||5e3)},this.updateMessagesAsRead=function(e,t,s,a){var o=0;if("object"==typeof s&&Object.keys(s).length&&a<=0){if(void 0!==s.userid&&(e=isNaN(s.userid)?tonum(s.userid):s.userid,o=s.page_id,e!=_U.i)){let s=_U.p;i.shortcut&&"yes"==i.shortcut.find("#messenger_page_admin").val()?s=i.shortcut.find("#inphd_page_avatar").attr("src"):"yes"==i.pmessenger.find("#messenger_page_admin").val()&&(s=i.pmessenger.find("#inphd_page_avatar").attr("src")),i.socket.emit("seen",JSON.stringify({Msg_id:t,Userid:socketId(e),Page_id:o,Group_id:0,Recipient_id:_U.i,Recipient_avatar:s,Group_avatar:!1})),jAjax(i.ajax_url,"post",{cmd:"node-update-all-msgs-as-read",userid:e,page:o}).done(function(s){i.shortcut&&n("#mshortcut-"+e+"_"+o).removeClass("_h_unread"),n("#contact-"+e+"_"+o).removeClass("_newmessages").find(".convo__unread.in_messenger").remove(),i.removeNewBubble(t),i.updateGlobalCount(e,o,a),setTimeout(function(){gwtlog.updateTotalMessages()},50),n(".nav_tool_friends_online #friend_"+e).find("#online-friend-new-msg-count").remove()})}}else if(a>0){if(e!=_U.i){let s=n(".pmessenger #vy_messenger_group_id_"+a).length?n("#vy_messenger_group_id_"+a).attr("src"):n("#vy_shortcut_group_id_"+a).attr("src");i.socket.emit("group_seen",JSON.stringify({Msg_id:t,Userid:socketId(e),Page_id:0,Recipient_id:_U.i,Recipient_avatar:_U.p,Room:i.room_id,Group:socketId("GG"+a),Group_id:a,Group_avatar:encodeURIComponent(s)})),jAjax(i.ajax_url,"post",{cmd:"node-update-all-msgs-as-read",userid:0,page:0,group:escape(a)}).done(function(s){i.shortcut&&n("#mshortcut-GG"+a).removeClass("_h_unread"),n("#contact-GG"+a).removeClass("_newmessages").find(".convo__unread.in_messenger").remove(),i.removeNewBubble(t),i.updateGlobalCount(e,o,a),setTimeout(function(){gwtlog.updateTotalMessages()},50)})}}else if(!o&&!a){if(e!=_U.i)i.socket.emit("seen",JSON.stringify({Msg_id:t,Userid:socketId(e),Page_id:0,Group_id:0,Recipient_id:_U.i,Recipient_avatar:_U.p,Group_avatar:!1})),jAjax(i.ajax_url,"post",{cmd:"node-update-all-msgs-as-read",userid:e}).done(function(){i.shortcut&&i.shortcut.removeClass("_h_unread"),n("#contact-"+e).removeClass("_newmessages").find(".convo__unread.in_messenger").remove(),i.removeNewBubble(t),i.updateGlobalCount(e,o),setTimeout(function(){gwtlog.updateTotalMessages()},50),n(".nav_tool_friends_online #friend_"+e).find("#online-friend-new-msg-count").remove()})}},this.updateGlobalCount=function(e,t,s){t>0?g_messenger_count[e+"_"+t]=0:s>0?g_messenger_count["GG"+s]=0:g_messenger_count[e]=0},this.notificationNewMessage=function(e,t,s,a,o,r){let c="";if(c=a>0?t+"_"+a:o>0?"GG"+o:t,c=i.pmessenger.length?n('[rel="contactid-'+c+'"]'):n("#mshortcut-"+c),e&&c.length){var _,l=(_=n("#messages-tick .nano")).find(".nano-content");l.find("#flying-notif-new-messages").length?l.find("#flying-notif-new-messages").replaceWith(i.flying_new_message_markup.replace("%count",e)):l.append(i.flying_new_message_markup.replace("%count",e)),n(".pmessenger #flying-notif-new-messages").off("click.new_msg_flying").on("click.new_msg_flying",function(e){if(evstop(e,1),n(this).hasClass("triggered"))return;n(this).addClass("triggered"),setTimeout(function(){n(this).removeClass("triggered")},1e3),n(this).hasClass("no-nano-scroll")||_.nanoScroller({scroll:"bottom"}),n(this).fadeOut(function(){n(this).remove()});var a={},o=n("#messenger_with_page").val();"none"!=o&&(a.userid=t,a.page_id=o);let r=n(this).closest(".js_mess_hidden_data").find("#messenger_with_group").val();"none"!=r&&"0"!=r||(r=0),i.updateMessagesAsRead(t,s,a,r),i.minus_count_message&&(global_messenger_count-=1),gwtlog.updateCountMessages(global_messenger_count),i.minus_count_message=!1}),(_=n("#messages-tick .nano")).find(".nano-content").scrollTop()<=0&&n(".pmessenger #flying-notif-new-messages").addClass("no-nano-scroll").trigger("click.new_msg_flying"),_.off("scrollend.notifNewMessageBottom").on("scrollend.notifNewMessageBottom",function(){n(".pmessenger #flying-notif-new-messages").addClass("no-nano-scroll").trigger("click.new_msg_flying"),_.off("scrollend.notifNewMessageBottom")}),vy_ms__window_tab_active&&setTimeout(function(){i.turnOnSound()},10)}},this.blinkWindowTitle=function(){if(i.getTotalMessUnreadCount()<=0)return document.title=i.window_curr_title,clearInterval(i.blinkTitleInterval);i.window_curr_title||(i.window_curr_title=document.title);var e="("+i.getTotalMessUnreadCount()+") "+(i.getTotalMessUnreadCount()>1?lang.new_messages:lang.new_message);document.title=i.isOldTitle?i.window_curr_title:e,i.isOldTitle=!i.isOldTitle},this.getTotalMessUnreadCount=function(){return parseInt(global_messenger_count)},this.messengerFocusWindow=function(e,t,s){clearInterval(i.blinkTitleInterval),i.getTotalMessUnreadCount()<=0?clearInterval(i.blinkTitleInterval):(i.blinkTitleInterval=setInterval(i.blinkWindowTitle,700),setTimeout(function(){Object.keys(i.last_message_object).length&&(i.notificationNewMessage(i.last_message_object.msgs_count,i.last_message_object.userid,i.last_message_object.msg_id,t,s),vy_ms__window_tab_active||setTimeout(function(){i.turnOnSound()},10)),i.shortcut&&e&&Object.keys(e).length&&messenger_shortcut.notificationNewMessage(e.msgs_count,e.userid,e.msg_id,e.page_id,e.group_id,!0)},100),n(window).off("focus.messenger").on("focus.messenger",function(e){setTimeout(function(){nanoScrollStart(),clearInterval(i.blinkTitleInterval),document.title=i.window_curr_title,i.window_curr_title=document.title,i.last_message_object={}},100)}))},this.scrollChat=function(e,t,s,a,o,r){var c=n("#messages-tick .nano"),_=c.find(".nano-content"),l=(n(".pmessenger .pmessenger-message-txt:last"),n(".pmessenger #messenger-nano-content-fullheight"));if(!vy_ms__window_tab_active){if(!t)return;if(i.minus_count_message=!0,i.last_message_object={msg_id:s,msgs_count:t,userid:r||a,global:1},o)i.last_message_object.page_id=o;else{if(!r)return i.messengerFocusWindow();i.last_message_object.group_id=r}}if(nanoScrollStart(),l.height()-_.scrollTop()-c.height()>=100&&e)s&&n("#msg_"+s+":not(._me)").find(".messenger_text_col").addClass("is_new"),i.notificationNewMessage(t,a,s,o,r);else{var d={},m=n("#messenger_with_page").val();"none"!=m&&(d.userid=a,d.page_id=m);let e=n("#messenger_with_group").val();"none"!=e&&"0"!=e||(e=0),o>0&&(d.userid=a,d.page_id=m),s&&i.updateMessagesAsRead(a,s,d,e),setTimeout(function(){var e="scrollend.c"+i.randId;c.nanoScroller({scroll:"bottom"}).on(e,function(){i.removeNewBubble(s),i.gl_scrollChatDelay=!1}),c.trigger(e)},i.gl_scrollChatDelay?i.gl_scrollChatDelay:10),c.nanoScroller({scroll:"bottom"})}},this.getAttachments=function(e,t){i.pmessenger.find("#vy_ms__btn_loadmoreattchments").remove();var s,a,o=n("#messenger-attachments-cnt"),r={cmd:t?"get-more-attachments":"get-attachments",userid:escape(e)};"none"!=n("#messenger_with_page").val()&&(a=n("#messenger_with_page").val(),r.page=a),"none"!=n("#messenger_with_group").val()&&(s=n("#messenger_with_group").val(),r.group=s);let c=a?a+"_"+e:s?"GG"+s:e;if(t&&(r.offset=i.attach_draft_offset.hasOwnProperty(c)&&i.attach_draft.hasOwnProperty(c)?i.attach_draft_offset[c]:escape(t)),!i.attach_draft_polnii.hasOwnProperty(c)||!t){if(i.attach_draft.hasOwnProperty(c)&&!t||t&&i.attach_draft_polnii.hasOwnProperty(c))return o.html(i.attach_draft[c]),void setTimeout(function(){nanoScrollStart(),i.startvenobox()},500);t?o.append('<div class="div-loader"></div>'):o.html('<div class="div-loader"></div>'),jAjax(i.ajax_url,"post",r,!1,"ms-attach-"+e).done(function(s){o.find(".div-loader").remove();var n=validateJson(s);if(1==n.success)if(t&&(i.attach_draft_offset[c]=t),"no"==n.info){if(t)return i.attach_draft_polnii[c]=1;o.html('<div class="mess-textcenter">'+lang.messenger_no_attach+"</div>")}else{for(var a="",r="",_=0;_<n.files.length;_++){var l=n.files[_],d="video"==l.type?"video-cover":"image";"image"==l.type?a+='<a href="/messenger.php?cmd=atch&id='+l.id+'" class="mess image-hover"><div class="mess_attachment_small" style="background-image:url(/messenger.php?cmd=atch&id='+l.id+"&type="+d+'&low=1)"></div></a>':(a+='<span style="cursor:pointer;" data-html="#video'+l.id+'" data-poster="/messenger.php?cmd=atch&id='+l.id+"&type="+d+'" class="mess image-hover"><div class="mess_attachment_small vyms__video_attachment_cover" style="background-image:url(/messenger.php?cmd=atch&id='+l.id+"&type="+d+'&low=1)"></div></span>',r+='<div style="display:none;" id="video'+l.id+'"><video class="lg-video-object lg-html5" controls preload="metadata"><source src="/messenger.php?cmd=atch&id='+l.id+'&type=video" type="video/mp4"></video></div>')}let s=r+'<div class="nano-disabled"><div class="nano-content-disabled"> <div class="js_lightgallery">'+a+"</div></div></div>"+(i.attach_draft_polnii.hasOwnProperty(c)?"":'<div id="vy_ms__btn_loadmoreattchments" class="messenger-load-more-contacts-loader pmessenger-contact-a"><a class="link-show-more loader-controls private" onclick="messenger.load_more_attachments(event,'+e+');" uid="prevDialogs">'+lang.Load_more+"</a></div>");t?o.append(s):o.html(s),t?i.attach_draft[c]+=s:i.attach_draft[c]=s,nanoScrollStart(),i.startvenobox()}else o.text(lang.messenger_err_loading_attach)})}},this.expandTab=function(e,t){(t=n(t)).parent().hasClass("expanded")?t.parent().removeClass("expanded"):t.parent().addClass("expanded"),nanoScrollStart()},this.setColorFromNativeApp=function(e,t){jAjax(i.ajax_url,"post",{cmd:"setColor",color:e,userid:escape(t)}).done(function(e){})},this.setColor=function(e,t,s){var a=(e=n(e)).data("color"),o=i.shortcut_id?tonum(i.shortcut_id):0;if(!i.mess_colors.hasOwnProperty(a))return displayErr(lang.messenger_invalid_color);ajaxLoading(),jAjax(i.ajax_url,"post",{cmd:"setColor",color:a,userid:escape(t),group:escape(s)}).done(function(r){if(removeAjaxLoad(),1!=r)return displayErr(lang.somethingWrong);{n(".mess_color.active").removeClass("active"),e.addClass("active");let r=0;i.closeModernPopup();let c=generateRoomId(t,_U.i,r,s);setTimeout(function(){i.writeNotification("color_changed*"+_U.fn+"*"+a+"*"+s,"colors",s>0&&i.shortcut_id?i.shortcut_id.replace("mshortcut-",""):o,c,t,r,s)},100),i.curr_color=a}})},this.current_color=function(){let e=i.default_color;return e=i.shortcut?i.shortcut.find("#chat-curr-color").val():i.pmessenger.length?n("#mess-curr-color").val():i.curr_color},this.colorateStrokes=function(e,t,s,a){var o=t;t=!!t&&"#"+t+" ";let r=i.mess_colors.hasOwnProperty(e)&&i.mess_colors[e].img?{"background-color":e,"background-image":i.mess_colors[e].img,"background-attachment":"fixed"}:{"background-color":e};var c=t?"#messenger_"+tonum(n(t).attr("id"))+" ":".pmessenger ";t&&n(t).find("#chat-curr-color").val(e),c&&n(c.replace(" ","")).find("#mess-curr-color").val(e),$.each({stroke:"mess-colorate-this-stroke",fill:"mess-colorate-this-fill",color:"gliph-mess-color","background-color":"li-gliph-color-background","border-color":"li-gliph-color-border"},function(s,i){n(c+'[rel="'+i+'"]').each(function(){"fill"==s||"stroke"==s?n(this).attr(s,e):"background-color"==s?n(this).removeAttr("style").css(r):n(this).removeAttr("style").css(s,e)}),n(t+'[rel="'+i+'"]').each(function(){"fill"==s||"stroke"==s?n(this).attr(s,e):"background-color"==s?n(this).removeAttr("style").css(r):n(this).removeAttr("style").css(s,e)})});n(t+".pmessenger-message-txt._me").find(".txt_pmessenger-text");n(t+".pmessenger-message-txt._me").find(".txt_pmessenger-text").css(r);var _,l=o?"messenger-pseudo-element-color-"+o:(_=n("#messenger_with_page").val(),n(".js_chatwithpage").length?"messenger-pseudo-element-color-mshortcut-"+i.recipient_id+"_"+_:"messenger-pseudo-element-color-mshortcut-"+i.recipient_id),d='<style id="'+l+'">#'+o+" .messenger-shortcut-cnt ._me .txt_pmessenger-text:before{ border-right-color: %color;}</style>";n("body").find("#"+l).length?n("body").find("#"+l).replaceWith(d.replace(/%color/g,e)):n("body").prepend(d.replace(/%color/g,e))},this.touchHandler=function(e){e.touches.length>1&&e.preventDefault()},this.setNicknameInGroup=function(e,t,s,a){jAjax(i.ajax_url,"post",{cmd:"setnickname",group:escape(t),userid:escape(_U.i),my_nickname:escape(e)}).done(function(o){if(200!=(o=validateJson(o)).status)return n("#vy_ms__nickname_err").text(lang.Messenger_error+" "+o.msg);{let n=!$.trim(e),r=$.trim(e)?encodeURIComponent(e):encodeURIComponent(_U.fn);if(i.closeModernPopup(),s==e)return;i.shortcut?i.shortcut.find("#messenger_group_nickname").val(e):i.pmessenger.find("#messenger_group_nickname").val(e),i.groupNotification(_U.i,t,n?"user-nickname-removed":"user-nickname-update"),i.socket.emit("vy_ms__groupUpdateNickNames",JSON.stringify({Userid:_U.i,User:_U,Group_id:socketId("GG"+t),Group_clean_id:t,Group_data:validateJson(o.group_data),Nickname:r,shortcut_id:a,nickname_removed:n}))}})},this.getMuteStatus=function(e,t){let s=t>0?ms_muted_contacts.groups:ms_muted_contacts.contacts,n=t>0?t:e;if(s.length>-1)for(var i=0;i<s.length;i++)if(s[i].id==n)return!0;return!1},this.default_md_ic=function(e,t){let s=t>0?ms_muted_contacts.groups:ms_muted_contacts.contacts,n=t>0?t:e;if(s.length>-1)for(var a=0;a<s.length;a++)if(s[a].id==n)return i.svgi.js.muted;return i.svgi.js.unmuted},this.mob__default_md_ic=function(e,t){let s=t>0?ms_muted_contacts.groups:ms_muted_contacts.contacts,n=t>0?t:e;if(s.length>-1)for(var a=0;a<s.length;a++)if(s[a].id==n)return i.svgi.js.mobile.muted;return i.svgi.js.mobile.unmuted},this.sendMuteDataToMongo=function(e){i.socket.emit("insert_mute",JSON.stringify(e))},this.muteContact=function(e,t){return modernPopup(function(s,a){i.shortcut_id&&tonum(i.shortcut_id);a.html('<div class="div-loader"></div>');let o={cmd:"mute-byuser",id:escape(e)};t>0&&(o.group=escape(t)),jAjax(i.ajax_url,"post",o).done(function(t){if((t=validateJson(t)).status=200){let s="",i={};for(var n in i.half_hour='<a href="javascript:void(0);" class="vy_ms__notifli"><label for="vy_ms__mutefor30"><input id="vy_ms__mutefor30" name="messengerMuteOptions" value="30" type="radio" '+("30"==t.interval||"0"==t.interval?"checked":"")+" /><span>"+lang.Messenger_mute_for_30+"</span></label></a>",i["1_hour"]='<a href="javascript:void(0);" class="vy_ms__notifli"><label for="vy_ms__mutefor1hour"><input id="vy_ms__mutefor1hour" name="messengerMuteOptions" value="1" type="radio" '+("1"==t.interval?"checked":"")+" /><span>"+lang.Messenger_mute_for_1hour+"</span></label></a>",i["12_hours"]='<a href="javascript:void(0);" class="vy_ms__notifli"><label for="vy_ms__mutefor12hours"><input id="vy_ms__mutefor12hours" name="messengerMuteOptions" value="12" type="radio" '+("12"==t.interval?"checked":"")+" /><span>"+lang.Messenger_mute_for_12hours+"</span></label></a>",i["24_hours"]='<a href="javascript:void(0);" class="vy_ms__notifli"><label for="vy_ms__mutefor24hours"><input id="vy_ms__mutefor24hours" name="messengerMuteOptions" value="24" type="radio" '+("24"==t.interval?"checked":"")+" /><span>"+lang.Messenger_mute_for_24hours+"</span></label></a>",i.forever='<a href="javascript:void(0);" class="vy_ms__notifli"><label for="vy_ms__mutefor_forever"><input id="vy_ms__mutefor_forever" name="messengerMuteOptions" value="99" type="radio" '+("99"==t.interval?"checked":"")+" /><span>"+lang.Messenger_mute_for_forever+"</span></label></a>",t.interval>0&&(i.unmute='<a href="javascript:void(0);" class="vy_ms__notifli"><label for="vy_ms__unmute"><input id="vy_ms__unmute" name="messengerMuteOptions" value="0" type="radio" '+("0"==t.interval?"checked":"")+" /><span>"+lang.Messenger_unmute+"</span></label></a>"),i)s+=i[n];a.html('<div class="_fc554222i"><input type="hidden" value="'+e+'" id="vy_ms__mcontactid" /><div class="vy_ms__muteContact_header">'+lang.Messenger_mute+'</div><div id="vy_ms__mnotification_err" style="color:red;" class="__none"></div><div class="vy_ms__muteContact_cnt">'+s+"</div></div>")}else a.html(t.msg),s.remove()}),s.on("click",function(e){evstop(e,1);let s=n(this).closest("#sc_modern_popup_cnt"),a=s.find("#vy_ms__mnotification_err"),o=s.find('input[type="radio"]:checked').val(),r=s.find("#vy_ms__mcontactid").val();if(a.addClass("__none").empty(),!["30","1","12","24","99","0"].includes(o))return a.removeClass("__none").text("Incorrect value. Please select only from below options.");let c={cmd:"mute-contact",recipient:escape(r),interval:escape(o)};t>0&&(c.group=escape(t)),ajaxLoading(),jAjax(i.ajax_url,"post",c).done(function(e){removeAjaxLoad(),e=validateJson(e);let s=n(t>0?"#messenger_GG"+t:"#messenger_"+r).find("#vy_ms__mute_icon"),a=t?"#contact-GG"+t:"#contact-"+r;200==e.status?(o>0?(s.replaceWith(i.svgi.js.muted),n(a).addClass("__muted")):(s.replaceWith(i.svgi.js.unmuted),n(a).removeClass("__muted")),ms_muted_contacts=e.new_arr,i.closeModernPopup(),i.sendMuteDataToMongo({user_id:socketId(),user_clean_id:_U.i,recipient_clean_id:r,recipient_id:socketId(r),group_id:t?socketId("GG"+t):0,group_clean_id:t,value:o,cron:e.cron||null,timezone:i.getTimezone()})):n("#vy_ms__mnotification_err").removeClass("__none").text(e.msg)})})})},this.getLocalTimezone=function(){return Intl.DateTimeFormat().resolvedOptions().timeZone},this.getTimezone=function(){return vy_ms_timezone},this.helpphpcron=function(e){let t={cmd:"cron",action:"unmute",recipient:e.recipient_clean_id,id:e.user_clean_id,group:e.group_clean_id,page:0};jAjax(i.ajax_url,"post",t).done(function(t){i.ajax_crontab_unmute(e.recipient_clean_id,e.group_clean_id,0)})},this.ajax_crontab_unmute=function(e,t,s){jAjax(i.ajax_url,"post",{cmd:"ajax_getMyMutedContacts"}).done(function(s){let a=t>0?"#contact-GG"+t:"#contact-"+e;n(t>0?"#messenger_GG"+t:"#messenger_"+e).find("#vy_ms__mute_icon").replaceWith(i.svgi.js.unmuted),n(a).removeClass("__muted"),ms_muted_contacts=validateJson(s)})},this.closeModernPopup=function(){n("#sc_modern_popup").remove()},this.setNicknames=function(e,t,s){return modernPopup(function(a,o){var r=i.shortcut_id?tonum(i.shortcut_id):0,c="",_=(s>0?"":'<li><div class="mess_nickname_input"><div class="mess_nickname_td ellip">'+decodeURIComponent(t)+"&nbsp;<a href=\"javascript:void(0);\" onclick=\"__j(this).parent().parent().find('input').val('');\">"+lang.remove+'</a></div><div class="mess_nickname_inp"><input class="dark" type="text" id="messenger_recipient_nickname" placeholder="'+lang.messenger_nickname_placeholder+'" value="%nickname_recipient" /></div></div></li>')+'<li><div class="mess_nickname_input"><div class="mess_nickname_td ellip">'+_U.fn+"&nbsp;<a href=\"javascript:void(0);\" onclick=\"__j(this).parent().parent().find('input').val('');\">"+lang.remove+'</a></div><div class="mess_nickname_inp"><input class="dark" type="text" id="messenger_my_nickname" placeholder="'+lang.messenger_nickname_placeholder+'" value="%my_nickname" /></div></div></li>';o.html('<div class="div-loader"></div>');let l={cmd:"get-nicknames",userid:escape(e)};s>0&&(l.group=escape(s)),jAjax(i.ajax_url,"post",l).done(function(e){var t=validateJson(e);if(t.count>0){var n=t.my;if(c=t.my,s<=0||!s)var i=t.recipient;_=s>0?_.replace(/%my_nickname/g,decodeURIComponent(n)):_.replace(/%nickname_recipient/g,decodeURIComponent(i)).replace(/%my_nickname/g,decodeURIComponent(n))}else _=s>0?_.replace(/%my_nickname/g,""):_.replace(/%nickname_recipient/g,"").replace(/%my_nickname/g,"");var a='<div class="pmessenger_nicknames"><header class="colors-popup-h">'+lang.messenger_edit_nicknames+'</header>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="messenger_nicknames_cnt"><div id="vy_ms__nickname_err" class="error"></div><ul>'+_+"</ul>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>";o.html(a)}),a.on("click",function(a){evstop(a,1);let o=$.trim(n("#messenger_recipient_nickname").val()),_=$.trim(n("#messenger_my_nickname").val());if(n("#vy_ms__nickname_err").html('<div class="div-loader"></div>'),s>0)return i.setNicknameInGroup(_,s,c);jAjax(i.ajax_url,"post",{cmd:"setnickname",userid:escape(e),nickname_recipient:o,my_nickname:_}).done(function(s){var a=generateRoomId(e,_U.i);if(1!=s)return n("#vy_ms__nickname_err").text(lang.Messenger_error+" "+s);if($.trim(n("#messenger_recipient_nickname").val())||$.trim(n("#messenger_my_nickname").val())){var c=$.trim(n("#messenger_my_nickname").val())?n("#messenger_my_nickname").val():"";i.writeNotification("nickname_added*"+_U.fn+"*"+c+"*"+o+"*"+_,"nicknames",r,a)}else i.writeNotification("nickname_cleared*"+_U.fn+"*","nicknames",r,a);""!=$.trim(n("#messenger_recipient_nickname").val())?(n("#messenger_"+e).find(".xweeWrt").text(n("#messenger_recipient_nickname").val()),n("#mshortcut-"+e).find(".mshortcut-u-name-str>a").text(n("#messenger_recipient_nickname").val())):(n("#messenger_"+e).find(".xweeWrt").text(decodeURIComponent(t)),n("#mshortcut-"+e).find(".mshortcut-u-name-str>a").text(decodeURIComponent(t))),i.closeModernPopup()})})})},this.sWriteNotification=function(e,t,s){s=!!s&&(s.includes("mshortcut-")?s:"mshortcut-"+s);var a=i.shortcut?i.shortcut:i.pmessenger;switch(a=a.find(".vy_ms__groupusermsgs:last"),t){case"nicknames":var o=(e=e.split("*"))[0],r=e[1];e[2];switch(o){case"nickname_added":a.after(i.notif__markup.replace("%text",r+"&nbsp;"+lang.messenger_notif_changed_nickname));break;case"nickname_cleared":a.after(i.notif__markup.replace("%text",r+"&nbsp;"+lang.messenger_notif_removed_nickname))}break;case"colors":o=(e=e.split("*"))[0],r=e[1];var c=e[2];e[3];let _=i.mess_colors.hasOwnProperty(c)&&i.mess_colors[c].img?"background-color:"+c+";background-image:"+i.mess_colors[c].img+";background-attachment:fixed;":"background-color:"+c+";";a.after(i.notif__markup.replace("%text",'<span class="vy_ms__notificaton_colorupdated" style="'+_+'"></span> '+r+"&nbsp;"+lang.messenger_notif_changed_color)),n("#"+s).length,i.colorateStrokes(c,s),i.curr_color=c}s?(messenger_shortcut.instant_focusChatTab(s),setTimeout(function(){messenger_shortcut.scrollChat(s)},100)):i.scrollChat()},this.writeNotification=function(e,t,s,n,a,o,r){r>0?jAjax(i.ajax_url,"post",{cmd:"get-group-details",group:escape(r)}).done(function(s){i.socket.emit("groups_color_notif",JSON.stringify({Notif:e,Room:n,Recipient:_U.i,Userid:r,Group_id:socketId("GG"+r),Group_data:validateJson(s),Group_clean_id:r,Page_id:o,User:_U,Category:t}))}):i.socket.emit("messenger_notification",JSON.stringify({Notif:e,Room:n,Recipient:_U.i,Userid:socketId(i.curr_recipient),Group_id:r,Page_id:o,Data:{user:_U,msg:{text:""},notif:{categ:e.split("*")[0],nickname1:e.split("*")[e.split("*").length-2],nickname2:e.split("*")[e.split("*").length-1]}},Category:t})),r<=0&&i.sWriteNotification(e,t,s)},this.changeColor=function(e,t){return modernPopup(function(s,n){var a='<li><div class="mess_color %active" onclick="messenger.setColor(this,'+e+","+t+');" data-color="%m_color" style="background-image:%m_image;background-color:%m_color;"><i class="sp_color-sel" alt="" style="color: %m_color;"></i></div></li>';i.shortcut&&(a='<li><div class="mess_color %active" onclick="mess_shortcut(\''+i.shortcut_id+"').setColor(this,"+e+","+t+');" data-color="%m_color" style="background-image:%m_image;background-color:%m_color;"><i class="sp_color-sel" alt="" style="color: %m_color;"></i></div></li>');var o="";n.html('<div class="div-loader"></div>');let r={cmd:"getChatCurColor",userid:escape(e)};t>0&&(r.group=escape(t)),jAjax(i.ajax_url,"post",r).done(function(e){for(var t in i.mess_colors)o+=a.replace(/%m_color/g,i.mess_colors[t].color).replace(/%m_image/g,i.mess_colors[t].img||"none").replace("%active",e==i.mess_colors[t].color?"active":"");var s='<div class="pmessenger_colors"><header class="colors-popup-h">'+lang.messenger_pick_color+'</header>\t\t\t\t\t\t\t\t\t\t\t\t<div class="messenger_colors_cnt"><ul>'+o+"</ul>\t\t\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t\t\t</div>";n.html(s),i.hasTouchStartEvent&&n.find("ul").animate({scrollLeft:parseInt(n.find(".mess_color.active").offset().left)-20},900),i.pmessenger.find("#mess-curr-color").val(a)}),s.on("click touchend",function(e){i.closeModernPopup()})},1)},this.appendNewMessages2=function(e,t,s){var a=!i.pmessenger.length,o=e.text.replace(/\\/g,""),r=e.time,c=e.min_text.replace(/\\/g,""),_=e.page_id,l=e.group_id,d=e.msgid,m=(e.rd,e.bg),u=t.id,g=t.online,p=t.avatar,v=e.timestamp,h=e.curr_date,f=t.fullname,y=_>0?g_messenger_count[t.id+"_"+_]:l>0?g_messenger_count["GG"+l]:g_messenger_count[t.id],b=t.online_ago,w=e.forwarded,k=e.reply;i.recipient_last_message_timestamp=v;let j="conversation:/messenger/"+(_>0?t.id+"/"+_:l>0?"g/"+l:t.id);if(_ms_Cache.exist(j))jAjax(i.ajax_url,"post",{cmd:"get-cache-message",id:escape(t.id),group:escape(l),page:escape(_)}).done(function(e){e=validateJson(e),i.updateConversationCache(e,j)});if(i.pmessenger.length)if("0"==n("#messenger_with_user").val()&&l==n("#messenger_with_group").val())i.pmessenger.find(".typing").remove(),i.scrollNow=!0,(S=n(".pmessenger-message-txt:last")).hasClass("_me")?this.avatar=!0:this.avatar=!1,global_messenger_count=s,i.apMessage(d,u,u,p,t.fullname,r,o,g,m,this.avatar,1,y,v,h,0,l,w,k),i.appendMessageInContacts(c,u,v,r,"",1,!1,0,l),vy_ms__window_tab_active&&(i.count_minus=1,s-=1);else if(n("#messenger_with_user").val()==u&&_<=0&&"none"==n("#messenger_with_page").val()&&l<=0){i.pmessenger.find(".typing").remove(),i.scrollNow=!0,(S=n(".pmessenger-message-txt:last")).hasClass("_me")?this.avatar=!0:this.avatar=!1,global_messenger_count=s,i.apMessage(d,u,u,p,t.fullname,r,o,g,m,this.avatar,1,y,v,h,0,0,w,k),i.appendMessageInContacts(c,u,v,r,"",1,!1),y,vy_ms__window_tab_active&&(i.count_minus=1,s-=1)}else if(n("#messenger_with_user").val()==u&&_==n("#messenger_with_page").val()&&l<=0){i.pmessenger.find(".typing").remove(),i.scrollNow=!0,(S=n(".pmessenger-message-txt:last")).hasClass("_me")?this.avatar=!0:this.avatar=!1,global_messenger_count=s,i.apMessage(d,u,u,p,t.fullname,r,o,g,m,this.avatar,1,y,v,h,_,0,w,k),i.appendMessageInContacts(c,u,v,r,"",1,!1,_),y,vy_ms__window_tab_active&&(i.count_minus=1,s-=1)}else n("#contact-"+u).length&&_<=0&&l<=0?(i.appendMessageInContacts(c,u,v,r,"",!1,y),y):_>0&&n("#contact-"+u+"_"+_).length&&(l<=0||!l)?(i.appendMessageInContacts(c,u,v,r,"",!1,y,_),y):l>0&&n("#contact-GG"+l).length&&(!_||_<=0)?(i.appendMessageInContacts(c,u,v,r,"",!1,y,0,l),y):(_>0&&l<=0?messenger.prependContact("",window.event,p,f,u,b,c,y,!0,!1,_):l>0&&(!_||_<=0)?messenger.prependContact("",window.event,p,f,u,b,c,y,!0,!1,!1,l):messenger.prependContact("",window.event,p,f,u,b,c,y,!0),y);if(n("#mshortcut-"+u).length&&_<=0&&l<=0){var x=n("#"+(G="mshortcut-"+u));n("#mshortcut-"+u).find(".typing").remove();var C=(S=x.find(".pmessenger-message-txt:last")).length?tonum(S.attr("id")):0;if(global_messenger_count=s,x.hasClass("_focus")&&vy_ms__window_tab_active&&(s-=1),x.hasClass("__none")&&a&&!x.hasClass("__nofit")&&messenger_shortcut.just_show("mshortcut-"+u),C==d)return s;S.hasClass("_me")?this.avatar=!0:this.avatar=!1;var M=this;if(mess_shortcut(G).apMessage(d,u,u,t.fullname,p,r,o,g,m,M.avatar,1,y,v,h,0,0,w,k),n("#mshortcut-"+u).hasClass("__nofit"))n("#nonfit-"+u).find(".js_new_msg_count").html(y),messenger_shortcut.nonfitcount_new_msg[u]=y,i.nonFitCount()}else if(n("#mshortcut-"+u+"_"+_).length&&_>0){(x=n("#"+(G="mshortcut-"+u+"_"+_))).find(".typing").remove();C=(S=x.find(".pmessenger-message-txt:last")).length?tonum(S.attr("id")):0;if(global_messenger_count=s,x.hasClass("_focus")&&vy_ms__window_tab_active&&(s-=1),x.hasClass("__none")&&a&&!x.hasClass("__nofit")&&messenger_shortcut.just_show(G),C==d)return s;S.hasClass("_me")?this.avatar=!0:this.avatar=!1;M=this;if(mess_shortcut(G).apMessage(d,u,u,p,t.fullname,r,o,g,m,M.avatar,1,y,v,h,_,0,w,k),n("#mshortcut-"+u+"_"+_).hasClass("__nofit"))n("#nonfit-"+u+"_"+_).find(".js_new_msg_count").html(y),messenger_shortcut.nonfitcount_new_msg[u+"_"+_]=y,i.nonFitCount()}else if(n("#mshortcut-GG"+l).length&&l>0){var G;(x=n("#"+(G="mshortcut-GG"+l))).find(".typing").remove();var S;C=(S=x.find(".pmessenger-message-txt:last")).length?tonum(S.attr("id")):0;if(global_messenger_count=s,x.hasClass("_focus")&&vy_ms__window_tab_active&&(s-=1),x.hasClass("__none")&&a&&!x.hasClass("__nofit")&&messenger_shortcut.just_show(G),C==d)return s;S.hasClass("_me")?this.avatar=!0:this.avatar=!1;M=this;if(mess_shortcut(G).apMessage(d,u,u,p,t.fullname,r,o,g,m,M.avatar,1,y,v,h,0,l,w,k),n("#mshortcut-GG"+l).hasClass("__nofit"))n("#nonfit-GG"+l).find(".js_new_msg_count").html(y),messenger_shortcut.nonfitcount_new_msg["GG"+l]=y,i.nonFitCount()}else if(a){var T={};if(T.id=u,T.fullname=f,T.photo=p,_&&(T.page_id=_),l){T.group=l,jAjax(i.ajax_url,"post",{cmd:"get-group-details",group:escape(l)}).done(function(e){e=validateJson(e),T.fullname=e.group_name,T.id=l,T.photo=e.group_avatar,messenger_shortcut.open(!1,!1,T,1)})}else if(_>0){jAjax(i.ajax_url,"post",{cmd:"get-page-details",page:escape(_)}).done(function(e){e=validateJson(e),T.fullname=e[1]==_U.i?f+" ("+e[0]+")":e[0],T.photo=e[1]==_U.i?p:e[2],T.page_avatar=e[2],messenger_shortcut.open(!1,!1,T,1)})}else messenger_shortcut.open(!1,!1,T,1)}return i.unmute_wo_timeout=setTimeout(function(){i.unmute_wo()},1e5),global_messenger_count=s,s},this.appendNewMessages=function(e,t,s){clearTimeout(i.unmute_wo_timeout),i.mute_wo();for(var a=!i.pmessenger.length,o=0;o<e.length;o++){var r=e[o].message,c=(t=e[o].user,r.text.replace(/\\/g,"")),_=r.time,l=r.min_text.replace(/\\/g,""),d=r.page_id,m=r.msgid,u=(r.rd,r.bg),g=t.id,p=t.online,v=t.avatar,h=r.timestamp,f=r.curr_date,y=t.fullname,b=r.count,w=t.online_ago;if(i.recipient_last_message_timestamp=h,i.pmessenger.length)if(n("#messenger_with_user").val()==g&&d<=0&&"none"==n("#messenger_with_page").val())i.pmessenger.find(".typing").remove(),i.scrollNow=!0,(G=n(".pmessenger-message-txt:last")).hasClass("_me")?this.avatar=!0:this.avatar=!1,global_messenger_count=s,i.apMessage(m,g,g,v,t.fullname,_,c,p,u,this.avatar,1,b,h,f),i.appendMessageInContacts(l,g,h,_,"",1,!1),b,vy_ms__window_tab_active&&(i.count_minus=1,s-=1);else if(n("#messenger_with_user").val()==g&&d==n("#messenger_with_page").val()){i.pmessenger.find(".typing").remove(),i.scrollNow=!0,(G=n(".pmessenger-message-txt:last")).hasClass("_me")?this.avatar=!0:this.avatar=!1,global_messenger_count=s,i.apMessage(m,g,g,v,t.fullname,_,c,p,u,this.avatar,1,b,h,f,d),i.appendMessageInContacts(l,g,h,_,"",1,!1,d),b,vy_ms__window_tab_active&&(i.count_minus=1,s-=1)}else n("#contact-"+g).length&&d<=0?(i.appendMessageInContacts(l,g,h,_,"",!1,b),b):d>0&&n("#contact-"+g+"_"+d).length?(i.appendMessageInContacts(l,g,h,_,"",!1,b,d),b):(d>0?messenger.prependContact("",window.event,v,y,g,w,l,b,!0,!1,d):group_id>0?messenger.prependContact("",window.event,v,y,g,w,l,b,!0,!1,0,group_id):messenger.prependContact("",window.event,v,y,g,w,l,b,!0),b);if(n(".nav_tool_friends_online #friend_"+g).length&&!messenger_shortcut.isfocus("mshortcut-"+g)){var k=n(".nav_tool_friends_online #friend_"+g);k.find("#online-friend-new-msg-count").length?k.find("#online-friend-new-msg-count>span").text("+"+b):k.find(".online_u_cnt").prepend('<div class="online-friend-new-msg-count" id="online-friend-new-msg-count"><span>+'+b+"</span></div>"),b<=0&&k.find("#online-friend-new-msg-count").remove()}if(n("#mshortcut-"+g).length&&d<=0){var j=n("#"+(M="mshortcut-"+g));n("#mshortcut-"+g).find(".typing").remove();var x=(G=j.find(".pmessenger-message-txt:last")).length?tonum(G.attr("id")):0;if(global_messenger_count=s,j.hasClass("_focus")&&vy_ms__window_tab_active&&(s-=1),j.hasClass("__none")&&a&&!j.hasClass("__nofit")&&messenger_shortcut.just_show("mshortcut-"+g),x==m)return s;G.hasClass("_me")?this.avatar=!0:this.avatar=!1;var C=this;if(mess_shortcut(M).apMessage(m,g,g,v,t.fullname,_,c,p,u,C.avatar,1,b,h,f),n("#mshortcut-"+g).hasClass("__nofit"))n("#nonfit-"+g).find(".js_new_msg_count").html(b),messenger_shortcut.nonfitcount_new_msg[g]=b,i.nonFitCount()}else if(n("#mshortcut-"+g+"_"+d).length&&d>0){var M;(j=n("#"+(M="mshortcut-"+g+"_"+d))).find(".typing").remove();var G;x=(G=j.find(".pmessenger-message-txt:last")).length?tonum(G.attr("id")):0;if(global_messenger_count=s,j.hasClass("_focus")&&vy_ms__window_tab_active&&(s-=1),j.hasClass("__none")&&a&&!j.hasClass("__nofit")&&messenger_shortcut.just_show(M),x==m)return s;G.hasClass("_me")?this.avatar=!0:this.avatar=!1;C=this;if(mess_shortcut(M).apMessage(m,g,g,v,t.fullname,_,c,p,u,C.avatar,1,b,h,f,d),n("#mshortcut-"+g+"_"+d).hasClass("__nofit"))n("#nonfit-"+g+"_"+d).find(".js_new_msg_count").html(b),messenger_shortcut.nonfitcount_new_msg[g+"_"+d]=b,i.nonFitCount()}else if(a){var S={};S.id=g,S.fullname=y,S.photo=v,d&&(S.page_id=d),messenger_shortcut.open(!1,!1,S,1)}}return i.unmute_wo_timeout=setTimeout(function(){i.unmute_wo()},1e5),global_messenger_count=s,s},this.nonFitCount=function(){var e=0,t=0;n(".js_messenger_nonfit_count_calc").each(function(){var t=n(this),s=t.attr("id"),i=t.find(".js_new_msg_count").text()?parseInt(t.find(".js_new_msg_count").text()):0;i>0&&e++,messenger_shortcut.nonfitcount_new_msg[s]=i}),t=e>99?"99+":e;var s=n(".js_messenger-shortcuts-nonfit-count"),i=s.find("span");e>0?(s.removeClass("__none"),i.html(t)):(s.addClass("__none"),i.html("0"))},this.join_rooms=function(){i.socket_rooms.push(i.room_id),"null"==i.socket_messages&&(i.socket_messages=1)},this.updateTopBubble=function(e){gwtlog.getCounts(),Object.keys(e).length},this.close_search=function(){return n("#messenger-search-result").hide().find(".nano-content").empty(),n("#messages-tick").show(),nanoScrollStart(),i.scrollChat(),n("#messenger_search_enabled").remove()},this.search=function(e,t,s){n("#messenger_search_enabled").length?i.close_search():(n("#pmessenger-contact-header").append('<div id="messenger_search_enabled" class="mess_search_header">\t\t\t<div class="messenger-search-arr" onclick="messenger.close_search();"><i class="mess-header-ic close"></i></div>\t\t\t<div class="mess_search_header_input _5iwm">\t\t\t<label class="_58ak"><input onkeypress="clearTimeout(this.messenger_search_timeout);" onkeydown="clearTimeout(this.messenger_search_timeout);" onkeyup="var _this = this;clearTimeout(_this.messenger_search_timeout);if(event.keyCode == 27) {return messenger.close_search();} _this.messenger_search_timeout = setTimeout(function(){ clearTimeout(_this.messenger_search_timeout);messenger.searchInConversation(_this,event,'+t+","+s+');  },500);" placeholder="'+lang.messenger_search_in_conversation+'" type="text" id="messenger-search-input" /></label>\t\t\t</div>\t\t\t<div class="messenger-search-status"></div>\t\t\t<div class="messenger-search-arrows">\t\t\t<div class="messenger-search-arr" onclick="messenger.searchInConv(this,\'up\')"><i class="mess-header-ic up"></i></div>\t\t\t<div class="messenger-search-arr" onclick="messenger.searchInConv(this,\'down\')"><i class="mess-header-ic down"></i></div>\t\t\t</div>\t\t\t</div>'),n(document).off("keyup.closeMessengerSearch").on("keyup.closeMessengerSearch","body",function(e){27==e.keyCode&&i.close_search()}))},this.searchInConv=function(e,t){var s=function(e){n(".messenger_conv_marks").each(function(){var e=n(this).html();n(this).replaceWith(e)});var t=n("#messenger-search-input").val(),s=n("#msg_"+e).find(".txt_pmessenger-text"),i=s.text(),a=s=s[0],o=t;(o=o.replace("[.*+?^${}()|[]\\]","\\$&")).length>0?a.innerHTML=i.replace(o,'<mark class="messenger_conv_marks">$&</mark>'):a.innerHTML=i},a=function(){n("#mess-header-zero-res").text(Math.ceil(i.search_in_conv_curr_id+1)),n("#messenger-search-result .nano").nanoScroller({scrollTop:n("#msg_"+i._search_conv_messages[i.search_in_conv_curr_id]).position().top-50})};switch(t){case"up":if(!$.trim(n("#messenger-search-input").val()))return!1;i.search_in_conv_curr_id=void 0===i._search_conv_messages[i.search_in_conv_curr_id]?i._search_conv_messages.length-1:i.search_in_conv_curr_id,s(i._search_conv_messages[i.search_in_conv_curr_id]),a(),i.search_in_conv_curr_id--;break;case"down":if(!$.trim(n("#messenger-search-input").val()))return!1;i.search_in_conv_curr_id=void 0===i._search_conv_messages[i.search_in_conv_curr_id]?0:i.search_in_conv_curr_id,s(i._search_conv_messages[i.search_in_conv_curr_id]),a(),i.search_in_conv_curr_id++}},this.searchInConversation=function(e,t,s,a){t.preventDefault();var o=n(e).val();if($.trim(o)){n("#messages-tick").hide(),n("#messenger-search-result").show().find(".nano-content").html('<div class="div-loader"></div>'),i.search_in_conv_curr_id=0;var r={cmd:"search-in-conversation",userid:escape(i.curr_recipient),key:urlencode(o)};s>0&&(r.page=escape(s)),a>0&&(r.group=escape(a)),i.stop_xhr("searchinconv");var c=jAjax(i.ajax_url,"post",r,!1,"searchinconv");n("#pmessenger-contact-header").css("pointer-events","none"),c.done(function(e){n("#pmessenger-contact-header").css("pointer-events","auto");var t=validateJson(e);if(0==t.count)n(".messenger-search-status").html("0&nbsp;"+lang.messenger_search_conv_count_results),n("#messenger-search-result").show().find(".nano-content").html('<div class="mess-search-conv-empty">'+lang.messenger_search_conv_empty.replace("%key","<strong>"+o+"</strong>")+"</div>");else{n(".messenger-search-status").html('<span id="mess-header-zero-res">0</span>&nbsp;/&nbsp;'+t.count+"&nbsp;"+lang.messenger_search_conv_count_results);var s="",r=0,c=!0,_=0;i._search_conv_messages=new Array;for(var l=0;l<t.messages.length;l++){var d=t.messages[l];c=r!=d.lastby;var m=(n("#messenger-search-result .messenger_date_delim:first").length?n("#messenger-search-result .messenger_date_delim:first").text():"")==d.dateMonth,u=!(r==d.lastby&&r>0&&d.date==_&&_>0);let e=(u=!(d.date===_||m||!u))?'<div id="messenger_date_delim_'+d.dateMonth+'" class="messenger_date_delim">'+d.dateMonth+"</div>":"",o=d.from_id!=r&&a>0?d.user_fullname:"",g=void 0!==t.messages[l+1]?t.messages[l+1].from_id:0,p=d.from_id==_U.i?"":'<div class="sticky__txt_pmessenger-user-avatar"><img src="'+d.user_avatar+'" /></div>',v=d.from_id!=r&&g!=_U.i&&r!=_U.i?"vy_ms__group_msg_margin":"";s+=e+(d.from_id!=r?'<div data-group-id="'+d.from_id+'" class="vy_ms__groupusermsgs '+v+" "+(d.from_id==_U.i?"me":"")+'">'+p:"")+i.getMessagesMarkup(d,d.from_id==_U.i?"me":"",c,u,d.timestamp,o,d.forwarded)+(g!=d.from_id||0==g?"</div>":""),i._search_conv_messages.push(d.id),r=d.lastby,_=d.date}n("#messenger-search-result").show().find(".nano-content").html('<div id="messenger-nano-content-fullheight">'+s+"</div>"),i.colorateStrokes(i.current_color()),nanoScrollStart()}})}},this.removeBlacklist=function(){var e=i.pmessenger;i.shortcut&&(e=i.shortcut),e.find(".blocked_u_no_pm").remove(),e.removeClass("blacklist")},this.outFromGroup=function(e){var t=i.pmessenger;i.shortcut&&(t=i.shortcut),0==t.find(".blocked_u_no_pm").length&&(i.shortcut?t.find(".messenger-shortcut-footer").prepend('<div class="blocked_u_no_pm">'+e+"</div>"):t.find(".pmessenger-msg-list-contenteditable").prepend('<div class="blocked_u_no_pm">'+e+"</div>")),setTimeout(function(){t.find(".blocked_u_no_pm").addClass("__up")},1e3),t.find("#messenger_aria_options").empty(),t.find("#messenger_aria_options_chat").empty(),t.addClass("blacklist")},this.isInBlackList=function(){var e=i.pmessenger;i.shortcut&&(e=i.shortcut),0==e.find(".blocked_u_no_pm").length&&(i.shortcut?e.find(".messenger-shortcut-footer").prepend('<div class="blocked_u_no_pm">'+jprintf(lang.pm_user_to_blacklist,"")+"</div>"):e.find(".pmessenger-msg-list-contenteditable").prepend('<div class="blocked_u_no_pm">'+jprintf(lang.pm_user_to_blacklist,i.recipient_fullname)+"</div>")),setTimeout(function(){e.find(".blocked_u_no_pm").addClass("__up")},1e3),e.find("#messenger_aria_options").empty(),e.find("#messenger_aria_options_chat").empty(),e.addClass("blacklist")},this.privacy_html=function(e){var t=i.pmessenger;i.shortcut&&(t=i.shortcut),0==t.find(".blocked_u_no_pm").length&&(i.shortcut?t.find(".messenger-shortcut-footer").prepend('<div class="blocked_u_no_pm">'+e+"</div>"):t.find(".pmessenger-msg-list-contenteditable").prepend('<div class="blocked_u_no_pm">'+jprintf(e,i.recipient_fullname)+"</div>")),setTimeout(function(){t.find(".blocked_u_no_pm").addClass("__up")},1e3),t.find("#messenger_aria_options").empty(),t.find("#messenger_aria_options_chat").empty(),t.addClass("blacklist")},this.deleteScreenshot=function(e){e.preventDefault(),n(e.target).closest(".screenshot").remove()},this.uploadScreenshot=function(e,t,s){if(1!=localStorage.getItem("uploading_screenshot")){localStorage.setItem("uploading_screenshot",1),setTimeout(function(){localStorage.removeItem("uploading_screenshot")},1e4);var a=Math.floor(2*Math.random()),o=n('<div class="screenshot_uploading soh-s chat_media_img"><a href="javascript:void(0);" id="delete_attach_'+a+'" onclick="messenger.deleteMedia(this,event);" class="foh-s messenger_delete_screen js_messenger_delete_screen"><span>Remove</span></a><div class="messenger_screenshot js_messenger_screenshot"></div></div>'),r=0,c=0;i.shortcut_id?(r=n("#"+i.shortcut_id).find("#upload_room_id").val(),Object.keys(t).length&&(recipientId=t.userid,c=t.page_id)):(n("#WD_attach_files_PM").prepend(o),r="room_"+i.room_id),i.uploadingMedia=1,i.send_important=1,i.uploading_media_disable_func("enable",i.shortcut_id_num),jAjax(i.ajax_url,"post",{cmd:"uploadscreen",room_id:r,to:escape(recipientId),data:urlencode(e)}).done(function(e){var t=validateJson(e);if(i.uploadingMedia=0,localStorage.removeItem("uploading_screenshot"),1!=t.success)return o.find(".js_messenger_delete_screen").click(),displayErr("Error at uploading your screenshot.");o.removeClass("screenshot_uploading"),o.find(".js_messenger_delete_screen").attr("id",t.id),o.find(".js_messenger_screenshot").attr({"d-src":t.id,style:"background-image:url(/messenger.php?cmd=atch&id="+t.id+")"});var n="[divstart][img]"+t.id+"[/img][divend]";if(i.shortcut_id)if(c){const e=recipientId;mess_shortcut(i.shortcut_id).send(0,i.event,n,e,c)}else s>0?mess_shortcut(i.shortcut_id).send(0,i.event,n,0,0,s):mess_shortcut(i.shortcut_id).send(0,i.event,n);else i.send(0,i.event,n,i.shortcut_id)})}},this.deleteMedia=function(e,t){evstop(t);var s=(e=n(e)).attr("id");e.parent().remove();jAjax(i.ajax_url,"post","cmd=deletemedia&id="+s)},this.load_more_contacts=function(e){e=n(e),++i.more_contacts_page;var t=n("#messenger-contacts-last").find(".nano-content"),s=t.children().length;jAjax(i.ajax_url,"post","cmd=moreConversations&pagecount="+escape(i.more_contacts_page)+"&s_at="+s+"&token="+(new Date).getTime()).done(function(s){0!=s?(t.find(".messenger-load-more-contacts-loader").before(s),setTimeout(function(){nanoScrollStart(),i.initTouchEvents()},100)):(i.loaded_all_contacts=1,e.parent().remove())})},this.check_for_pages=function(e,t){var s=0,n=tonum(e);return e.includes("_")&&t?(s=e.split("_")[1],n=tonum(e.split("_")[0])):t||void 0===e.split("_")[2]||(s=e.split("_")[2],n=tonum(e.split("_")[1])),[n,s]},this.fetch_url=function(e,t){t=n(t);var s=i.shortcut_id?n("#"+i.shortcut_id):i.pmessenger,a=s.find("#messenger-link-preview"),o=s.find("#upload_room_id").val(),r=i.shortcut_id?i.check_for_pages(i.shortcut_id,1):i.check_for_pages(i.pmessenger.attr("id")),c=r[0];r=r[1],jAjax(i.ajax_url,"post",{cmd:"fetchurl",url:encodeURIComponent(e),room_id:escape(o)},!1,"fetch-url").done(function(s){if(0!=s){const _=validateJson(s);if("yes"==_.send_now){i.force_bg=1;var n=":)";"yes"==_.embera&&(n="[embera]"+_.preview+" [/embera]"),"image"==_.type&&"no"==_.embera&&(n="[divstart][img]"+_.id+"[/img][divend] "+e),"video"==_.type&&"no"==_.embera&&(n="[vdivstart][video]"+_.id+"[/video][vdivend] "+e),i.shortcut_id?r>0?mess_shortcut(i.shortcut_id).send(0,i.event,n,c,r):mess_shortcut(i.shortcut_id).send(0,i.event,n,c):i.send(0,i.event,n,i.shortcut_id),t.html("")}else{let t={},s="",n="",r=i.random_id(),c='<svg onclick="messenger.remove_attach(this,event,'+r+')" class="svgIcon curpointer" height="16px" width="16px" version="1.1" viewBox="0 0 16 16" x="0px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" y="0px"><g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1"><g transform="translate(-712.000000, -1096.000000)"><g stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" transform="translate(709.000000, 320.000000)"><path d="M5.833,778.833 L16.167,789.167"></path><path d="M16.167,778.833 L5.833,789.167"></path></g></g></g></svg>';for(var o in _.hasOwnProperty("image")&&(t.image='<img src="'+_.image+'" />',n=t.image),_.hasOwnProperty("title")&&(t.title='<div class="mess_fetch_title">'+_.title+"</div>"),_.hasOwnProperty("description")&&(t.description='<div class="mess_fetch_descr">'+_.description+"</div>"),_.hasOwnProperty("site_name")&&(t.site_name='<div class="mess_fetch_sitename"><a href="'+_.url+'" target="_blank">'+_.site_name+"</a></div>"),t)s+="image"==o?"":t[o];a.html('<div id="mess_attach_'+r+'" class="messenger-live-preview-link-container">'+n+'<div class="mess_fetch_infotxt">'+s+"</div>"+c+"</div>"),a.children().addClass("slideup"),i.msg_with_preview={id:r,msg:"[url-preview]"+e+"[/url-preview]"},i.shortcut_id&&(messenger_shortcut.msg_with_preview=i.msg_with_preview,messenger_shortcut.msg_with_preview.shortcut_id=i.shortcut_id)}}})},this.remove_attach=function(e,t,s){i.msg_with_preview=!1,i.shortcut_id&&(messenger_shortcut.msg_with_preview=!1),n("#mess_attach_"+s).removeClass("slideup").on(i.crossEvent(),function(){n(this).remove()})},this.random_id=function(){return Date.now()+Math.floor(99*Math.random())},this.pasteMessages=function(e,t,s,n){for(var a=(t.clipboardData||t.originalEvent.clipboardData).items,o=null,r=0;r<a.length;r++)0===a[r].type.indexOf("image")&&(o=a[r].getAsFile());if(null!==o){evstop(t,1);var c=new FileReader;c.onload=function(e){var t=e.target.result;i.shortcut_id?mess_shortcut(i.shortcut_id).uploadScreenshot(t,s,n):i.uploadScreenshot(t,s,n)},c.readAsDataURL(o)}var _=(t.originalEvent||t).clipboardData.getData("text/plain");/(http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/.test(_)&&i.fetch_url(_,e)},this.toggle_sound=function(){i.pm_sound_enable()?(createCookie("dk_pm_sound","off"),sound_o_f()):(createCookie("dk_pm_sound","on"),sound_o_f(1),setTimeout("turnOnSound();",100))},this.pm_sound_enable=function(){return 1},this.turnOnSound=function(){i.pm_sound_enable()&&ms__new_message.play()},this.send_msg_sound=function(){!i.hasTouchStartEvent||readCookie("messenger_tsmsg_disb")&&1==readCookie("messenger_tsmsg_disb")||("_ios"==i.mob_agent?soundManager.play("send_message",{multiShotEvents:!0,from:200,onfinish:function(){this.stop()}}):soundManager.play("send_message"))},this.confirm_sound=function(){"_ios"==i.mob_agent?soundManager.play("tap",{multiShotEvents:!0,from:200,onfinish:function(){this.stop()}}):soundManager.play("tap")},this.enableSendMessageSound=function(){createCookie("messenger_tsmsg_disb","")},this.disableSendMessageSound=function(){createCookie("messenger_tsmsg_disb",1,100)},this.add_media=function(e,t,s,a,o){var r=(e=n(e)).closest(".mmmm_c_m");switch(t){case"video":r.find(".js_messenger_add_video").click();break;case"device_files":r.find("._type_photo_from_computer").click();break;case"images":r.find("._type_photo").click();break;case"gif":i.get_gifs(e,s,o)}},this.get_bottom_mess_buttons=function(e,t,s,n){s=s||!1,n=n||0,e=e||20,e=i.hasTouchStartEvent?40:e;var a="."+i.photoTypes.join(",."),o="."+i.videoTypes.join(",.");let r="",c={};if(i.hasTouchStartEvent&&!s&&(c.more=s?"":'<li id="vy_ms__btn_mob_mmedia" ontouchend="messenger.openMobileMoreMediaBtns(event,this);" class="_39bk">\t\t\t\t\t\t<span>'+i.svgi.js.mobile.media_more.replace(/%s/g,e)+"</span>\t\t\t\t\t\t</li>"),c.location='<li title="'+lang.messenger_share_location+'" onclick="evstop(event,1);messenger.sendLocation(this,event,'+t+","+s+", "+n+');" class="_39bk"><a href="javascript:void(0);">\t\t\t\t\t<svg fill="#666" rel="mess-colorate-this-fill" width="'+e+'px" height="'+e+'px" x="0px" y="0px" viewBox="-119 -21 682 682.66669">\t\t\t\t\t<g>\t\t\t\t\t\t<path d="m216.210938 0c-122.664063 0-222.460938 99.796875-222.460938 222.460938 0 154.175781 222.679688 417.539062 222.679688 417.539062s222.242187-270.945312 222.242187-417.539062c0-122.664063-99.792969-222.460938-222.460937-222.460938zm67.121093 287.597656c-18.507812 18.503906-42.8125 27.757813-67.121093 27.757813-24.304688 0-48.617188-9.253907-67.117188-27.757813-37.011719-37.007812-37.011719-97.226562 0-134.238281 17.921875-17.929687 41.761719-27.804687 67.117188-27.804687 25.355468 0 49.191406 9.878906 67.121093 27.804687 37.011719 37.011719 37.011719 97.230469 0 134.238281zm0 0"/>\t\t\t\t\t</g>\t\t\t\t\t</svg>\t\t\t\t\t<span class="_3dxr3_tit">'+lang.Messenger_mob_more_medi_btn_location+"</span></a></li>",c.images='<li title="'+lang.messenger_send_photos+"\"\tonclick=\"evstop(event,1);messenger.add_media(this,'device_files',"+t+","+s+", "+n+');" class="_39bk"><a href="javascript:void(0);">\t\t\t\t\t<svg width="'+e+'px" height="'+e+'px" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100;">\t\t\t\t\t<g>\t\t\t\t\t\t\t<path fill="#666" rel="mess-colorate-this-fill" d="M50,40c-8.285,0-15,6.718-15,15c0,8.285,6.715,15,15,15c8.283,0,15-6.715,15-15    C65,46.718,58.283,40,50,40z M90,25H78c-1.65,0-3.428-1.28-3.949-2.846l-3.102-9.309C70.426,11.28,68.65,10,67,10H33    c-1.65,0-3.428,1.28-3.949,2.846l-3.102,9.309C25.426,23.72,23.65,25,22,25H10C4.5,25,0,29.5,0,35v45c0,5.5,4.5,10,10,10h80    c5.5,0,10-4.5,10-10V35C100,29.5,95.5,25,90,25z M50,80c-13.807,0-25-11.193-25-25c0-13.806,11.193-25,25-25    c13.805,0,25,11.194,25,25C75,68.807,63.805,80,50,80z M86.5,41.993c-1.932,0-3.5-1.566-3.5-3.5c0-1.932,1.568-3.5,3.5-3.5    c1.934,0,3.5,1.568,3.5,3.5C90,40.427,88.433,41.993,86.5,41.993z"/>\t\t\t\t\t\t</g>\t\t\t\t\t</svg>\t\t\t\t\t<span class="_3dxr3_tit">'+lang.Messenger_mob_more_medi_btn_img+"</span></a></li>",c.videos='<li title="'+lang.messenger_send_videos+"\"\tonclick=\"evstop(event,1);messenger.add_media(this,'video',"+t+","+s+","+n+');" class="_39bk"><a href="javascript:void(0);">\t\t\t\t\t<svg width="'+e+'px" height="'+e+'px" x="0px" y="0px" viewBox="0 -87 432 432" style="enable-background:new 0 0 100 100;">\t\t\t\t\t<g>\t\t\t\t\t\t\t<path fill="#666" rel="mess-colorate-this-fill" d="m278.90625 0h-248.90625c-16.5625.0195312-29.9804688 13.4375-30 30v197.421875c.0195312 16.5625 13.4375 29.980469 30 30h248.90625c16.558594-.019531 29.980469-13.4375 30-30v-197.421875c-.019531-16.5625-13.441406-29.9804688-30-30zm0 0"/>\t\t\t\t\t\t\t<path fill="#666" rel="mess-colorate-this-fill" d="m328.90625 169.800781 103.09375 56.285157v-194.105469l-103.09375 56.285156zm0 0"/>\t\t\t\t\t\t</g>\t\t\t\t\t</svg>\t\t\t\t\t<span class="_3dxr3_tit">'+lang.Messenger_mob_more_medi_btn_videos+"</span></a></li>",s||(c.gifs=s?"":'<li title="'+lang.messenger_open_gifs+"\" onclick=\"evstop(event,1);messenger.add_media(this,'gif',"+t+","+s+", "+n+');" class="_39bk"><a href="javascript:void(0);">\t\t\t\t\t<svg fill="#666" rel="mess-colorate-this-fill" width="'+e+'px" height="'+e+'px" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;">\t\t\t\t\t<g>\t\t\t\t\t\t<g>\t\t\t\t\t\t\t<g>\t\t\t\t\t\t\t\t<path d="M146.286,146.286H36.571C14.629,146.286,0,164.571,0,182.857v146.286c0,18.286,14.629,36.571,36.571,36.571h109.714     c21.943,0,36.571-18.286,36.571-36.571V256H128v54.857H54.857V201.143h128v-18.286     C182.857,164.571,168.229,146.286,146.286,146.286z"/>\t\t\t\t\t\t\t\t<polygon points="512,201.143 512,146.286 347.429,146.286 347.429,365.714 402.286,365.714 402.286,292.571 475.429,292.571      475.429,237.714 402.286,237.714 402.286,201.143    "/>\t\t\t\t\t\t\t\t<rect x="237.714" y="146.286" width="54.857" height="219.429"/>\t\t\t\t\t\t\t</g>\t\t\t\t\t\t</g>\t\t\t\t\t</g>\t\t\t\t\t</svg>\t\t\t\t\t</a></li>'),s||(c.stickers=s?"":'<li title="'+lang.messenger_open_stickers+'" onclick="evstop(event,1);messenger.openStickers(this,event,false,'+t+","+s+", "+n+');" class="_39bk"><a href="javascript:void(0);">\t\t\t\t\t<svg width="'+e+'px" height="'+e+'px" x="0px" y="0px" viewBox="0 0 294.996 294.996" style="enable-background:new 0 0 294.996 294.996;">\t\t\t\t\t<g>\t\t\t\t\t\t<path fill="#666" rel="mess-colorate-this-fill" d="M280.977,118.478c-13.619-10.807-20.563-27.57-18.574-44.845c1.3-11.3-2.566-22.393-10.607-30.432  c-8.044-8.043-19.136-11.909-30.434-10.607c-17.281,1.986-34.037-4.954-44.844-18.573C169.449,5.11,158.872,0,147.499,0  c-11.374,0-21.951,5.11-29.021,14.02c-10.807,13.618-27.564,20.56-44.841,18.575c-11.3-1.305-22.393,2.563-30.435,10.605  c-8.043,8.04-11.909,19.133-10.609,30.435c1.989,17.272-4.954,34.035-18.576,44.844C5.11,125.549,0,136.126,0,147.498  s5.109,21.949,14.019,29.021c13.62,10.808,20.563,27.57,18.574,44.845c-1.3,11.3,2.566,22.393,10.607,30.432  c8.044,8.043,19.145,11.911,30.434,10.607c17.274-1.988,34.037,4.954,44.844,18.573c7.069,8.91,17.646,14.021,29.021,14.021  c11.373,0,21.95-5.11,29.02-14.02c10.808-13.618,27.565-20.559,44.841-18.575c11.301,1.299,22.393-2.563,30.435-10.605  c8.043-8.04,11.909-19.133,10.609-30.434c-1.989-17.273,4.955-34.037,18.576-44.845c8.907-7.07,14.017-17.647,14.017-29.02  S289.886,125.549,280.977,118.478z"/>\t\t\t\t\t</g>\t\t\t\t\t</svg>\t\t\t\t\t</a></li>'),s||(c.microphone=s?"":'<li title="'+lang.messenger_hold_to_record+'" rel-shortcut="'+(t||"zero")+'" onclick="messenger.startRecordingEvents(event,this,'+(t?1:0)+", "+n+');" id="messenger-recording-button" class="_39bk">\t\t\t\t\t<span><svg fill="#666" rel="mess-colorate-this-fill" x="0px" y="0px" width="'+e+'px" height="'+e+'px" viewBox="0 0 96.667 96.666" style="enable-background:new 0 0 96.667 96.666;">\t\t\t\t\t<g>\t\t\t\t\t\t\t<path d="M48.333,73.296c9.519,0,17.263-7.744,17.263-17.262V17.262C65.596,7.743,57.852,0,48.333,0c-9.519,0-17.262,7.743-17.262,17.262v38.773C31.071,65.553,38.814,73.296,48.333,73.296z"/>\t\t\t\t\t\t\t<path d="M76.078,45.715h-3.437c-1.104,0-2,0.896-2,2v7.029c0,12.3-10.008,22.308-22.309,22.308S26.025,67.044,26.025,54.744v-7.029c0-1.104-0.896-2-2-2h-3.437c-1.104,0-2,0.896-2,2v7.029c0,14.707,11.433,27.667,26.026,29.506v4.98h-15.35c-1.104,0-2,0.896-2,2v3.436c0,1.104,0.896,2,2,2h38.138c1.104,0,2-0.896,2-2V91.23c0-1.104-0.896-2-2-2H52.051v-4.98c14.594-1.838,26.026-14.799,26.026-29.506v-7.029C78.078,46.61,77.182,45.715,76.078,45.715z"/>\t\t\t\t\t\t</g>\t\t\t\t\t</svg>\t\t\t\t\t<svg class="microphone-disabled-iconsvg __none">\t\t\t\t\t\t<line x1="0" y1="100%" x2="100%" y2="0"\t\t\t\t\t\t\tstyle="stroke:rgb(255,0,0);stroke-width:2"/>\t\t\t\t\t</svg></span>\t\t\t\t\t</li>'),i.hasTouchStartEvent&&!s&&(i.mob_hidden_btns.location=c.location,i.mob_hidden_btns.images=c.images,i.mob_hidden_btns.videos=c.videos),i.hasTouchStartEvent&&!s)for(var _ in i.mob_hidden_btns)delete c[_];for(var _ in c)r+=c[_];return'<div class="_4rv4 js__4rv4"><div class="mdialog_send_message_loader _55yn _55yo _55ym"></div>\t\t\t\t\t<input type="file" name="files" accept="'+a+"\" onchange=\"messenger.start_upload(event,'image',"+t+","+s+","+n+');" multiple="multiple" class="_type_photo_from_computer __none" />\t\t\t\t\t<input class="js_messenger_add_video __none" type="file" multiple="multiple" name="file" accept="'+o+"\" onchange=\"messenger.start_upload(event,'video',"+t+","+s+", "+n+');"/>\t\t\t\t\t<ul class="_39bj">'+r+"</ul>\t\t\t\t\t</div>"},this.getMoreMobMediaBtns=function(){let e="",t="";for(var s in i.mob_hidden_btns)e+=i.mob_hidden_btns[s];return t='<section ontouchend="evstop(event);" onclick="evstop(event);" id="vy_ms__mobmm_btns" class="vy_ms__mobmm_btns"><ul>'+e+"</ul></section>"},this.openMobileMoreMediaBtns=function(e,t){evstop(e,1);let s=n(t),a=i.pmessenger.find(".js__pmessenger_footer");s.hasClass("_open")?i.closeMobileMoreMediaBtns():(s.addClass("_open"),a.prepend(i.getMoreMobMediaBtns()),i.colorateStrokes(i.current_color()),setTimeout(function(){a.find("#vy_ms__mobmm_btns").addClass("_up").on(i.crossEvent(),function(){n(this).css({zIndex:"5"})})},100),n(document).off("touchend.closeMobMediaBtn").on("touchend.closeMobMediaBtn",function(e){i.closeMobileMoreMediaBtns()}))},this.closeMobileMoreMediaBtns=function(){let e=i.pmessenger.find(".js__pmessenger_footer");n(document).off("touchend.closeMobMediaBtn"),i.pmessenger.find("#vy_ms__btn_mob_mmedia").removeClass("_open"),e.find("#vy_ms__mobmm_btns").removeAttr("style"),setTimeout(function(){e.find("#vy_ms__mobmm_btns").removeClass("_up").on(i.crossEvent(),function(){n(this).remove()})},100)},this.open_mobile_settings=function(e,t,s,a){evstop(e),t=n(t);const o=n("#messenger_with_user").val(),r=n("#messenger_recipient_name").val();var c="";(s>0&&i.group_admin>0||!s)&&(c+='<li><a data-action="color" class="js_messenger_mob_opt messenger_mob_option"><div class="messenger_mob_svg">'+i.svgi.js.mobile.change_color+"</div>"+lang.Messenger_Change_color+"</a></li>"),c+='<li><a data-action="nickname" class="js_messenger_mob_opt messenger_mob_option"><div class="messenger_mob_svg">'+i.svgi.js.mobile.change_nickname+"</div>"+lang.Messenger_Edit_nickname+"</a></li>",c+='<li><a data-action="notification" class="js_messenger_mob_opt messenger_mob_option"><div class="messenger_mob_svg">'+i.mob__default_md_ic(o,s)+"</div>"+lang.Messenger_Notifications+"</a></li>",c+=readCookie("messenger_tsmsg_disb")&&1==readCookie("messenger_tsmsg_disb")?'<li><a data-action="send_msg_sound_enable" class="js_messenger_mob_opt messenger_mob_option"><div class="messenger_mob_svg">'+i.svgi.js.mobile.tap_sound_disabled+"</div>"+lang.Messenger_Enable_sending_sound+"</a></li>":'<li><a data-action="send_msg_sound_disable" class="js_messenger_mob_opt messenger_mob_option"><div class="messenger_mob_svg">'+i.svgi.js.mobile.tap_sound_enabled+"</div>"+lang.Messenger_Disable_sending_sound+"</a></li>",s||a||(c+='<li><div class="messenger_mob_option__delim"></div></li>',c+='<li><a data-action="to_blacklist" class="js_messenger_mob_opt messenger_mob_option"><div class="messenger_mob_svg">'+i.svgi.js.mobile.block+"</div>"+lang.messenger_block_user+"</a></li>"),s>0&&i.group_admin>0?(c+='<li><div class="messenger_mob_option__delim"></div></li>',c+='<li><a data-action="group_manage_members" class="js_messenger_mob_opt messenger_mob_option"><div class="messenger_mob_svg">'+i.svgi.js.group_members+"</div>"+lang.Messenger_Group_Edit_Members+"</a></li>",c+='<li><a data-action="group_clear" class="js_messenger_mob_opt messenger_mob_option"><div class="messenger_mob_svg">'+i.svgi.js.group_clear+"</div>"+lang.Messenger_Clear_Group_Conversation+"</a></li>",c+='<li><a data-action="group_delete" class="js_messenger_mob_opt messenger_mob_option"><div class="messenger_mob_svg">'+i.svgi.js.group_delete+"</div>"+lang.Messenger_Group_Delete+"</a></li>",c+='<li><a data-action="group_exit" class="js_messenger_mob_opt messenger_mob_option"><div class="messenger_mob_svg">'+i.svgi.js.mobile.exit_group+"</div>"+lang.Messenger_Leave_Group+"</a></li>"):s>0&&i.group_admin<=0&&(c+='<li><a data-action="group_exit" class="js_messenger_mob_opt messenger_mob_option"><div class="messenger_mob_svg">'+i.svgi.js.mobile.exit_group+"</div>"+lang.Messenger_Leave_Group+"</a></li>"),s||(c+='<li><a data-action="delete_conversation" class="js_messenger_mob_opt messenger_mob_option"><div class="messenger_mob_svg">'+i.svgi.js.mobile.delete_conversation+"</div>"+lang.delete_conversation+"</a></li>"),a||(c+='<li><a data-action="fullscreen" class="js_messenger_mob_opt messenger_mob_option"><div class="messenger_mob_svg">'+i.svgi.js.mobile.fullscreen+"</div>"+lang.Messenger_toggle_fullscreen+"</a></li>");const _='<div class="js_messenger_mobile_opts messenger_mobile_opts"><div class="js_messenger_ovr messenger_layer_ovr"></div><ul>'+c+"</ul></div>";if(!n("body").find(".js_messenger_mobile_opts").length){n("body").append(_);const e=n(".js_messenger_mobile_opts");n(document).off(i.hasTouchStartEvent?"touchend.mmob_settings_opt":"click.mmob_settings_opt").on(i.hasTouchStartEvent?"touchend.mmob_settings_opt":"click.mmob_settings_opt",".js_messenger_mob_opt",function(e){const t=n(this).data("action"),c=this;messenger.close_mobile_settings(function(){switch(t){case"color":messenger.changeColor(i.curr_recipient,s);break;case"nickname":messenger.setNicknames(o,r,s);break;case"to_blacklist":messenger.contactToBlacklist(e,c);break;case"send_msg_sound_disable":messenger.disableSendMessageSound();break;case"send_msg_sound_enable":messenger.enableSendMessageSound();break;case"group_clear":messenger.clearGroupMsgs(e,s);break;case"group_delete":messenger.DeleteGroup(e,s);break;case"group_manage_members":messenger.ManageGroupMembers(e,s);break;case"group_exit":messenger.exitGroup(e,s);break;case"notification":messenger.muteContact(o,s);break;case"delete_conversation":messenger.deleteConversation(e,a);break;case"fullscreen":messenger.toFullScreen(e)}})}),n(document).off(i.hasTouchStartEvent?"touchend.closeiosMenu":"click.closeiosMenu").on(i.hasTouchStartEvent?"touchend.closeiosMenu":"click.closeiosMenu",".js_messenger_ovr",function(e){evstop(e),i.close_mobile_settings()}),setTimeout(function(){e.addClass("shownow")},250)}},this.close_mobile_settings=function(e){n(".js_messenger_mobile_opts > ul").css("transform","translate3d(0px, 100%, 0) translateZ(0)").on(i.crossEvent(),function(){n(this).parent().remove(),setTimeout(e,500),n("body").find(".js_messenger_ovr").fadeOut(function(){n(this).remove()})})},this.startRecordingEvents=function(e,t,s,a){evstop(e,1),t=n(t);var o=!1;t.removeAttr("onclick"),t.off(i.hasTouchStartEvent?"touchstart.recording":"mousedown.recording").on(i.hasTouchStartEvent?"touchstart.recording":"mousedown.recording",function(){var e="zero"!=n(this).attr("rel-shortcut")&&n(this).attr("rel-shortcut");i.audiorecorder_shortcut=a>0?"GG"+a:e,i.audiorecorder_btn=n(this),o=!0,i.recording_timeout&&clearTimeout(i.recording_timeout),o&&(i.recording_timeout=setTimeout(function(){i.startRecordingVoiceClip(t,e),t.addClass("recording"),i.pmessenger.length&&i.hasTouchStartEvent&&n(".recording_microphone_gif").removeClass("__none")},100))}),t.off(i.hasTouchStartEvent?"touchend.recording":"mouseup.recording").on(i.hasTouchStartEvent?"touchend.recording":"mouseup.recording",function(){var e="zero"!=n(this).attr("rel-shortcut")&&n(this).attr("rel-shortcut");i.audiorecorder_shortcut=a>0?"GG"+a:e,i.audiorecorder_btn=n(this),i.recording_timeout&&clearTimeout(i.recording_timeout),t.removeClass("recording"),i.pmessenger.length&&i.hasTouchStartEvent&&n(".recording_microphone_gif").addClass("__none"),i.stopRecordingVoiceClip(t,e,a),o=!1})},this.startRecordingVoiceClip=function(e){if(i.mediaRecorderConstructed)return;navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(t){e.removeClass("microphonenotallowed"),e.find(".microphone-disabled-iconsvg").addClass("__none"),i.messenger_local_stream=t,i.mediaRecorderConstructed=!0;const s=(new AudioContext).createMediaStreamSource(i.messenger_local_stream);i.voice_clip_media_recorder=new Recorder(s,{numChannels:1}),i.voice_clip_media_recorder.record()}).catch(function(t){return i.messenger_local_stream=!1,e.addClass("microphonenotallowed").removeClass("recording"),e.find(".microphone-disabled-iconsvg").removeClass("__none"),modernPopup(function(){},1,'<div style="color:red;text-align: center; padding: 16px;font-weight: bold;">Error: '+t.toString()+'</div><br/><div style="font-weight:bold;text-align:center;">'+lang.please_enable_your_microphone+"</div>")})},this.stopRecordingVoiceClip=function(){i.voice_clip_media_recorder&&i.voice_clip_media_recorder.stop(),i.messenger_local_stream&&i.messenger_local_stream.getAudioTracks()[0].stop(),void 0!==i.voice_clip_media_recorder&&i.voice_clip_media_recorder.exportWAV(i.sendVoiceClip)},this.sendVoiceClip=function(e){if(i.mediaRecorderConstructed){var t=!i.hasTouchStartEvent&&(i.audiorecorder_shortcut?"mshortcut-"+i.audiorecorder_shortcut:""),s=i.audiorecorder_shortcut?n("#mshortcut-"+i.audiorecorder_shortcut).find("#upload_room_id").val():"room_"+n("#mess-roomid").val(),a=new FormData;a.append("cmd","send-voice-clip"),a.append("clip",e),a.append("extension",i.voice_clip_extension),a.append("room_id",s),a.append("recipient_id",i.audiorecorder_shortcut),$.ajax({type:"POST",url:i.ajax_url,data:a,processData:!1,contentType:!1}).done(function(e){e=validateJson(e);let s=t?t.includes("GG")?t.split("GG")[1]:0:i.pmessenger.find("#messenger_with_group").val();if(1!=e.success)return displayErr(lang.somethingWrong);t&&s<=0?mess_shortcut(t).send(!1,!1,e.text):t&&s>0?mess_shortcut(t).send(!1,!1,e.text,!1,!1,s):i.send(!1,i.event,e.text)}),i.messenger_local_stream&&i.messenger_local_stream.getAudioTracks()[0].stop(),i.audiorecorder_shortcut=!1,i.audiorecorder_btn=!1,i.mediaRecorderConstructed=!1}},this.getMobileOperatingSystem=function(){var e=navigator.userAgent||navigator.vendor||window.opera;return/windows phone/i.test(e)?"_windows":/android/i.test(e)?"_android":/iPad|iPhone|iPod/.test(e)&&!window.MSStream?"_ios":"_smartphone"},this.SimulateWindowPopupForMobileDevices=function(e,t,s,a,o){const r=n(".pmessenger #audio-video-mob-conference");if(!r.find("#audiovideoconf-htmldom").length){r.show().html('<div id="audiovideoconf-htmldom"><iframe id="iframe-audio-video-conference" style="width:100%;height:100%;" src="'+o+"&iframe=yes&v="+(new Date).getTime()+'"></iframe></div>'),i.pmessenger.addClass("zindex1031");for(var c=window.frames,_=0;_<c.length;_++)c[_].call=s}},this.removeVideoAudioConferenceIframe=function(){i.pmessenger.removeClass("zindex1031"),n("#audio-video-mob-conference").hide().html("")},this.createCallingPopup=function(e,t,s,n){var a,o={cmd:"call",userid:t,view_as:"json",v:(new Date).getTime()};switch(e){case"answer-video":a="/messenger?ismobile=no&view_as=json&cmd=call&action=answer&type=video&userid="+t+"&v="+(new Date).getTime(),o.action="answer",o.type="video";break;case"answer-audio":a="/messenger?ismobile=no&view_as=json&cmd=call&action=answer&type=audio&userid="+t+"&v="+(new Date).getTime(),o.action="answer",o.type="audio";break;case"initiate-video-call":a="/messenger?ismobile=no&view_as=json&cmd=call&action=call&type=video&userid="+t+"&v="+(new Date).getTime(),o.action="call",o.type="video";break;case"initiate-audio-call":a="/messenger?ismobile=no&view_as=json&cmd=call&action=call&type=audio&userid="+t+"&v="+(new Date).getTime(),o.action="call",o.type="audio"}var r=null!=window.screenLeft?window.screenLeft:screen.left,c=null!=window.screenTop?window.screenTop:screen.top,_=(window.innerWidth?window.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width)/2-390+r,l=(window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:screen.height)/2-295+c;if(window.focus&&_U.i in newCallWindow?newCallWindow[_U.i].focus():i.hasTouchStartEvent?i.SimulateWindowPopupForMobileDevices(o,t,s,n,a):(newCallWindow[_U.i]=window.open(a,"popUpWindow","height=590,width=780,left="+_+",top="+l+",resizable=yes,scrollbars=no,toolbar=no,menubar=yes,location=yes,directories=no, status=no"),s&&(newCallWindow[_U.i].call=s),newCallWindow[_U.i].call_user_answered=call_user_answered,newCallWindow[_U.i].sio=sio,newCallWindow[_U.i].existingCall=existingCall,remainOnSite("You have a calling window","CallWindow"+_U.i,function(){for(x in newCallWindow)newCallWindow[x].close()})),!i.hasTouchStartEvent)var d=window.setInterval(function(){try{(null==newCallWindow[_U.i]||newCallWindow[_U.i].closed)&&(window.clearInterval(d),delete newCallWindow[_U.i],unbindRemainOnSite("CallWindow"+_U.i),existingCall&&existingCall.close(),call_user_answered?n.emit("call_finished",t):n.emit("call_stopped",t),existingCall=!1)}catch(e){return modernPopup(function(){},1,e.toString())}},1e3)},this.setUpVoiceVideoCallButtons=function(e,t,s){n(document).off(i.hasTouchStartEvent?"touchend.call_video":"click.call_video").on(i.hasTouchStartEvent?"touchend.call_video":"click.call_video","#start-video-chat",function(e){e.preventDefault(),e.stopImmediatePropagation(),vy_calls.makeCall(!1,"video",i.curr_recipient)}),n(document).off(i.hasTouchStartEvent?"touchend.call_audio":"click.call_audio").on(i.hasTouchStartEvent?"touchend.call_audio":"click.call_audio","#start-audio-chat",function(e){e.preventDefault(),e.stopImmediatePropagation(),vy_calls.makeCall(!1,"audio",i.curr_recipient)}),"audio"==s&&i.hasTouchStartEvent?vy_calls.start_call(!1,"audio",i.curr_recipient):"video"==s&&i.hasTouchStartEvent&&vy_calls.start_call(!1,"video",i.curr_recipient)},this.hangUpCall=function(e,t){evstop(t),i.existingCall.close()},this.calling_video=function(e){i.existingCall&&i.existingCall.close(),e.on("stream",function(e){$("#their-video").prop("src",URL.createObjectURL(e))}),i.existingCall=e,e.on("close",step2),$("#step1, #step2").hide(),$("#step3").show()},this.emoji_convert=function(e){var t=joypixels.toImage(e);n("body").find("#emojione-test").remove(),n("body").append('<div style="display:none;" id="emojione-test">'+t+"</div>");var s=n("#emojione-test").text();return n("#emojione-test").remove(),i.scrollNow=!1,$.trim(s)&&void 0!==s?e:t},this.uploading_media_disable_func=function(e,t,s,a){var o=(t=a>0&&s<=0?"GG"+a:t)?n("#mshortcut-"+t).find(".messenger-shortcut-footer"):n(".pmessenger-msg-list-contenteditable");s&&t&&!a&&(o=n(".js_chat_with_page_"+s).find(".messenger-shortcut-footer")),"enable"==e?(i.uploadingMedia=1,o.hasClass("__uploading")||(o.addClass("__uploading"),o.prepend('<div class="messenger-uploading-text"><div class="div-loader"></div></div>'))):(i.uploadingMedia=0,o.removeClass("__uploading"),o.find(".messenger-uploading-text").remove())},this.uploadMedia=function(e,t,s,a,o,r,c,_){var l=JSON.stringify(new Array),d=0,m=e.length,u="",g=function(){var t=a.find("#mess_uploading_"+d);if(void 0===e[d]||d>m-1){for(var p=0;p<i.media_files.length;p++){var v=0==p?"video"==i.media_files[p][1]?"[vdivstart]":"[divstart]":"",h=p+1==i.media_files.length?"video"==i.media_files[p][1]?"[vdivend]":"[divend]":"";u+="video"==i.media_files[p][1]?v+"[video]"+escape(i.media_files[p][0])+"[/video]"+h:v+"[img]"+escape(i.media_files[p][0])+"[/img]"+h}return i.send_important=1,r?(c?mess_shortcut("mshortcut-"+r+"_"+c).send(0,s,u,r,c):_>0?mess_shortcut("mshortcut-"+r).send(0,s,u,r,!1,_):mess_shortcut("mshortcut-"+r).send(0,s,u),messenger_shortcut.instant_focusChatTab("mshortcut-"+r+(c?"_"+c:""))):i.send(0,s,u,i.shortcut_id,c),!1}switch(o){case"image":l=i.photoTypes;break;case"video":l=i.videoTypes}if(c)var f=r?n("#mshortcut-"+r+"_"+c).find("#upload_room_id").val():"room_"+n("#mess-roomid").val();else f=r?n("#mshortcut-"+r).find("#upload_room_id").val():"room_"+n("#mess-roomid").val();var y=new FormData;y.append("files",e[d]),y.append("cmd","upload-media"),y.append("type",o),y.append("allowed",JSON.stringify(l)),y.append("room_id",f),$.ajax({url:i.ajax_url,type:"POST",xhr:function(){var e=$.ajaxSettings.xhr();return e.upload&&e.upload.addEventListener("progress",function(e){var s=t.find(".m_uploading_bar");if(e.lengthComputable){var n=Math.round(e.loaded/e.total*100);s.css("height",n+"%")}},!1),e},beforeSend:function(){i.uploading_media_disable_func("enable",r,c,_)},success:function(e){var s=validateJson(e);if("OK"!==s.msg)return displayErr(s.msg);t.find(".js_messenger_screenshot").html("").attr({"d-src":s.id,style:"background-image:url(/messenger.php?cmd=atch&id="+s.id+"&type="+("video"==o?"video-cover":"")+")"}),t.find(".m_uploading_bar").remove(),t.find(".js_messenger_delete_screen").attr("id",s.id),t.find(".m_uploading_bar").remove(),i.media_files[d]=[s.id,o],d++,setTimeout(function(){g()},50)},error:function(){return displayErr("Something was wrong while processing your upload. Please try again.")},data:y,cache:!1,contentType:!1,processData:!1})};g()},this.upload_images=function(e,t,s,a){t=a>0&&s<=0?"GG"+a:t;var o=n(e.target),r=o[0].files,c=n(t?"#tchat_"+t:"#WD_attach_files_PM");if(s&&t&&(c=n("#tchat_"+t+"_"+s)),c.children().length>9||r.length>9)return displayErr(lang.messenger_max_upload);for(var _=0;_<r.length;_++){var l=r[_].name.split(".").pop().toUpperCase();if(-1==$.inArray(l,i.photoTypes)&&$.trim(l))return evstop(e),displayErr(lang.up_invalid_file_ext.replace("%s",i.photoTypes));c.prepend('<div class="soh-s chat_media_img" id="mess_uploading_%id%"><a href="javascript:void(0);" id="delete_attach_%id%" onclick="messenger.deleteMedia(this,event);" class="foh-s messenger_delete_screen js_messenger_delete_screen __none"><span>Remove</span></a><div class="messenger_screenshot js_messenger_screenshot">%name%</div><div class="m_uploading_bar"></div></div>'.replace(/%id%/,_).replace("%name%",r[_].name))}i.uploadMedia(r,o,e,c,"image",t,s,a)},this.upload_videos=function(e,t,s,a){t=a>0&&s<=0?"GG"+a:t;var o=n(e.target),r=o[0].files,c=n(t?"#tchat_"+t:"#WD_attach_files_PM");if(s&&t&&(c=n("#tchat_"+t+"_"+s)),c.children().length>9||r.length>9)return displayErr(lang.messenger_max_upload);for(var _=0;_<r.length;_++){var l=r[_].name.split(".").pop().toUpperCase();if(-1==$.inArray(l,i.videoTypes)&&$.trim(l))return evstop(e),displayErr(lang.up_invalid_file_ext.replace("%s",i.videoTypes));c.prepend('<div class="soh-s chat_media_img __video" id="mess_uploading_%id%"><a href="javascript:void(0);" id="delete_attach_%id%" onclick="messenger.deleteMedia(this,event);" class="foh-s messenger_delete_screen js_messenger_delete_screen"><span>Remove</span></a><div class="messenger_screenshot js_messenger_screenshot">%name%</div><div class="m_uploading_bar"></div></div>'.replace(/%id%/,_).replace("%name%",r[_].name))}i.uploadMedia(r,o,e,c,"video",t,s,a)},this.start_upload=function(e,t,s,n,a){switch(i.media_files=new Array,t){case"video":i.upload_videos(e,s,n,a);break;case"image":i.upload_images(e,s,n,a)}},this.close_gifs=function(e){var t=e?n("#mshortcut-"+e).find(".messenger_js_gifs"):i.pmessenger.find(".messenger_js_gifs");t.css("transform","translateY(0px)").on(i.crossEvent(),function(){t.remove(),t.parent().addClass("__none")}),i.pmessenger.removeClass("zindex1031")},this.get_gifs=function(e,t,s){if(t=t&&s>0?"GG"+s:t)var a=n("#mshortcut-"+t).find(".js_media_gifs");else a=i.pmessenger.find(".js_media_gifs");if(""==a.html()){e=n(e),a.removeClass("__none").empty().html('<div onclick="event.stopImmediatePropagation();" ontouchend="event.stopImmediatePropagation();" ontouchstart="event.stopImmediatePropagation();"  class="messenger_js_gifs messenger_gifs_container"><div class="messenger-gifs-header"><input type="text" id="gifs-search-val" placeholder="Search for gifs" /><div class="messenger-gif-search-loading js-messenger-gif-search-loading"></div></div><div class="messenger_gifs_content nano"><div class="nano-content overthrow js_messenger_gifs_cnt"></div></div></div>');var o=function(e,t){return t=t||"",e?o(--e,"0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz".charAt(Math.floor(60*Math.random()))+t):t},r=this;i.pmessenger.addClass("zindex1031"),n(document).on("keydown.closeGifs"+i.random_id(),function(e){27==e.keyCode&&i.close_gifs(t)}),n(document).on(i.hasTouchStartEvent?"touchend.closeGifs"+i.random_id():"click.closeGifs"+i.random_id(),"html,body",function(e){i.close_gifs(t)}),n(document).on(i.hasTouchStartEvent?"touchend.closeGifs"+i.random_id():"click.closeGifs"+i.random_id(),".messenger-shortcut-cnt",function(e){i.close_gifs(t)}),i.stop_xhr("get-gifs"),jAjax(i.ajax_url,"post","cmd=get-gifs&key="+o(2),!1,"get-gifs").done(function(e){a.find(".messenger_js_gifs").css("transform","translateY(-400px)");var i=validateJson(e),o=a.find("#gifs-search-val"),c=a.find(".js-messenger-gif-search-loading"),_=a.find("#gif-empty-input"),l=a.find(".messenger_js_gifs").find(".nano"),d=a.find(".js_messenger_gifs_cnt");o.focus();for(var m=0;m<i.data.length;++m){var u=i.data[m];d.append('<A id="'+u.id+'" data-gif="'+u.images.fixed_height.url+'" onclick="messenger.sendGif(this,event,\''+t+"',"+(s>0?s:0)+');" href="javascript:void(0);">\t\t\t\t\t\t<div  style="background-image:url('+u.images.fixed_height_small.url+')" ></div></a>')}setTimeout(function(){l.nanoScroller()},1e3),o.off("keyup.searchGif").on("keyup.searchGIf",function(e){var s=this;clearTimeout(r.srchGif_timeout),27!=e.keyCode&&(_.hide(),c.show(),r.srchGif_timeout=setTimeout(function(){messenger.searchGifs(s.value,"a",1,t)},1e3))}),o.off("keydown.searchGif keypress.searchGif").on("keydown.searchGIf keypress.searchGif",function(e){clearTimeout(r.srchGif_timeout),_.show()}),_.off("click.seaerchGifInputEmpty").on("click.seaerchGifInputEmpty",function(){o.val(""),o.trigger("keyup.searchGif"),n(this).hide()})})}else i.close_gifs(t)},this.searchGifs=function(e,t,s,a){var o=this;if(a=a||!1)var r=n("#mshortcut-"+a).find(".js_media_gifs");else r=i.pmessenger.find(".js_media_gifs");i.stop_xhr("ms-search-gifs"),jAjax(i.ajax_url,"post",{cmd:"get-gifs",key:e?escape(e):"smile"},!1,"ms-search-gifs").done(function(e){var t=validateJson(e),s=(r.find(".gif_index_cnt.nano"),r.find("#gif-empty-input")),n=r.find(".js-messenger-gif-search-loading"),i=r.find(".js_messenger_gifs_cnt");n.hide(),s.show(),i.empty();for(var c=0;c<t.data.length;++c){var _=t.data[c];o.gifUrl=_.images.fixed_height.url,i.append('<A id="'+_.id+'" data-gif="'+_.images.fixed_height.url+'" onclick="messenger.sendGif(this,event,\''+a+'\');" href="javascript:void(0);">\t\t\t\t\t\t<div  style="background-image:url('+_.images.fixed_height.url+')" ></div></a>')}})},this.sendGif=function(e,t,s,a){if(s="false"!=s&&"undefined"!=s&&s)n("#mshortcut-"+s).find(".js_media_gifs");else i.pmessenger.find(".js_media_gifs");evstop(t);(e=n(e)).data("send-in"),e.data("send-to");var o="[gif]"+e.data("gif")+"[/gif]";if(s){let e=s.includes("GG")?s.split("GG")[1]:0;mess_shortcut("mshortcut-"+s).send(0,t,o,!1,!1,e)}else i.send(0,t,o,i.shortcut_id);i.close_gifs(s)},this.close_stickers=function(e){var t=e?n("#mshortcut-"+e).find(".messenger_js_stickers"):i.pmessenger.find(".messenger_js_stickers");t.css("transform","translateY(0px)").on(i.crossEvent(),function(){t.remove(),t.parent().addClass("__none")}),i.pmessenger.removeClass("zindex1031")},this.openStickers=function(e,t,s,a,o,r,c){if(evstop(t),e=n(e),c){let t=e.closest(".pmessenger").length,s=t?i.pmessenger:e.closest(".messenger-shortcut-container"),n=t?0:s.attr("id"),o=n&&n.includes("GG")?n.split("GG")[1]:0;var _=s.find(".js_media_stickers");a=t?0:o>0?"GG"+o:tonum(n)}else if(a=a&&r>0?"GG"+r:a)_=n("#mshortcut-"+a).find(".js_media_stickers");else _=i.pmessenger.find(".js_media_stickers");if(_.removeClass("__none"),_.length||(_=i.pmessenger.length?i.pmessenger.find(".js_media_stickers"):n(".messenger-shortcut-container._focus").find(".js_media_stickers"),a=tonum(n(".messenger-shortcut-container._focus").attr("id"))),""!=_.html())return void i.close_stickers(a);e=n(e),_.empty().html('<div onclick="event.stopImmediatePropagation();" ontouchend="event.stopImmediatePropagation();" ontouchstart="event.stopImmediatePropagation();" class="messenger_js_stickers messenger_stickers_container"><div class="messenger-stickers-header"><input type="text" id="stickers-search-val" placeholder="Search for stickers" /><div class="messenger-gif-search-loading js-messenger-stickers-search-loading"></div><a href="javascript:void(0);" style="display:none;" class="messenger_stickers_close_search js_stickers_close_search"></a></div><div style="display:none;" class="stickers_header js_search_stickers_header"></div><div class="stickers_header js_stickers_header"></div><div class="messenger_stickers_content nano"><div class="nano-content overthrow js_messenger_stickers_cnt"><div class="div-loader"></div></div></div></div>');var l=this,d="",m=_.find(".js_stickers_header");i.pmessenger.addClass("zindex1031"),n(document).on("keydown.closeStickers"+i.random_id(),function(e){27==e.keyCode&&i.close_stickers(a)}),n(document).on(i.hasTouchStartEvent?"touchend.closeStickers"+i.random_id():"click.closeStickers"+i.random_id(),function(e){i.close_stickers(a)}),n(document).on(i.hasTouchStartEvent?"touchend.closeStickers"+i.random_id():"click.closeStickers"+i.random_id(),".messenger-shortcut-cnt",function(e){i.close_stickers(a)}),i.stop_xhr("ms-getsticker");var u=a?"shortcut":"messenger";jAjax(i.ajax_url,"post","cmd=get-stickers&from="+u,!1,"ms-getsticker").done(function(e){var t=validateJson(e);if(t.length>0){for(var n=0;n<t.length;n++){var i=t[n],o=i[0],c=i[1],u=i[2];d+='<a class="sticker-pk" onclick="messenger.openStickersPack(this,event,'+o+",'"+a+"',"+(r>0?r:0)+');" title="'+c+'"><div class="sticker-cover" style="background-image:url('+u+');"></div></a>'}m.html('<div id="stickers-slider-arrow-left" onclick="return messenger.slideStickers(this,\'back\');" class="stickers__slider-arrow _left stickers__slider-arrow_disabled"></div><div class="vy_ms__stickers-header-slider" id="vy_ms__stickers-header-slider">'+d+'</div><div id="stickers-slider-arrow-right" onclick="return messenger.slideStickers(this,\'forward\');" class="stickers__slider-arrow _right"></div>'),_.find(".messenger_js_stickers").css("transform","translateY(-400px)");var g=_.find("#stickers-search-val"),p=_.find(".js-messenger-stickers-search-loading");g.off("keyup.searchStickers").on("keyup.searchStickers",function(e){var t=this;clearTimeout(l.srchSTICKERS_timeout),27!=e.keyCode&&(m.hide(),p.show(),l.srchSTICKERS_timeout=setTimeout(function(){messenger.searchStickers(t.value,a)},1e3))}),g.off("keydown.searchStickers keypress.searchStickers").on("keydown.searchStickers keypress.searchStickers",function(e){clearTimeout(l.srchSTICKERS_timeout)}),s?g.val(s).trigger("keyup.searchStickers"):_.find(".sticker-pk:first").click()}})},this.slideStickers=function(e,t){switch(e=n(e),t){case"forward":e.parent().find("#vy_ms__stickers-header-slider").animate({scrollLeft:"+=250px"});break;case"back":e.parent().find("#vy_ms__stickers-header-slider").animate({scrollLeft:"-=250px"});break;default:return}i.slideStickersArrows()},this.slideStickersArrows=function(){var e="stickers__slider-arrow_disabled",t=n("#vy_ms__stickers-header-slider");t.hasScrollBar()||t.parent().find(".stickers__slider-arrow._right").addClass(e),t.off("scroll.horizontal").on("scroll.horizontal",function(t){var s=n(this),i=s.scrollLeft(),a=s.outerWidth(),o=s.get(0).scrollWidth;s.scrollLeft()>=10?s.parent().find(".stickers__slider-arrow._left").removeClass(e):s.parent().find(".stickers__slider-arrow._left").addClass(e),o-i===a?s.parent().find(".stickers__slider-arrow._right").addClass(e):s.parent().find(".stickers__slider-arrow._right").removeClass(e)})},this.searchStickers=function(e,t){if(t=t||!1)var s=n("#mshortcut-"+t).find(".js_media_stickers");else s=i.pmessenger.find(".js_media_stickers");var a=s.find(".js_search_stickers_header"),o=s.find(".js_stickers_close_search"),r="";i.stop_xhr("ms-searchsticker"),jAjax(i.ajax_url,"post","cmd=search-stickers&key="+escape(e),!1,"ms-searchsticker").done(function(e){s.find(".js-messenger-stickers-search-loading").hide(),o.show().on("click",function(e){evstop(e),s.find("#stickers-search-val").val(""),s.find(".js_stickers_header").show(),a.empty().hide(),o.hide()});for(var n=validateJson(e),i=0;i<n.length;i++)r+='<a class="sticker-pk" onclick="messenger.openStickersPack(this,event,'+n[i][0]+", '"+t+'\');" title="'+n[i][1]+'"><div class="sticker-cover" style="background-image:url('+n[i][2]+');"></div></a>';a.show().html(r).find(".sticker-pk:first").click()})},this.openStickersPack=function(e,t,s,a){evstop(t),e=n(e);var o=((a="false"!=a&&"undefined"!=a&&a)?n("#mshortcut-"+a).find(".js_media_stickers"):i.pmessenger.find(".js_media_stickers"))||!1;o||(o=i.pmessenger.length?i.pmessenger.find(".js_media_stickers"):n(".messenger-shortcut-container._focus").find(".js_media_stickers")),o.find(".sticker-pk").removeClass("active"),e.addClass("active"),i.stop_xhr("ms-open-sticker-pack");var r=o.find(".js_messenger_stickers_cnt"),c=jAjax(i.ajax_url,"post","cmd=open-sticker-pack&id="+escape(s),!1,"ms-open-sticker-pack");ajaxLoading(),c.done(function(e){removeAjaxLoad();for(var t=validateJson(e),n="",i=0;i<t.length;i++)n+='<a href="javascript:void(0);" data-src="'+t[i][1]+'" onclick="messenger.sendSticker(this,event,'+t[i][0]+",'"+a+"', "+escape(s)+');" class="stiycker" style="background-image:url('+t[i][1]+');"></a>';r.html(n),nanoScrollStart()})},this.sendSticker=function(e,t,s,n,a){evstop(t),n="false"!=n&&"undefined"!=n&&n;let o="[stickerid]"+s+"[/stickerid]",r=new Array,c=readCookie("vy_ms__recentstickers");if(n){let e=n.includes("GG")?n.split("GG")[1]:0;mess_shortcut("mshortcut-"+n).send(0,t,o,!1,!1,e)}else i.send(0,t,o,i.shortcut_id);if(i.close_stickers(n),c&&c.includes(",")){let e=c.split(","),t=e.length;for(;t--;)r.push(e[t])}else c&&!c.includes(",")&&r.push(c);r.length>=15&&r.splice(r[r.length.length-1],1),-1==r.indexOf(a)&&r.push(a),r=function(e){let t={},s=[],n=e.length;for(;n--;)e[n]in t||(s.push(e[n]),t[e[n]]=!0);return s.reverse(),s}(r),createCookie("vy_ms__recentstickers",r.join(","),99)},this.sendLocation=function(e,t,s,n,a){evstop(t,1),i.confirm_act(lang.messenger_confirm_send_location,function(e){var o;s=s&&a>0?"GG"+a:s;var r=function(e){if(!i.sended_location){var r="[sharelocation]"+e.coords.latitude+"="+e.coords.longitude+"[/sharelocation]";s?(mess_shortcut("mshortcut-"+s).send(0,t,r,s,n,a),messenger_shortcut.instant_focusChatTab("mshortcut-"+s)):i.send(0,t,r,i.shortcut_id,n,a),i.sended_location=!0,setTimeout(function(){i.sended_location=!1},5e3),navigator.geolocation.clearWatch(o)}};o=navigator.geolocation.watchPosition(function(e){navigator.geolocation.getCurrentPosition(r)},function(e){i.confirm_act(lang.Messenger_send_api_location,function(e){$.get("//freegeoip.app/json/",function(e){navigator.geolocation.clearWatch(o),r({coords:{latitude:e.latitude,longitude:e.longitude}})})},!1,lang.Messenger_confirm_sending_api_location,function(){})})},!1,lang.Messenger_agree_send_location,function(){})},this.theme=function(){return readCookie("mode")&&"night"==readCookie("mode")?"dark":"light"},this.confirm_act=function(e,t,s,n,a){let o={},r=(i.random_id(),{text:n||lang.messenger_delete_for_me,btnClass:"btn-blue",action:function(){t("me")}}),c={text:lang.messenger_cancel_button,action:function(){"function"==typeof a&&a()}},_={text:lang.messenger_delete_for_everyone,btnClass:"btn-red",action:function(){t("everyone")}};lang.Messenger_mob_copy_msg;s?(o.delete_everyone=_,o.confirm=r,o.cancel=c,$.confirm({title:lang.messenger_confirmation_title,content:e,icon:"fa fa-question-circle",animation:"none",closeAnimation:"none",onOpenBefore:function(){i.hasTouchStartEvent&&i.confirm_sound()},theme:i.theme(),opacity:.5,buttons:o,onContentReady:function(){},onClose:function(){i.enable_copytoclipboard_mob_btn=!1}})):(o.confirm=r,o.cancel=c,$.confirm({title:lang.messenger_confirmation_title,content:e,icon:"fa fa-question-circle",animation:"none",closeAnimation:"none",onOpenBefore:function(){i.hasTouchStartEvent&&i.confirm_sound()},theme:i.theme(),opacity:.5,buttons:o,onContentReady:function(){},onClose:function(){i.enable_copytoclipboard_mob_btn=!1}}))},this.mute_wo=function(){n("#message-sound").length&&(n("#message-sound")[0].volume=0)},this.unmute_wo=function(){n("#message-sound").length&&(n("#message-sound")[0].volume=1)},this.getGroupAdminMarkup=function(e){return'\t\t\t\t\t\t\t  <li><a onclick="messenger.editGroupChat(this,event,'+e+');" href="javascript:void(0);" class="vy_ms__group_admin_settings_button">'+i.svgi.js.group_edit+"&nbsp;"+lang.Messenger_Edit_Group+'</a></li>\t\t\t\t\t\t\t  <li><a onclick="messenger.ManageGroupMembers(event,'+e+');" href="javascript:void(0);" class="vy_ms__group_admin_settings_button">'+i.svgi.js.group_members+"&nbsp;"+lang.Messenger_Group_Edit_Members+'</a></li>\t\t\t\t\t\t\t  <li><a onclick="messenger.clearGroupMsgs(event,'+e+');" href="javascript:void(0);" class="vy_ms__group_admin_settings_button">'+i.svgi.js.group_clear+"&nbsp;"+lang.Messenger_Clear_Group_Conversation+'</a></li>\t\t\t\t\t\t\t  <li><a onclick="messenger.DeleteGroup(event,'+e+')" href="javascript:void(0);" class="vy_ms__group_admin_settings_button">'+i.svgi.js.group_delete+"&nbsp;"+lang.Messenger_Group_Delete+"</a></li>\t\t\t\t\t\t\t  "},this.join_group=function(e){i.socket.emit("vy_ms__joingroup",e)},this.openGroupAdmin=function(e,t,s){evstop(e,1);t=n(t);let a=function(e,t,s){"open"==e?(s.parent().prepend(t),s.addClass("group_admin_dropdown_active")):(i.pmessenger.find(".js__group_admin_settings_cnt").remove(),n(".group_admin_dropdown_active").removeClass("group_admin_dropdown_active"))},o='<div class="vy_ms__group_admin_settings_cnt js__group_admin_settings_cnt"><ul>'+i.getGroupAdminMarkup(s)+"</ul></div>";t.parent().find(".js__group_admin_settings_cnt").length?a("close"):a("open",o,t),n(document).off("click.closeGroupAdminPanel").on("click.closeGroupAdminPanel",function(e){evstop(e),a("close")}),n(document).off("keyup.closeGroupAdminPanel").on("keyup.closeGroupAdminPanel",function(e){evstop(e),27==e.keyCode&&a("close")})},this.merror=function(e){return modernPopup(function(){},1,'<div class="vy_ms__moderpopup_err">'+e+"</div>")},this.DeleteGroup=function(e,t,s){evstop(e,1),i.confirm_act(lang.Messenger_group_delete_confirm,function(e){var n={cmd:"delete-group",group:escape(t)};jAjax(i.ajax_url,"post",{cmd:"check-group-admin",group:t}).done(function(e){if(!e||e<=0)return modernPopup(function(){},1,'<div class="vy_ms__moderpopup_err">'+lang.Messenger_group_no_admin+"</div>");jAjax(i.ajax_url,"post",n).done(function(e){"success"==(e=validateJson(e)).s?(i.pmessenger.length&&i.pmessenger.find("#room_GG"+t+" #messenger-nano-content-fullheight").empty().html('<div class="vy_ms__group_cleared js__vy_ms__group_cleared">'+lang.Messenger_group_delete_confirm+"</div>"),i.groupNotification(_U.i,t,"group-deleted",_U.i,s,1)):modernPopup(function(){},1,'<div class="vy_ms__moderpopup_err">'+e.msg+"</div>")})})},!1,lang.Messenger_confirm_deleting_button,function(){})},this.exitGroup=function(e,t,s,a){evstop(e,1),s=n("#mshortcut-GG"+t).length&&!i.html.hasClass("messenger-window")?"mshortcut-GG"+t:0;n(e.target);i.confirm_act(lang.Messenger_confirm_exit_group,function(e){jAjax(i.ajax_url,"post",{cmd:"group-exit-check-owner",group:t}).done(function(e){if(e&&e>0)return a&&a("cancel"),modernPopup(function(){},1,'<div class="vy_ms__moderpopup_err">'+lang.Messenger_exit_glavnii_admin_from_group+"</div>");if(ajaxLoading(),!t)return!1;jAjax(i.ajax_url,"post",{cmd:"leave_group",group:escape(t),id:escape(_U.i)}).done(function(e){return removeAjaxLoad(),200==(e=validateJson(e)).status&&0==e.success?(a&&a("cancel"),modernPopup(function(){},1,'<div class="vy_ms__moderpopup_err">'+lang.Messenger_try_again+"</div>")):200!=e.status||1!=e.success?(a&&a("cancel"),modernPopup(function(){},1,'<div class="vy_ms__moderpopup_err">'+lang.Messenger_try_again+"</div>")):(a&&a("success"),i.groupNotification(_U.i,t,"user-exit-from-group",_U.i),void i.socket.emit("vy_ms__group_remove_member",JSON.stringify({Group_id:socketId("GG"+t),Room_id:socketId(generateRoomId(0,_U.i,0,t)),Group_clean_id:"GG"+t,Userid:socketId(_U.i),Userid_clean:_U.i,shortcut_id:s,own_exit:1,next_conversation:i.hasTouchStartEvent?"no":"yes"})))}).fail(function(){return a&&a("cancel"),modernPopup(function(){},1,'<div class="vy_ms__moderpopup_err">'+lang.Messenger_try_again+"</div>")})})},!1,lang.Messenger_confirm_btn_leaving_group,function(){a&&a("cancel")})},this.clearGroupMsgs=function(e,t,s){evstop(e,1),i.confirm_act(lang.Messenger_confirm_clear_group_messages,function(e){var n={cmd:"group-clear",group:escape(t)};jAjax(i.ajax_url,"post",{cmd:"check-group-admin",group:t}).done(function(e){if(!e||e<=0)return modernPopup(function(){},1,'<div class="vy_ms__moderpopup_err">'+lang.Messenger_group_no_admin+"</div>");jAjax(i.ajax_url,"post",n).done(function(e){"success"==(e=validateJson(e)).s?jAjax(i.ajax_url,"post",{cmd:"get-group-details",group:escape(t)}).done(function(e){i.socket.emit("vy_ms__group_clean",JSON.stringify({Group_id:socketId("GG"+t),Group_clean_id:"GG"+t,shortcut_id:s,User:_U,Group_data:validateJson(e)})),i.groupNotification(_U.i,t,"admin-clean-group",_U.i,s),nanoScrollStart()}):modernPopup(function(){},1,'<div class="vy_ms__moderpopup_err">'+e.msg+"</div>")})})},!1,lang.Messenger_confirm_deleting_button,function(){})},this.groupNotification=function(e,t,s,a,o,r){if(!e||!t||!s)return;o=n("#mshortcut-GG"+t).length&&!i.html.hasClass("messenger-window")?"mshortcut-GG"+t:0,jAjax(i.ajax_url,"post",{cmd:"get-user-details",id:escape(e)}).done(function(n){let a=validateJson(n),c="";switch(s){case"admin-removed-user":c="Messenger_user_removed_by_admin";break;case"admin-clean-group":c="Messenger_group_cleaned_by_admin";break;case"group-deleted":c="Messenger_group_deleted_by_admin";break;case"user-nickname-update":c="Messenger_group_nickname_updated";break;case"user-nickname-removed":c="Messenger_group_nickname_removed";break;case"user-exit-from-group":c="Messenger_user_exit_from_group"}i.socket.emit("vy_ms__group_notifications",JSON.stringify({Group_id:socketId("GG"+t),Group_clean_id:"GG"+t,Userid:e,notification:c,shortcut_id:o,die:r,categ:s,arg:{username:a.fullname,id:e,avatar:a.profile_photo}}))})},this.group_member_markup=function(e,t,s){let n=s?"invite":"remove",i=s?"messenger.group_invite_member(event,this,"+e.id+","+t+");":"messenger.group_remove_member(event,this,"+e.id+","+t+");";return'<li id="vy_ms__group_member_'+(s?"":"rm_")+e.id+"_"+t+'" onclick="messenger.group_members_e(this,event,'+e.id+","+t+",'"+n+'\');" class="vy_ms__groupchat_member '+("yes"==e.admin?"__admin":"")+" "+(s?"__invitation":"")+'"><div class="vy_ms__gcm01"><img src="'+e.avatar+'" /></div><div style="position:relative;"><username class="vy_ms__gcm02">'+e.fullname+'</username><span class="vy_ms_f54ccgf"><i title="Administrator" class="glyphicon glyphicon-ok-sign"></i></span></div><a href="javascript:void(0);" onclick="'+i+'"><span class="__none">'+("add"==s?lang.Messenger_add_new_members_to_group:lang.Messenger_remove_member_from_group)+"</span></a></li>"},this.GroupRemoveAdmin=function(e,t,s){if(!e.hasClass("__admin"))return i.GroupAddNewAdmin(e,t,s);e.removeClass("__admin"),jAjax(i.ajax_url,"post",{cmd:"group-remove-admin",group:escape(s),id:escape(t)}).done(function(t){"success"!=(t=validateJson(t)).s&&(modernPopup(function(){},1,'<div class="vy_ms__moderpopup_err">'+t.msg+"</div>"),e.addClass("__admin"))})},this.GroupAddNewAdmin=function(e,t,s){if(e.hasClass("__admin"))return i.GroupRemoveAdmin(e,t,s);e.addClass("__admin"),jAjax(i.ajax_url,"post",{cmd:"group-add-new-admin",group:escape(s),id:escape(t)}).done(function(t){"success"!=(t=validateJson(t)).s&&(modernPopup(function(){},1,'<div class="vy_ms__moderpopup_err">'+t.msg+"</div>"),e.removeClass("__admin"))})},this.group_remove_member=function(e,t,s,a,o){evstop(e,1),o=n("#mshortcut-GG"+a).length&&!i.html.hasClass("messenger-window")?"mshortcut-GG"+a:0;let r=n(t);jAjax(i.ajax_url,"post",{cmd:"check-group-admin",group:a}).done(function(e){if(!e||e<=0)return modernPopup(function(){},1,'<div class="vy_ms__moderpopup_err">'+lang.Messenger_group_no_admin+"</div>");if(!s||!a)return!1;jAjax(i.ajax_url,"post",{cmd:"leave_group",group:escape(a),id:escape(s)}).done(function(e){if(removeAjaxLoad(),200==(e=validateJson(e)).status&&0==e.success)r.text(lang.Messenger_try_again);else{if(200!=e.status||1!=e.success)return!1;r.closest("li").addClass("ms_user_request_sent"),r.replaceWith('<a href="javascript:void(0);"><span>'+lang.Messenger_member_removed_from_group+"</span></a>"),setTimeout(function(){n("#vy_ms__group_member_rm_"+s+"_"+a).slideUp(function(){n(this).remove()}),i.groupNotification(s,a,"admin-removed-user",_U.i)},2500),jAjax(i.ajax_url,"post",{cmd:"get-group-details",group:escape(a)}).done(function(e){i.socket.emit("vy_ms__group_remove_member",JSON.stringify({Group_id:socketId("GG"+a),Room_id:socketId(generateRoomId(0,s,0,a)),Group_clean_id:"GG"+a,Userid:socketId(s),Userid_clean:s,shortcut_id:o,User:_U,Group_data:validateJson(e),own_exit:0,next_conversation:"yes"}))})}}).fail(function(){r.text(lang.Messenger_try_again)})})},this.group_invite_member=function(e,t,s,a){evstop(e,1);let o=n(t);jAjax(i.ajax_url,"post",{cmd:"check-group-admin",group:a}).done(function(t){if(!t||t<=0)return modernPopup(function(){},1,'<div class="vy_ms__moderpopup_err">'+lang.Messenger_group_no_admin+"</div>");if(!s||!a)return!1;jAjax(i.ajax_url,"post",{cmd:"invite_to_group",group:escape(a),id:escape(s)}).done(function(t){if(removeAjaxLoad(),200==(t=validateJson(t)).status&&0==t.success)o.text(lang.Messenger_try_again);else{if(200!=t.status||1!=t.success)return!1;o.closest("li").addClass("ms_user_request_sent"),o.replaceWith('<a href="javascript:void(0);"><span>'+lang.Messenger_request_sent+"</span></a>"),setTimeout(function(){n("#vy_ms__group_member_"+s+"_"+a).slideUp(function(){n(this).remove()})},2500),jAjax(i.ajax_url,"post",{cmd:"get-group-details",group:escape(a)}).done(function(t){i.socket.emit("vy_ms__groupinvitation_sent",JSON.stringify({User:_U,Group_data:validateJson(t),Group_id:socketId("GG"+a),User_id:socketId(s),Group_clean_id:a,User_clean_id:s})),i.send(!1,e,"[group-invitation]"+_U.i+"|"+a+"[/group-invitation]",s,0,0,1,1)})}}).fail(function(){o.text(lang.Messenger_try_again)})})},this.filterGroupMembers=function(e,t){var s,i,a,o,r;if(s=t.value.toUpperCase(),(i=n("#vy_ms__groupchat_all_members__id")).length)for(a=i[0].getElementsByTagName("li"),r=0;r<a.length;r++)((o=a[r].getElementsByTagName("username")[0]).textContent||o.innerText).toUpperCase().indexOf(s)>-1?a[r].style.display="":a[r].style.display="none"},this.filterNewResultMembs=function(e,t){var s,i,a,o,r;if(s=t.value.toUpperCase(),(i=n("#vy_ms__groupchat_new_members__id")).length)for(a=i[0].getElementsByTagName("li"),r=0;r<a.length;r++)((o=a[r].getElementsByTagName("username")[0]).textContent||o.innerText).toUpperCase().indexOf(s)>-1?a[r].style.display="":a[r].style.display="none"},this.group_members_e=function(e,t,s,a,o){evstop(t,1),e=n(e);if(n("#vy_ms_newadmin").is(":checked"))return i.GroupAddNewAdmin(e,s,a);e.parent().find(".__remove").each(function(){n(this).removeClass("__remove")}),e.hasClass("__remove")?(e.removeClass("__remove"),e.find("a").on(i.crossEvent(),function(){let e=n(this);setTimeout(function(){e.find("span").addClass("__none")},200)})):(e.addClass("__remove"),e.find("a").on(i.crossEvent(),function(){let e=n(this);setTimeout(function(){e.find("span").removeClass("__none")},200)}))},this.manageGroupMembersTabs=function(e,t){let s=n(".js__vy_ms__group_subscribed_members"),i=n(".js__vy_ms__group_invitenew_members"),a="vy_ms__group_members_active_tab";n("."+a).removeClass(a),t.addClass(a),"1"==e?(i.hide(),s.show()):(s.hide(),i.show())},this.group_admin_show_subscribed_membs=function(e,t){evstop(e,1);let s=n(e.target);i.manageGroupMembersTabs("1",s)},this.group_admin_invite_new_membs=function(e,t){evstop(e,1);var s=n(e.target);i.manageGroupMembersTabs("2",s);let a=n(".js__vy_ms__globalpopup_content_invitenew");jAjax(i.ajax_url,"post",{cmd:"get-my-contacts",group:escape(t),filter:"filter-groups"}).done(function(e){let s=validateJson(e),n="";if("done"==s.msg){for(var o=0;o<s.users.length;o++){let e=s.users[o];n+=i.group_member_markup(e,t,"add")}a.html('<ul id="vy_ms__groupchat_new_members__id">'+n+"</ul>")}else a.html('<div class="vy_ms__nogroupmembers">'+s.msg+"</div>")})},this.ManageGroupMembers=async function(e,t){evstop(e,1),await i.globalPopup("manage-group-members",{group:t,action:"manage-group-members"}).then(function(e){jAjax(i.ajax_url,"post",{cmd:"get-group-members",group:escape(t)}).done(function(s){let n=validateJson(s),a="";if("done"==n.msg){for(var o=0;o<n.users.length;o++){let e=n.users[o];a+=i.group_member_markup(e,t)}e.html('<ul id="vy_ms__groupchat_all_members__id">'+a+"</ul>")}else e.html('<div class="vy_ms__nogroupmembers">'+n.msg+"</div>")})})},this.close_global_popup=function(){i.body.find(i.global_popup).find(".js__vy_ms__gloalpopup_f54").removeClass("show").on(i.crossEvent(),function(){i.body.find(i.global_popup).remove()}),n(window).off("scroll.globalpopup_loadmore")},this.globalPopup=async function(e,t){i.body=n("body"),i.close_global_popup();let s=i.global_popup,a={cmd:"global-popup"};if(a.type=e,"object"==typeof t&&Object.keys(t).length)for(var o in t)a[o]=t[o];await jAjax(i.ajax_url,"post",a).done(function(e){i.body.find(s).length||(i.body.prepend(e),setTimeout(function(){i.body.find(".js__vy_ms__gloalpopup_f54").addClass("show")},100),i.body.find(".js__vy_ms__globalpopup_close").off("click.closeGlobalPopup").on("click.closeGlobalPopup",function(e){evstop(e,1),i.close_global_popup()}))});return i.body.find(".js__vy_ms__globalpopup_content")},this.shareContentUserMarkup=function(){return'<a userfullname="%name" href="/messenger/%url" onclick="evstop(event,1);messenger.close_global_popup();messenger.prependContact(this,event,\'%avatar\',\'%name\',\'%id\',\'\',0,\'\',0,0,\'%page_id\',\'%group_id\');" id="gbpopup_contact-%element_id" class="vy_mess-pcontact %isgroup">\t\t\t<div class="vy_mess-pcontact_avatar"><img src="%avatar" /><div id="f_onl_gtm" class="only_ic global_user_online global_user_online_%id">%online</div></div>\t\t\t<div class="vy_mess-pcontact_details">\t\t\t<div class="vy_mess-pcontact_name">%name</div>\t\t\t</div>\t\t\t</a>'},this.composeNewMessage=async function(e){evstop(e,1);let t=i.shareContentUserMarkup();await i.globalPopup("compose-new-message").then(function(e){jAjax(i.ajax_url,"post",{cmd:"get-allmy-contacts",limit:40}).done(function(s){let n=validateJson(s),i="";if("done"==n.msg){for(var a=0;a<n.users.length;a++){let e=n.users[a];i+=t.replace(/%group_id/g,e.group_id).replace(/%page_id/g,e.page_id).replace(/%isgroup/g,e.group_id>0?"vy_ms_contactisgroup contact_groupid_"+e.group_id:"").replace(/%element_id/g,e.group_id>0?"GG"+e.group_id:e.page_id>0?e.user_id+"_"+e.page_id:e.user_id).replace(/%url/g,e.page_id>0?e.user_id+"/"+e.page_id:e.group_id>0?"g/"+e.group_id:e.user_id).replace(/%avatar/g,e.avatar).replace(/%name/g,e.fullname).replace(/%id/g,e.user_id).replace(/%online/g,e.online_status?'<i class="ic-online"></i>':"")}e.html('<div id="vy_ms__allmycontacts">'+i+"</div>")}else e.html('<div class="vy_ms__nogroupmembers">'+n.msg+"</div>")})})},this.shareContentSearchContact=function(e,t){evstop(e,1),t=n(t);let s=i.shareContentUserMarkup(),a="#vy_ms__allmycontacts_searchres",o=n("#vy_ms__allmycontacts"),r=$.trim(t.val());if(r&&r.length>=2){o.hide();let e=n(a);e.length||(o.before('<div id="vy_ms__allmycontacts_searchres"><div class="div-loader"></div></div>'),e=o.parent().find(a)),jAjax(i.ajax_url,"post",{cmd:"search-in-all-contacts",key:escape(r)}).done(function(t){let n=validateJson(t),i="";if("done"==n.msg){for(var a=0;a<n.users.length;a++){let e=n.users[a];i+=s.replace(/%group_id/g,e.group_id).replace(/%page_id/g,e.page_id).replace(/%isgroup/g,e.group_id>0?"vy_ms_contactisgroup contact_groupid_"+e.group_id:"").replace(/%element_id/g,e.group_id>0?"GG"+e.group_id:e.page_id>0?e.user_id+"_"+e.page_id:e.user_id).replace(/%url/g,e.page_id>0?e.user_id+"/"+e.page_id:e.group_id>0?"g/"+e.group_id:e.user_id).replace(/%avatar/g,e.avatar).replace(/%name/g,e.fullname).replace(/%id/g,e.user_id).replace(/%online/g,e.online_status?'<i class="ic-online"></i>':"")}e.html(i)}else e.html('<div class="vy_ms__nogroupmembers">'+n.msg+"</div>")})}else n(a).remove(),o.show()},this.accept_group_invitation=function(e,t,s){evstop(t,1),e=n(e),jAjax(i.ajax_post,"post",{cmd:"accept-group-invitation",id:escape(_U.i),group:escape(s)}).done(function(t){t=validateJson(t);let n=tonum(e.closest(".pmessenger-message-txt").attr("id")),a=tonum(e.closest(".pmessenger-message-txt").attr("data-unsettled-msg-id"));if("1"==t.success)i._join_group(s),e.parent().html('<div class="vy-ms-group_success_joined">'+lang.Messenger_you_have_successed_joined+"</div>"),i.deleteMessageById(a,n);else{if("0"!=t.success||"you_already_declined_this_invitation"!=t.msg)return displayErr(lang.Messenger_error_accepting_group_invitation);i.deleteMessageById(a,n)}})},this.decline_group_invitation=function(e,t,s){evstop(t,1),e=n(e),jAjax(i.ajax_post,"post",{cmd:"ignore-group-invitation",id:escape(_U.i),group:escape(s)}).done(function(t){if("1"!=(t=validateJson(t)).success)return displayErr(lang.Messenger_error_deleting_group_invitation);{let t=tonum(e.closest(".pmessenger-message-txt").attr("id")),n=tonum(e.closest(".pmessenger-message-txt").attr("data-unsettled-msg-id"));i._exit_group(s,1),e.parent().html('<div class="vy-ms-group_success_joined">'+lang.Messenger_you_have_successed_ignored_this_group+"</div>"),setTimeout(function(){i.deleteMessageById(n,t)},2500)}})},this.deleteMessageById=function(e,t,s,a){s=s||0,a=a||0,jAjax(i.ajax_post,"post",{cmd:"delete",action:"everyone",msg_unsettled_id:escape(e),direct:1,id:escape(t)}).done(function(e){if("1"!=e)return displayErr(lang.somethingWrong);{n("#msg_"+t).slideUp(function(){n(this).remove()});let e={msg_id:t,group_id:s,page_id:a};i.deleteMessageFromCacheConversation(e)}})},this._exit_group=function(e,t){t=t||!1,i.socket.emit("vy_ms__group_remove_member",JSON.stringify({Group_id:socketId("GG"+e),Room_id:socketId(generateRoomId(0,_U.i,0,e)),Group_clean_id:"GG"+e,Userid:socketId(_U.i),Userid_clean:_U.i,shortcut_id:!1,own_exit:t,next_conversation:i.hasTouchStartEvent?"no":"yes"}))},this._join_group=function(e){i.socket.emit("vy_ms__joingroup",JSON.stringify({Room_id:socketId(generateRoomId(0,_U.i,0,e)),Group_id_clean:e,Userid_clean:_U.i,Userid:socketId(_U.i)}))},this.groupChatCreate_FindParticipants=function(e,t){evstop(e,1),t=n(t);let s=n("#vy-ms__newgchat_participatns_ids"),a=t.val(),o=n("#vy-ms__sel_participants_tags"),r="",c=n("#vy_ms__chat_group_users");if(!$.trim(a))return c.parent().find("#vy_ms__ff5a93io3").remove();jAjax(i.ajax_post,"post",{cmd:"group-chat-search-participants",filter:JSON.stringify(i.newgchat_sel_users),key:escape(a)}).done(function(e){if((e=validateJson(e)).length){for(var t=0;t<e.length;t++){let s=e[t];r+='<div data-ud=\'{"id":"'+s.id+'","fullname":"'+s.fullname+'"}\' class="vy_ms_participants_groupchat"><div class="vy_ms_particip_groupchat_left"><img src="'+s.avatar+'" /></div>\t\t\t\t\t\t\t\t\t\t\t<div class="vy_ms_particip_groupchat_right">\t\t\t\t\t\t\t\t\t\t\t<div class="vy_ms_particip_groupchat_uname">'+s.fullname+'</div>\t\t\t\t\t\t\t\t\t\t\t<div class="vy_ms_particip_groupchat_ulastseen">'+s.last_seen+"</div>\t\t\t\t\t\t\t\t\t\t\t</div></div>"}c.parent().find("#vy_ms__ff5a93io3").length?c.parent().find("#vy_ms__ff5a93io3").html(r):c.after('<div id="vy_ms__ff5a93io3" class="vy_ms__groupchat_participatns_container_dropdown"></div>').parent().find("#vy_ms__ff5a93io3").html(r),c.parent().find("#vy_ms__ff5a93io3 .vy_ms_participants_groupchat").each(function(){n(this).on("click",function(e){const t=n(this).data("ud");i.newgchat_sel_users.indexOf(t.id)>-1||(o.append('<span class="vy_ms__newgchat_sel_users" vy-ms-userid="'+t.id+'" id="vy_ms__newgchat_uid_'+t.id+'">'+t.fullname+'&nbsp;<i class="d_comment_act d_comment_act_del d_comment_act_spam ic10 ic10_close-g"></i></span>').find("#vy_ms__newgchat_uid_"+t.id).on("click",function(e){const t=i.newgchat_sel_users.indexOf(n(this).attr("vy-ms-userid"));i.newgchat_sel_users.splice(t,1),n(this).remove()}),n(this).remove(),i.newgchat_sel_users.push(t.id),s.val(i.newgchat_sel_users.join(",")))})})}else c.parent().find("#vy_ms__ff5a93io3").remove()})},this.editGroupChat=function(e,t,s){jAjax(i.ajax_post,"post",{cmd:"get-group-details",group:escape(s)}).done(function(e){"1"==(e=validateJson(e)).admin?i.editGroupData(e,s):$.alert("Not authorized.")})},this._init=function(){n(window).off("popstate.vy_messenger").on("popstate.vy_messenger",function(e){i.noNewUrl=!0;const t=n('[href="'+window.location.pathname+'"]');if(i.hasTouchStartEvent)return messenger.show_contacts();t.length?t.trigger("click"):window.location=_url}),n("body").find(".seen_stories_users_ids").length||(n("html").addClass("vy_ms__isstandalone"),n("._fwowondxv2").hide(),n(".js__vy_ms_topavatar_standalone_logout").show()),i.hasTouchStartEvent&&setInterval(function(){window.oncontextmenu=function(e){return evstop(e,1),!1}},5e3),i.lazyLoad()},this.lazyLoad=function(){i.pmessenger.find("#messages-tick .nano-content").off("scroll.X"+i.rand_id).on("scroll.X"+i.rand_id,function(e){n("img.vy_ms_img_lzyload").each(function(){let e=n(this),t=new Image,s=e.data("src");var i,a;i=e[0],(a=i.getBoundingClientRect()).top>=0&&a.left>=0&&a.top<=(window.innerHeight||document.documentElement.clientHeight)&&!e.hasClass("vy_ms_img_lzyload2")&&(t.onload=function(){e.attr("src",e.data("src")).addClass("vy_ms_img_lzyload2")},t.src=s)})}),i.timeouts.lazyload_interval=setTimeout(i.lazyLoad,4e3)},this.standAloneSwitchAccountDropDown=function(e,t){e=n(e);let s=n(".js__vy_ms_standalone_logout");s.hasClass("__none")?s.removeClass("__none"):s.addClass("__none")},this.editGroupData=function(e,t){$.confirm({title:lang.Messenger_create_group_chat_popup_title,content:'<form action="" enctype="multipart/form-data" id="vy-ms-create-new-groupchat" class="vy-ms-create-new-groupchat"><input type="hidden" name="type" value="edit" /><input type="hidden" name="group" value="'+t+'" /><input type="hidden" name="cmd" value="edit-group-chat" /><div class="vy_ms__groupchat_create___form-group"><label>'+lang.Messenger_group_chat_name+'</label><input type="text" value="'+e.group_name+'" name="group_name" placeholder="e.g. My colleagues" class="vy-ms-gname vy_ms__groupchat_create___form-control" required /></div><div class="vy_ms__groupchat_create___form-group"><label>'+lang.Messenger_group_chat_avatar+'</label><div ontouchend="__j(\'#vy-ms-create-group-chat-trigger-avatar-upload\').trigger(\'click\');" onclick="__j(\'#vy-ms-create-group-chat-trigger-avatar-upload\').trigger(\'click\');" class="vy_ms_fcov_img_holder_groupchat"><img id="vy_ms_fcov_img_holder_groupchat" src="'+e.group_avatar+'"></div><input type="file" id="vy-ms-create-group-chat-trigger-avatar-upload" style="display:none;" onchange="__j(\'#vy_ms_fcov_img_holder_groupchat\').attr(\'src\',window.URL.createObjectURL(this.files[0]));" class="name form-control" name="avatar" accept="image/jpeg,image/png,image/gif" /></div></form>',buttons:{formSubmit:{text:"Update",btnClass:"btn-blue",action:function(){var e=this.$content.find(".vy-ms-gname").val();return $.trim(e)?e.length<4||e.length>15?($.alert("Group name must be at least 4 chars and not exceed 15 chars."),!1):(ajaxLoading(),void $.ajax({url:i.ajax_post,type:"post",data:new FormData(n("#vy-ms-create-new-groupchat")[0]),processData:!1,contentType:!1,success:function(e){if(removeAjaxLoad(),"1"!=(e=validateJson(e)).success)return $.alert(e.msg),!1;$.alert("Success! Group updated, please wait..."),ajaxLoading(),setTimeout(function(){window.location="/messenger/g/"+e.group_id},500)}})):($.alert(lang.Messenger_missin_group_name_edit),!1)}},cancel:function(){i.newgchat_sel_users=new Array}},onContentReady:function(){var e=this;this.$content.find("form").on("submit",function(t){t.preventDefault(),e.$$formSubmit.trigger("click")})}})},this.createGroupChat=function(){$.confirm({title:lang.Messenger_create_group_chat_popup_title,content:'<form action="" enctype="multipart/form-data" id="vy-ms-create-new-groupchat" class="vy-ms-create-new-groupchat"><input type="hidden" name="type" value="create" /><input type="hidden" name="cmd" value="create-group-chat" /><div class="vy_ms__groupchat_create___form-group"><label>'+lang.Messenger_group_chat_name+'</label><input type="text" name="group_name" placeholder="e.g. My colleagues" class="vy-ms-gname vy_ms__groupchat_create___form-control" required /></div><div class="vy_ms__groupchat_create___form-group"><label>'+lang.Messenger_group_chat_members+'</label><div id="vy-ms__sel_participants_tags"></div><input type="hidden" class="vy-ms-gparts" id="vy-ms__newgchat_participatns_ids" name="parts" /><input type="text" onkeydown="clearTimeout(this.timeout_findparticipants);" onkeypress="clearTimeout(this.timeout_findparticipants);" onkeyup="var that = this;clearTimeout(that.timeout_findparticipants); this.timeout_findparticipants = setTimeout(function(){ messenger.groupChatCreate_FindParticipants(event,that); },200);" id="vy_ms__chat_group_users" placeholder="'+lang.Messenger_group_chat_members_placeholder+'" class="vy_ms__groupchat_create___form-control" /></div><div class="vy_ms__groupchat_create___form-group"><label>'+lang.Messenger_group_chat_avatar+'</label><div ontouchend="__j(\'#vy-ms-create-group-chat-trigger-avatar-upload\').trigger(\'click\');" onclick="__j(\'#vy-ms-create-group-chat-trigger-avatar-upload\').trigger(\'click\');" class="vy_ms_fcov_img_holder_groupchat"><img id="vy_ms_fcov_img_holder_groupchat" src="data:image/png;base64,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"></div><input type="file" id="vy-ms-create-group-chat-trigger-avatar-upload" style="display:none;" onchange="__j(\'#vy_ms_fcov_img_holder_groupchat\').attr(\'src\',window.URL.createObjectURL(this.files[0]));" class="name form-control" name="avatar" accept="image/jpeg,image/png,image/gif" /></div></form>',theme:i.theme(),buttons:{formSubmit:{text:"Create",btnClass:"btn-blue",action:function(){var e=this.$content.find(".vy-ms-gname").val(),t=this.$content.find(".vy-ms-gparts").val();return $.trim(e)?e.length<4||e.length>15?($.alert("Group name must be at least 4 chars and not exceed 15 chars."),!1):$.trim(t)?(ajaxLoading(),void $.ajax({url:i.ajax_post,type:"post",data:new FormData(n("#vy-ms-create-new-groupchat")[0]),processData:!1,contentType:!1,success:function(e){if(removeAjaxLoad(),"1"!=(e=validateJson(e)).success)return $.alert(e.msg),!1;{let t=window.event||$.Event();jAjax(i.ajax_url,"post",{cmd:"get-group-details",group:escape(e.group_id)}).done(function(s){for(var n=0;n<i.newgchat_sel_users.length;n++)setTimeout(function(){i.socket.emit("vy_ms__groupinvitation_sent",JSON.stringify({User:_U,Group_data:validateJson(s),Group_id:socketId("GG"+e.group_id),User_id:socketId(i.newgchat_sel_users[n]),Group_clean_id:e.group_id,User_clean_id:i.newgchat_sel_users[n]}))},2e3),i.send(!1,t,"[group-invitation]"+_U.i+"|"+e.group_id+"[/group-invitation]",i.newgchat_sel_users[n],0,0,1,1);setTimeout(function(){window.location="/messenger/g/"+e.group_id},500),$.alert("Success! Group created, please wait..."),i.newgchat_sel_users=new Array}),ajaxLoading()}}})):($.alert("Please add some participants to this group."),!1):($.alert(lang.Messenger_missin_group_name_edit),!1)}},cancel:function(){i.newgchat_sel_users=new Array}},onContentReady:function(){var e=this;this.$content.find("form").on("submit",function(t){t.preventDefault(),e.$$formSubmit.trigger("click")})}})},this.toFullScreen=function(e,t){const s=function(){for(const e of["exitFullscreen","webkitExitFullscreen","webkitCancelFullScreen","mozCancelFullScreen","msExitFullscreen"])if(e in document)return!0;return!1}();let a=document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement;if(n(document).off("fullscreenchange.exitFromMessenger").on("fullscreenchange.exitFromMessenger",function(e){document.webkitIsFullScreen||document.mozFullScreen||document.msFullscreenElement||n("html").removeClass("messenger-fullscreen"),nanoScrollStart()}),a)document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen();else{let e=n("body").get(0);e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT):e.msRequestFullscreen&&e.msRequestFullscreen(),s?(n("html").addClass("messenger-fullscreen"),nanoScrollStart()):(i.pmessenger.addClass("vy_ms__fullscreen_notsupported"),modernPopup(function(){},1,'<div class="vy_ms__moderpopup_err">'+lang.Messenger_fullscreen_not_supporting+"</div>"))}}}$.fn.hasScrollBar=function(){return this.get(0).scrollHeight>this.height()};class EventHandlerClass{constructor(){this.functionMap={}}addEventListener(e,t){this.functionMap[e]=t,document.addEventListener(e.split(".")[0],this.functionMap[e])}removeEventListener(e){document.removeEventListener(e.split(".")[0],this.functionMap[e]),delete this.functionMap[e]}}!function(){var e,t=window.navigator.msPointerEnabled,s={start:t?"MSPointerDown":"touchstart",move:t?"MSPointerMove":"touchmove",end:t?"MSPointerUp":"touchend"},n=(e=window.getComputedStyle(document.documentElement,""),"-"+(Array.prototype.slice.call(e).join("").match(/-(moz|webkit|ms)-/)||""===e.OLink&&["","o"])[1]+"-"),i=function(){var e,t=document.createElement("fakeelement"),s={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(e in s)if(void 0!==t.style[e])return s[e]}(),a=n+"transform";function o(e,t){document.addEventListener(e,function(e){_._elems.forEach(function(s){for(var n=e.target;n;){if(n===s.elem)return s[t](e),!1;n=n.parentNode}return!1})},{passive:!1})}function r(){var e=[].shift.call(arguments),t=arguments[0];for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s]);return e}var c=function(){},_=function(e){e=r({duration:200,tolerance:50,time:200,dir:1,right:0,left:0},e||{}),this.duration=e.duration,this.tolerance=e.tolerance,this.time=e.time,this.width=e.left||e.right,this.elem=e.elem,this.list=e.list,this.dir=e.dir,this.group=e.group,this.id=_.elemId++,this.onPrompt="function"==typeof e.onOpen?e.onPrompt:c,this.onOpen="function"==typeof e.onOpen?e.onOpen:c,this.onClose="function"==typeof e.onClose?e.onClose:c,this.onCreated="function"==typeof e.onCreated?e.onCreated:c,this.right=e.right,this.left=e.left,(e.right>0&&e.tolerance>e.right||e.left>0&&e.tolerance>e.left)&&console.warn("tolerance must be less then left and right")};_._elems=[],_.groupCounter=0,_.elemId=0,_.init=function(e){_.groupCounter++;var t=document.querySelectorAll(e.query),s=[];return delete e.query,[].forEach.call(t,function(t){if(!__j(t).hasClass("_touchevent_binded")){var n=r({elem:t,group:_.groupCounter},e);s.push(new _(n)),__j(t).addClass("_touchevent_binded")}}),_._bindEvents(),_._elems=_._elems.concat(s),1===s.length?s[0]:("function"==typeof this.onCreated&&this.onCreated(),s)},_._closeAll=function(e){_._elems.forEach(function(t){t.group===e&&t.close(!0)})},_.prototype.transitionEnd=function(e,t){var s=this;e.addEventListener(i,function n(){t.call(s),e.removeEventListener(i,n)})},_.prototype.touchStart=function(e){var t=e.changedTouches[0];1===e.touches.length&&(this.touchId=t.identifier,this.x=t.pageX,this.y=t.pageY,this.startTime=new Date,this.resetValue(),this.list?_._closeAll(this.group):this.close(!0))},_.prototype.touchMove=function(e){var t=e.changedTouches[0];this.isValidTouch(e)&&(this.delta=t.pageX-this.x,this.dir=this.delta<0?-1:1,this.width=this.delta<0?this.right:this.left,this.defineUserAction(t),this.startSwipe&&(e.preventDefault(),e.stopPropagation(),this.move(e)))},_.prototype.touchEnd=function(e){if(this.isValidTouch(e,!0)&&this.startSwipe)return Math.abs(this.delta)-10>__j(".js_mob_delete_conv_btn").outerWidth()?this.onPrompt(e,this,this.elem):this.close()},_.prototype.open=function(e){this.animation(this.dir*this.width),this.swiped=!0,e||this.transitionEnd(this.elem,this.onOpen),this.resetValue()},_.prototype.close=function(e){this.animation(0),this.swiped=!1,e||this.transitionEnd(this.elem,this.onClose),this.resetValue()},_.prototype.toggle=function(){this.swiped?this.close():this.open()},_.prototype.resetValue=function(){this.startSwipe=!1,this.startScroll=!1,this.delta=0},_._bindEvents=function(){if(_.eventBinded)return!1;new EventHandlerClass;o(s.move,"touchMove"),o(s.end,"touchEnd"),o(s.start,"touchStart"),_.eventBinded=!0},_.prototype.defineUserAction=function(e){Math.abs(this.y-e.pageY)>10&&!this.startSwipe?this.startScroll=!0:Math.abs(this.delta)>10&&!this.startScroll&&(this.startSwipe=!0)},_.prototype.isValidTouch=function(e,t){return e[t?"changedTouches":"targetTouches"][0].identifier===this.touchId},_.prototype.move=function(e){if(this.dir>0&&(this.delta<0||0===this.left)||this.dir<0&&(this.delta>0||0===this.right))return!1;var t=Math.abs(this.delta);t>this.width&&(this.delta=this.dir*(this.width+(t-this.width)/8)),this.animation(this.delta,0)},_.prototype.animation=function(e,t){t=void 0===t?this.duration:t,__j(this.elem).css({transition:a+" "+t+"ms",transform:"translate3d("+e+"px, 0px, 0px)"})},_.prototype.destroy=function(e){var t=this.id;_._elems.forEach(function(e,s){e.id===t&&_._elems.splice(s,1)}),e&&this.elem.parentNode.removeChild(this.elem)},window.Swiped=_}(),function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).Recorder=e()}}(function(){return function e(t,s,n){function i(o,r){if(!s[o]){if(!t[o]){var c="function"==typeof require&&require;if(!r&&c)return c(o,!0);if(a)return a(o,!0);var _=new Error("Cannot find module '"+o+"'");throw _.code="MODULE_NOT_FOUND",_}var l=s[o]={exports:{}};t[o][0].call(l.exports,function(e){var s=t[o][1][e];return i(s||e)},l,l.exports,e,t,s,n)}return s[o].exports}for(var a="function"==typeof require&&require,o=0;o<n.length;o++)i(n[o]);return i}({1:[function(e,t,s){"use strict";t.exports=e("./recorder").Recorder},{"./recorder":2}],2:[function(e,t,s){"use strict";var n=function(){function e(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,s,n){return s&&e(t.prototype,s),n&&e(t,n),t}}();Object.defineProperty(s,"__esModule",{value:!0}),s.Recorder=void 0;var i,a=e("inline-worker"),o=(i=a)&&i.__esModule?i:{default:i};var r=s.Recorder=function(){function e(t,s){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.config={bufferLen:4096,numChannels:2,mimeType:"audio/wav"},this.recording=!1,this.callbacks={getBuffer:[],exportWAV:[]},Object.assign(this.config,s),this.context=t.context,this.node=(this.context.createScriptProcessor||this.context.createJavaScriptNode).call(this.context,this.config.bufferLen,this.config.numChannels,this.config.numChannels),this.node.onaudioprocess=function(e){if(n.recording){for(var t=[],s=0;s<n.config.numChannels;s++)t.push(e.inputBuffer.getChannelData(s));n.worker.postMessage({command:"record",buffer:t})}},t.connect(this.node),this.node.connect(this.context.destination);var i={};this.worker=new o.default(function(){var e=0,t=[],s=void 0,n=void 0;function a(){for(var e=0;e<n;e++)t[e]=[]}function o(e,t){for(var s=new Float32Array(t),n=0,i=0;i<e.length;i++)s.set(e[i],n),n+=e[i].length;return s}function r(e,t,s){for(var n=0;n<s.length;n++)e.setUint8(t+n,s.charCodeAt(n))}i.onmessage=function(c){switch(c.data.command){case"init":_=c.data.config,s=_.sampleRate,n=_.numChannels,a();break;case"record":!function(s){for(var i=0;i<n;i++)t[i].push(s[i]);e+=s[0].length}(c.data.buffer);break;case"exportWAV":!function(a){for(var c=[],_=0;_<n;_++)c.push(o(t[_],e));var l=void 0;l=2===n?function(e,t){var s=e.length+t.length,n=new Float32Array(s),i=0,a=0;for(;i<s;)n[i++]=e[a],n[i++]=t[a],a++;return n}(c[0],c[1]):c[0];var d=(u=l,g=new ArrayBuffer(44+2*u.length),p=new DataView(g),r(p,0,"RIFF"),p.setUint32(4,36+2*u.length,!0),r(p,8,"WAVE"),r(p,12,"fmt "),p.setUint32(16,16,!0),p.setUint16(20,1,!0),p.setUint16(22,n,!0),p.setUint32(24,s,!0),p.setUint32(28,4*s,!0),p.setUint16(32,2*n,!0),p.setUint16(34,16,!0),r(p,36,"data"),p.setUint32(40,2*u.length,!0),function(e,t,s){for(var n=0;n<s.length;n++,t+=2){var i=Math.max(-1,Math.min(1,s[n]));e.setInt16(t,i<0?32768*i:32767*i,!0)}}(p,44,u),p),m=new Blob([d],{type:a});var u,g,p;i.postMessage({command:"exportWAV",data:m})}(c.data.type);break;case"getBuffer":!function(){for(var s=[],a=0;a<n;a++)s.push(o(t[a],e));i.postMessage({command:"getBuffer",data:s})}();break;case"clear":e=0,t=[],a()}var _}},i),this.worker.postMessage({command:"init",config:{sampleRate:this.context.sampleRate,numChannels:this.config.numChannels}}),this.worker.onmessage=function(e){var t=n.callbacks[e.data.command].pop();"function"==typeof t&&t(e.data.data)}}return n(e,[{key:"record",value:function(){this.recording=!0}},{key:"stop",value:function(){this.recording=!1}},{key:"clear",value:function(){this.worker.postMessage({command:"clear"})}},{key:"getBuffer",value:function(e){if(!(e=e||this.config.callback))throw new Error("Callback not set");this.callbacks.getBuffer.push(e),this.worker.postMessage({command:"getBuffer"})}},{key:"exportWAV",value:function(e,t){if(t=t||this.config.mimeType,!(e=e||this.config.callback))throw new Error("Callback not set");this.callbacks.exportWAV.push(e),this.worker.postMessage({command:"exportWAV",type:t})}}],[{key:"forceDownload",value:function(e,t){var s=(window.URL||window.webkitURL).createObjectURL(e),n=window.document.createElement("a");n.href=s,n.download=t||"output.wav";var i=document.createEvent("Event");i.initEvent("click",!0,!0),n.dispatchEvent(i)}}]),e}();s.default=r},{"inline-worker":3}],3:[function(e,t,s){"use strict";t.exports=e("./inline-worker")},{"./inline-worker":4}],4:[function(e,t,s){(function(e){"use strict";var s=function(){function e(e,t){for(var s in t){var n=t[s];n.configurable=!0,n.value&&(n.writable=!0)}Object.defineProperties(e,t)}return function(t,s,n){return s&&e(t.prototype,s),n&&e(t,n),t}}(),n=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},i=!!(e===e.window&&e.URL&&e.Blob&&e.Worker),a=function(){function t(s,a){var o=this;if(n(this,t),i){var r=s.toString().trim().match(/^function\s*\w*\s*\([\w\s,]*\)\s*{([\w\W]*?)}$/)[1],c=e.URL.createObjectURL(new e.Blob([r],{type:"text/javascript"}));return new e.Worker(c)}this.self=a,this.self.postMessage=function(e){setTimeout(function(){o.onmessage({data:e})},0)},setTimeout(function(){s.call(a)},0)}return s(t,{postMessage:{value:function(e){var t=this;setTimeout(function(){t.self.onmessage({data:e})},0)}}}),t}();t.exports=a}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[1])(1)}),function(e){e.extend(e.fn,{debounce:function(e,t,s){this.bind(e,function(e,t){var s,n,i=this;return function(){return n=Array.prototype.slice.call(arguments,0),s=clearTimeout(s,n),s=setTimeout(function(){e.apply(i,n),s=0},t),this}}.apply(this,[t,s]))}})}(jQuery);